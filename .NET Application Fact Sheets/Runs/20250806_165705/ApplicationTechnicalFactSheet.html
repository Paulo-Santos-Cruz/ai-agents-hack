<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Application Technical Profile</title>
      <!-- Google Fonts: Roboto and Material Symbols -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
      <!-- Mermaid.js for diagram rendering -->
      <script src="https://cdn.jsdelivr.net/npm/mermaid@11.8.1/dist/mermaid.min.js"></script>
      <script>
         // Simple immediate check for Mermaid availability
         window.addEventListener('load', function() {
            if (typeof mermaid === 'undefined') {
               console.error('Mermaid library failed to load');
            } else {
               console.log('Mermaid library loaded successfully', mermaid.version || 'version unknown');
            }
         });
      </script>
      
      <!-- Critical stylesheet for Material Icons -->
      <style id="material-icons-critical">
         /* Ensure proper icon rendering and prevent emoji conversion */
         .material-symbols-outlined,
         .icon,
         [class*="icon"] {
            font-family: 'Material Symbols Outlined', sans-serif !important;
            font-weight: normal !important;
            font-style: normal !important;
            line-height: 1 !important;
            text-transform: none !important;
            letter-spacing: normal !important;
            word-wrap: normal !important;
            white-space: nowrap !important;
            direction: ltr !important;
            font-feature-settings: 'liga' !important;
            -webkit-font-feature-settings: 'liga' !important;
            -webkit-font-smoothing: antialiased !important;
            font-variant-emoji: text !important;
            text-rendering: optimizeLegibility !important;
            font-size: 20px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
         }
         
         /* Specifically target table content icons that might get corrupted during pagination */
         tbody .material-symbols-outlined,
         tbody .icon,
         tbody td .material-symbols-outlined,
         tbody td .icon {
            font-family: 'Material Symbols Outlined', sans-serif !important;
            font-variant-emoji: text !important;
            text-rendering: optimizeLegibility !important;
         }
         
         /* Specifically target pagination icons */
         .pagination-button .material-symbols-outlined,
         .pagination-button .icon {
            font-family: 'Material Symbols Outlined', sans-serif !important;
            font-variant-emoji: text !important;
            font-size: 20px !important;
         }
      </style>
      
      <!-- Table styling and pagination styles -->
      <style>
         /* Common styles */
         * {
            box-sizing: border-box;
         }
         
         body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.5;
            color: #333;
            margin: 0;
            padding: 0;
         }
         
         /* Table container */
         .table-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 2rem;
         }
         
         /* Table pagination styles */
         .table-pagination {
            margin-top: 12px;
         }
         
         .pagination-top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
         }
         
         .page-size-selector {
            display: flex;
            align-items: center;
         }
         
         .page-size-label {
            margin-right: 8px;
            font-size: 14px;
            color: #555;
            padding-left: 4px;
         }
         
         .page-size-select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            min-width: 60px;
         }
         
         .pagination-info {
            font-size: 14px;
            color: #555;
            padding: 4px 0;
            padding-right: 4px;
            text-align: right;
         }
         
         .pagination-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 8px;
         }
         
         .pagination-nav-buttons,
         .pagination-next-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
         }
         
         .pagination-page-numbers {
            display: flex;
            align-items: center;
            margin: 0 10px;
         }
         
         /* Pagination buttons */
         .pagination-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
            padding: 4px 8px;
            margin: 0 3px;
            border: none;
            border-radius: 50%;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s ease;
            box-shadow: none;
            color: #5f6368;
            user-select: none;
            outline: none;
         }
         
         .pagination-button:hover:not(:disabled) {
            background-color: rgba(0, 0, 0, 0.04);
         }
         
         .pagination-button:disabled {
            opacity: 0.5;
            cursor: default;
            color: #bdc1c6;
            background: transparent;
         }
         
         .pagination-button.active {
            background-color: #0071ce;
            color: white;
            font-weight: 500;
         }
         
         .pagination-button.ellipsis {
            color: #5f6368;
            pointer-events: none;
         }
         
         /* Table grouping styles */
         .table-group-controls {
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            transition: background-color 0.2s ease, border-color 0.2s ease;
         }
         
         .group-title {
            margin-right: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            color: #333;
            transition: color 0.2s ease;
         }
         
         .group-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
         }
         
         .group-option {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
         }
         
         .group-option:hover:not(.active) {
            background-color: #f0f0f0;
         }
         
         .group-option.active {
            background-color: #0071ce;
            color: #fff;
            border: 1px solid #0071ce;
            font-weight: 500;
         }
         
         .group-header {
            background-color: #f5f7f9;
            transition: background-color 0.2s ease;
         }
         
         .group-header td {
            padding: 0 !important;
         }
         
         .group-header-content {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f5f7f9;
            border-radius: 4px;
            transition: background-color 0.2s ease;
         }
         
         .group-toggle {
            margin-right: 8px;
            color: #0071ce;
            transition: color 0.2s ease;
         }
         
         .group-header-title {
            font-weight: 500;
            color: #333;
            transition: color 0.2s ease;
         }
         
         .group-count {
            margin-left: 12px;
            font-size: 0.85em;
            color: #666;
            background-color: rgba(0, 113, 206, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            transition: all 0.2s ease;
         }
         
         .collapsed-row {
            display: none !important;
         }
         
         tr.first-in-group td {
            border-top: 1px solid #e0e0e0;
            transition: border-color 0.2s ease;
         }
         
         .group-header:hover {
            background-color: #eef1f5;
         }
         
         .group-tooltip {
            font-size: 0.75em;
            color: #666;
            margin-left: 8px;
            padding: 2px 6px;
            background: rgba(0, 113, 206, 0.08);
            border-radius: 4px;
            transition: all 0.2s ease;
         }

         /* Dark mode styles for table grouping */
         @media (prefers-color-scheme: dark) {
            body {
               background-color: #1a202c !important;
               color: #e2e8f0 !important;
            }
            
            .table-group-controls {
               background-color: #2d3748 !important;
               border: 1px solid #4a5568 !important;
               box-shadow: none !important;
            }
            
            .group-title {
               color: #cbd5e0 !important;
            }
            
            .group-option {
               background-color: #4a5568 !important;
               border: 1px solid #718096 !important;
               color: #e2e8f0 !important;
               box-shadow: none !important;
            }
            
            .group-option:hover:not(.active) {
               background-color: #718096 !important;
               border-color: #a0aec0 !important;
            }
            
            .group-option.active {
               background-color: #3182ce !important;
               color: #ffffff !important;
               border: 1px solid #3182ce !important;
               box-shadow: none !important;
            }
            
            .group-header {
               background-color: #2d3748 !important;
            }
            
            .group-header-content {
               background-color: #2d3748 !important;
            }
            
            .group-toggle {
               color: #4299e1 !important;
            }
            
            .group-header-title {
               color: #e2e8f0 !important;
            }
            
            .group-count {
               color: #cbd5e0 !important;
               background-color: rgba(66, 153, 225, 0.2) !important;
               border: none !important;
            }
            
            tr.first-in-group td {
               border-top: 1px solid #4a5568 !important;
            }
            
            .group-header:hover {
               background-color: #4a5568 !important;
            }
            
            .group-header:hover .group-header-content {
               background-color: #4a5568 !important;
            }
            
            .group-tooltip {
               color: #cbd5e0 !important;
               background: rgba(66, 153, 225, 0.15) !important;
               border: none !important;
            }
         }

         /* Force dark mode styles - Alternative approach */
         .dark-mode body,
         [data-theme="dark"] body {
            background-color: var(--background-main) !important;
            color: var(--text-primary) !important;
         }

         .dark-mode .footer-wordmark{
            color: var(--text-primary) !important;
         }

         .dark-mode .tab-link
         {
            color: var(--text-primary) !important;
            text-decoration: none !important;
            font-weight: 500 !important;
            transition: color 0.2s ease;
         }
         
         .dark-mode .table-group-controls,
         [data-theme="dark"] .table-group-controls {
            background-color: var(--background-main) !important;
            border: 1px solid var(--border-color) !important;
            box-shadow: none !important;
         }
         
         .dark-mode .group-title,
         [data-theme="dark"] .group-title {
            color: var(--text-primary) !important;
         }
         
         .dark-mode .group-option,
         [data-theme="dark"] .group-option {
            background-color: var(--border-color) !important;
            border: none !important;
            color: var(--text-primary) !important;
            box-shadow: none !important;
         }
         
         .dark-mode .group-option:hover:not(.active),
         [data-theme="dark"] .group-option:hover:not(.active) {
            background-color: var(--background-button) !important;
            border-color: none !important;
         }
         
         .dark-mode .group-option.active,
         [data-theme="dark"] .group-option.active {
            background-color: var(--product-accent) !important;
            color: var(--text-primary) !important;
            border: none !important;
            box-shadow: none !important;
         }

         .dark-mode .group-header-content{
            background-color: var(--background-main) !important;
         }

         .dark-mode .group-header-title
         {
            color: var(--text-primary) !important;
         }

         .dark-mode .group-tooltip{
            color: var(--text-primary) !important;
            background-color: var(--border-color) !important;
            border: none !important;
         }

         .dark-mode .group-count{
            background-color: rgba(0, 113, 206, 0.1) !important;
            border: none !important;
            color: rgb(0, 113, 206) !important;
         }

         .dark-mode .floating-toc-link:hover{
            background-color: var(--product-accent) !important;
         }


         .dark-mode .pagination-nav{
            background-color: var(--background-main) !important;          
            border: 1px solid var(--border-color) !important;
            box-shadow: none !important;
         }

         .dark-mode .pagination-button.page-number {
            color: var(--text-primary) !important;
         }

         .dark-mode .pagination-button.page-number.active {
            background-color: var(--product-accent) !important;
            color: var(--text-primary) !important;
            border: none !important;
            box-shadow: none !important;
         }

         .dark-mode .pagination-button.page-number:hover:not(.active) {
            background-color: var(--product-accent) !important;
            border-color: none !important;
            color: var(--text-primary) !important;
         }

         .dark-mode .pagination-button.next, .dark-mode .pagination-button.prev, .dark-mode .pagination-button.first, .dark-mode .pagination-button.last {
            background-color: var(--background-main) !important;
            border-color: none !important;
            color: var(--text-primary) !important;
         }

         /* Enhanced light mode styles for better contrast */
         @media (prefers-color-scheme: light) {
            .table-group-controls {
               background-color: #ffffff;
               border: 1px solid #e2e8f0;
               box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            .group-option {
               background-color: #f8f9fa;
               border: 1px solid #d1d5db;
               color: #374151;
               box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            }
            
            .group-option:hover:not(.active) {
               background-color: #e5e7eb;
               border-color: #9ca3af;
            }
            
            .group-option.active {
               background-color: #0071ce;
               color: #ffffff;
               border: 1px solid #0071ce;
               box-shadow: 0 2px 4px rgba(0, 113, 206, 0.2);
            }
            
            .group-count {
               background-color: rgba(0, 113, 206, 0.1);
               border: 1px solid rgba(0, 113, 206, 0.2);
            }
            
            .group-tooltip {
               background: rgba(0, 113, 206, 0.08);
               border: 1px solid rgba(0, 113, 206, 0.15);
            }
         }

         /* MERMAID DIAGRAM THEMING */
         .mermaid-container {
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
            text-align: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            
            /* Use CSS variables for consistent theming */
            background-color: var(--background-main);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
         }

         .mermaid-container svg {
            max-width: 100%;
            height: auto;
            background-color: transparent !important;
         }

         /* Global font styling for all Mermaid diagrams */
         .mermaid-container svg text,
         .mermaid-container svg tspan,
         .mermaid-container svg .nodeLabel,
         .mermaid-container svg .edgeLabel,
         .mermaid-container svg .label,
         .mermaid-container svg .titleText {
            font-family: 'Roboto', 'Segoe UI', Arial, sans-serif !important;
            font-size: 14px !important;
         }

         /* Ensure text visibility in dark mode Mermaid diagrams */
         .dark-mode .mermaid-container svg text,
         [data-theme="dark"] .mermaid-container svg text {
            fill: var(--text-primary) !important;
         }

         .dark-mode .mermaid-container svg .node rect,
         [data-theme="dark"] .mermaid-container svg .node rect {
            stroke: var(--border-color) !important;
         }

         .dark-mode .mermaid-container svg .edgePath path,
         [data-theme="dark"] .mermaid-container svg .edgePath path {
            stroke: var(--border-color) !important;
         }

         /* Light mode Mermaid container */
         @media (prefers-color-scheme: light) {
            .mermaid-container {
               box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
         }

         /* Dark mode Mermaid container */
         @media (prefers-color-scheme: dark) {
            .mermaid-container {
               box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            }
         }

         /* Force dark mode Mermaid styling */
         .dark-mode .mermaid-container,
         [data-theme="dark"] .mermaid-container {
            background-color: var(--background-main) !important;
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
         }

         /* Force light mode Mermaid styling */
         .light-mode .mermaid-container,
         [data-theme="light"] .mermaid-container {
            background-color: var(--background-main) !important;
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
         }

         /* GOOGLE-LIKE LOADING INDICATOR */
         .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(2px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
         }

         .loading-overlay.show {
            opacity: 1;
            visibility: visible;
         }

         .loading-dots {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
         }

         .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--background-button);
            margin: 0 3px;
            animation: pulse 1.5s ease-in-out infinite;
         }

         .loading-dot:nth-child(1) { animation-delay: 0s; }
         .loading-dot:nth-child(2) { animation-delay: 0.2s; }
         .loading-dot:nth-child(3) { animation-delay: 0.4s; }
         .loading-dot:nth-child(4) { animation-delay: 0.6s; }

         .loading-text {
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-align: center;
         }

         .loading-progress {
            width: 200px;
            height: 4px;
            background-color: #e8eaed;
            border-radius: 2px;
            overflow: hidden;
            position: relative;
         }

         .loading-progress-bar {
            height: 100%;
            background-color:var(--background-button);
            border-radius: 2px;
            position: absolute;
            left: -100%;
            animation: progress 2s ease-in-out infinite;
         }

         /* Dark mode loading overlay */
         .dark-mode .loading-overlay,
         [data-theme="dark"] .loading-overlay {
            background-color: var(--background-main);
         }

         .dark-mode .loading-dot,
         [data-theme="dark"] .loading-dot {
            background-color: var(--background-button);
         }

         .dark-mode .loading-text,
         [data-theme="dark"] .loading-text {
            color: var(--text-primary);
         }

         .dark-mode .loading-progress,
         [data-theme="dark"] .loading-progress {
            background-color: var(--background-main);
         }

         .dark-mode .loading-progress-bar,
         [data-theme="dark"] .loading-progress-bar {
            background-color: var(--background-button);
         }

         /* Animations */
         @keyframes pulse {
            0%, 20% { 
               transform: scale(1); 
               opacity: 1; 
            }
            50% { 
               transform: scale(1.3); 
               opacity: 0.7; 
            }
            80%, 100% { 
               transform: scale(1); 
               opacity: 1; 
            }
         }

         @keyframes progress {
            0% {
               left: -100%;
               width: 0%;
            }
            50% {
               left: 0%;
               width: 100%;
            }
            100% {
               left: 100%;
               width: 0%;
            }
         }

         /* Loading indicator for specific sections */
         .section-loading {
            position: relative;
         }

         .section-loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(1px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
         }

         .dark-mode .section-loading::after,
         [data-theme="dark"] .section-loading::after {
            background-color: rgba(26, 32, 44, 0.8);
         }
      </style>
     
      <!-- Table sorting and grouping functionality -->
      <script>
         // --- MERMAID DIAGRAM RENDERING ---
         
         // Loading indicator management
         let loadingTasks = new Set();
         
         function showLoading(message = 'Loading...', taskId = 'default') {
             const overlay = document.getElementById('loadingOverlay');
             const loadingText = document.getElementById('loadingText');
             
             if (overlay && loadingText) {
                 loadingTasks.add(taskId);
                 loadingText.textContent = message;
                 overlay.classList.add('show');
                 console.log(`Loading started: ${message} (task: ${taskId})`);
             }
         }
         
         function hideLoading(taskId = 'default') {
             loadingTasks.delete(taskId);
             console.log(`Loading task completed: ${taskId}, ${loadingTasks.size} tasks remaining`);
             
             // Only hide if no other tasks are running
             if (loadingTasks.size === 0) {
                 const overlay = document.getElementById('loadingOverlay');
                 if (overlay) {
                     // Add a small delay to prevent flicker for quick operations
                     setTimeout(() => {
                         // Double-check that no new tasks were added during the delay
                         if (loadingTasks.size === 0) {
                             overlay.classList.remove('show');
                             console.log(`All loading tasks completed - hiding overlay`);
                         }
                     }, 100); // Reduced delay from 300ms to 100ms
                 }
             }
         }
         
         function updateLoadingMessage(message, taskId = 'default') {
             if (loadingTasks.has(taskId)) {
                 const loadingText = document.getElementById('loadingText');
                 if (loadingText) {
                     loadingText.textContent = message;
                 }
             }
         }

         function initializeMermaidRendering() {
             showLoading('Initializing diagram renderer...', 'mermaid-init');
             
             try {
                 // Detect current theme
                 const isDarkMode = document.documentElement.classList.contains('dark-mode') || 
                                   document.documentElement.getAttribute('data-theme') === 'dark' ||
                                   window.matchMedia('(prefers-color-scheme: dark)').matches;
                 
                 // Get theme-specific configuration
                 const themeConfig = getMermaidThemeConfig(isDarkMode);
                 
                 updateLoadingMessage('Configuring diagram themes...', 'mermaid-init');
                 
                 // Configure Mermaid with comprehensive theme settings
                 mermaid.initialize({
                     startOnLoad: false, // Important! We manually control the rendering
                     securityLevel: 'loose', // Allow all diagram features
                     htmlLabels: true, // Enable HTML labels for better text rendering
                     theme: themeConfig.theme,
                     themeVariables: themeConfig.themeVariables,
                     flowchart: {
                         useMaxWidth: true,
                         htmlLabels: true,
                         curve: 'basis'
                     },
                     sequence: {
                         useMaxWidth: true,
                         wrap: true
                     },
                     class: {
                         useMaxWidth: true
                     },
                     state: {
                         useMaxWidth: true
                     },
                     er: {
                         useMaxWidth: true
                     },
                     journey: {
                         useMaxWidth: true
                     },
                     gantt: {
                         useMaxWidth: true
                     },
                     pie: {
                         useMaxWidth: true
                     },
                     // Simplified configuration - remove complex settings that might cause issues
                     logLevel: 'error',
                     suppressErrorRendering: false
                 });
                 console.log(`Mermaid initialized successfully with ${isDarkMode ? 'dark' : 'light'} theme`);
                 hideLoading('mermaid-init');
             } catch (error) {
                 console.error('Error initializing Mermaid:', error);
                 hideLoading('mermaid-init');
             }
         }

         // Get comprehensive theme configuration for Mermaid
         function getMermaidThemeConfig(isDarkMode) {
             // Get CSS variables from the document
             const rootStyles = getComputedStyle(document.documentElement);
             const backgroundMain = rootStyles.getPropertyValue('--background-main').trim();
             const textPrimary = rootStyles.getPropertyValue('--text-primary').trim();
             const textSecondary = rootStyles.getPropertyValue('--text-secondary').trim();
             const borderColor = rootStyles.getPropertyValue('--border-color').trim();
             const backgroundCard = rootStyles.getPropertyValue('--background-card').trim();
             const backgroundHover = rootStyles.getPropertyValue('--background-hover').trim();
             const productAccent = rootStyles.getPropertyValue('--product-accent').trim();
             
             if (isDarkMode) {
                 return {
                     theme: 'dark',
                     themeVariables: {
                         // Core theme colors using CSS variables
                         darkMode: true,
                         background: backgroundMain,
                         primaryColor: productAccent, // Use the accent color for primary elements
                         primaryTextColor: textPrimary,
                         primaryBorderColor: borderColor,
                         lineColor: borderColor,
                         
                         // Font configuration
                         fontFamily: "'Roboto', 'Segoe UI', Arial, sans-serif",
                         fontSize: '14px',
                         
                         // Secondary colors
                         secondaryColor: backgroundCard,
                         tertiaryColor: backgroundHover,
                         
                         // Text colors - all using CSS variables
                         textColor: textPrimary,
                         darkTextColor: textPrimary,
                         mainBkg: backgroundCard,
                         secondBkg: backgroundHover,
                         tertiaryBkg: backgroundMain,
                         
                         // Node and connector styling
                         nodeBkg: backgroundCard,
                         nodeBorder: borderColor,
                         clusterBkg: backgroundMain,
                         clusterBorder: borderColor,
                         defaultLinkColor: productAccent,
                         titleColor: textPrimary,
                         edgeLabelBackground: backgroundMain,
                         
                         // Specific diagram type colors
                         actorBorder: borderColor,
                         actorBkg: backgroundCard,
                         actorTextColor: textPrimary,
                         actorLineColor: borderColor,
                         signalColor: textPrimary,
                         signalTextColor: textPrimary,
                         
                         // Flowchart colors - readable and distinguishable
                         fillType0: '#4285f4', // Blue - good contrast in dark mode
                         fillType1: '#81c995', // Light green
                         fillType2: '#fdd663', // Yellow
                         fillType3: '#f28b82', // Light red
                         fillType4: '#ce93d8', // Light purple
                         fillType5: '#ffab91', // Light orange
                         fillType6: '#80deea', // Light cyan
                         fillType7: '#a5d6a7', // Another green shade
                         
                         // Class diagram colors
                         classText: textPrimary,
                         
                         // State diagram colors
                         labelColor: textPrimary,
                         altBackground: backgroundCard,
                         
                         // ER diagram colors
                         entityBkg: backgroundCard,
                         entityTextColor: textPrimary,
                         relationLabelColor: textPrimary,
                         
                         // Journey diagram colors
                         taskBkgColor: backgroundCard,
                         taskTextColor: textPrimary,
                         activeTaskBkgColor: productAccent,
                         activeTaskBorderColor: borderColor,
                         gridColor: borderColor,
                         section0: '#4285f4',
                         section1: '#81c995',
                         section2: '#fdd663',
                         section3: '#f28b82'
                     }
                 };
             } else {
                 return {
                     theme: 'default',
                     themeVariables: {
                         // Core theme colors using CSS variables
                         background: backgroundMain,
                         primaryColor: productAccent,
                         primaryTextColor: textPrimary,
                         primaryBorderColor: borderColor,
                         lineColor: borderColor,
                         
                         // Font configuration
                         fontFamily: "'Roboto', 'Segoe UI', Arial, sans-serif",
                         fontSize: '14px',
                         
                         // Secondary colors
                         secondaryColor: backgroundCard,
                         tertiaryColor: backgroundHover,
                         
                         // Text colors - all using CSS variables
                         textColor: textPrimary,
                         darkTextColor: textPrimary,
                         mainBkg: backgroundCard,
                         secondBkg: backgroundHover,
                         tertiaryBkg: backgroundMain,
                         
                         // Node and connector styling
                         nodeBkg: backgroundCard,
                         nodeBorder: borderColor,
                         clusterBkg: backgroundMain,
                         clusterBorder: borderColor,
                         defaultLinkColor: productAccent,
                         titleColor: textPrimary,
                         edgeLabelBackground: backgroundMain,
                         
                         // Specific diagram type colors
                         actorBorder: borderColor,
                         actorBkg: backgroundCard,
                         actorTextColor: textPrimary,
                         actorLineColor: borderColor,
                         signalColor: textPrimary,
                         signalTextColor: textPrimary,
                         
                         // Flowchart colors - readable in light mode
                         fillType0: '#0071ce', // Primary blue
                         fillType1: '#1e8e3e', // Green
                         fillType2: '#f9ab00', // Amber/Yellow
                         fillType3: '#d93025', // Red
                         fillType4: '#9c27b0', // Purple
                         fillType5: '#ff5722', // Deep orange
                         fillType6: '#00acc1', // Cyan
                         fillType7: '#689f38', // Light green
                         
                         // Class diagram colors
                         classText: textPrimary,
                         
                         // State diagram colors
                         labelColor: textPrimary,
                         altBackground: backgroundCard,
                         
                         // ER diagram colors
                         entityBkg: backgroundCard,
                         entityTextColor: textPrimary,
                         relationLabelColor: textPrimary,
                         
                         // Journey diagram colors
                         taskBkgColor: backgroundCard,
                         taskTextColor: textPrimary,
                         activeTaskBkgColor: productAccent,
                         activeTaskBorderColor: borderColor,
                         gridColor: borderColor,
                         section0: '#0071ce',
                         section1: '#1e8e3e',
                         section2: '#f9ab00',
                         section3: '#d93025'
                     }
                 };
             }
         }

         function renderMermaidDiagrams() {
             // Find all mermaid code blocks - be more specific in the selector
             const mermaidBlocks = document.querySelectorAll('pre.mermaid');
             
             if (mermaidBlocks.length === 0) {
                 console.log('No Mermaid diagrams found to render');
                 return;
             }
             
             showLoading(`Preparing ${mermaidBlocks.length} diagram${mermaidBlocks.length > 1 ? 's' : ''}...`, 'mermaid-render');
             console.log(`Found ${mermaidBlocks.length} Mermaid diagrams to render`);
             
             let processedCount = 0;
             let successCount = 0;
             let errorCount = 0;
             
             const updateProgress = () => {
                 processedCount++;
                 updateLoadingMessage(
                     `Rendering diagrams... ${processedCount}/${mermaidBlocks.length} (${successCount} successful, ${errorCount} errors)`,
                     'mermaid-render'
                 );
                 
                 // Hide loading when all diagrams are processed
                 if (processedCount >= mermaidBlocks.length) {
                     clearTimeout(maxTimeout); // Clear the fallback timeout
                     setTimeout(() => {
                         hideLoading('mermaid-render');
                     }, 200); // Small delay to show completion message
                 }
             };
             
             // Set a maximum timeout to ensure loading doesn't hang indefinitely
             const maxTimeout = setTimeout(() => {
                 console.warn('Forcing loading to complete after maximum timeout');
                 hideLoading('mermaid-render');
             }, 30000); // 30 second maximum timeout
             
             mermaidBlocks.forEach((preBlock, index) => {
                 try {
                     // Skip if already processed
                     if (preBlock.classList.contains('mermaid-processed')) {
                         console.log(`Skipping diagram ${index + 1} - already processed`);
                         updateProgress(); // Still count this as processed
                         return;
                     }
                     
                     // Check if there's already a rendered container
                     const existingContainer = preBlock.nextElementSibling?.classList.contains('mermaid-container') ||
                                             preBlock.previousElementSibling?.classList.contains('mermaid-container');
                     if (existingContainer) {
                         console.log(`Skipping diagram ${index + 1} - container already exists`);
                         updateProgress(); // Still count this as processed
                         return;
                     }
                     
                     // Get the code element inside the pre block
                     const codeElement = preBlock.querySelector('code');
                     if (!codeElement) {
                         console.warn(`No code element found in mermaid block ${index + 1}`);
                         errorCount++;
                         updateProgress();
                         return;
                     }
                     
                     // Get the mermaid code content from the code element
                     let mermaidCode = codeElement.textContent || codeElement.innerText;
                     
                     // Skip if empty
                     if (!mermaidCode.trim()) {
                         console.warn(`Empty mermaid code in block ${index + 1}`);
                         errorCount++;
                         updateProgress();
                         return;
                     }
                     
                     // Clean up the code
                     mermaidCode = mermaidCode.trim();
                     
                     // Debug: Log the first few lines of the code to verify content
                     const firstLines = mermaidCode.split('\n').slice(0, 3).join('\n');
                     console.log(`Diagram ${index + 1} content preview:`, firstLines);
                     
                     // Validate this is actually Mermaid syntax, not CSS or other content
                     if (mermaidCode.includes('font-family:') || mermaidCode.includes('keyframes') || mermaidCode.includes('.mermaid-')) {
                         console.error(`Block ${index + 1} contains CSS instead of Mermaid syntax, skipping`);
                         errorCount++;
                         updateProgress();
                         return;
                     }
                     
                     // Validate and fix common syntax issues
                     mermaidCode = validateAndFixMermaidSyntax(mermaidCode);
                     
                     // Detect diagram type for specific handling
                     const diagramType = detectDiagramType(mermaidCode);
                     console.log(`Rendering ${diagramType} diagram ${index + 1}`);
                     
                     // Create a unique ID for this diagram
                     const diagramId = `mermaid-diagram-${index}-${Date.now()}`;
                     
                     // Create container for the rendered diagram with enhanced styling
                     const container = document.createElement('div');
                     container.id = diagramId;
                     container.className = 'mermaid-container';
                     
                     // Apply CSS variable-based styling that adapts to theme
                     const isDarkMode = document.documentElement.classList.contains('dark-mode') || 
                                       document.documentElement.getAttribute('data-theme') === 'dark' ||
                                       window.matchMedia('(prefers-color-scheme: dark)').matches;
                     
                     // Use CSS variables for consistent theming
                     container.style.cssText = `
                         text-align: center;
                         margin: 20px 0;
                         padding: 20px;
                         border: 1px solid var(--border-color);
                         border-radius: 8px;
                         background-color: var(--background-main);
                         box-shadow: ${isDarkMode ? '0 2px 8px rgba(0, 0, 0, 0.5)' : '0 2px 4px rgba(0, 0, 0, 0.1)'};
                         overflow-x: auto;
                         transition: background-color 0.3s ease, border-color 0.3s ease;
                     `;
                     
                     // Insert the container after the pre block
                     preBlock.parentNode.insertBefore(container, preBlock.nextSibling);
                     preBlock.style.display = 'none'; // Hide original but keep for reference
                     
                     // Add timeout to prevent hanging
                     const renderTimeout = setTimeout(() => {
                         console.error(`Rendering timeout for ${diagramType} diagram ${index + 1}`);
                         container.innerHTML = `
                             <div style="color: #ff6b35; padding: 20px; text-align: center;">
                                 <strong>Rendering timeout for ${diagramType} diagram</strong><br>
                                 <small>The diagram took too long to render</small>
                             </div>
                         `;
                         errorCount++;
                         updateProgress();
                     }, 10000); // 10 second timeout
                     
                     // Render the diagram
                     mermaid.render(diagramId + '-svg', mermaidCode)
                         .then(({ svg, bindFunctions }) => {
                             clearTimeout(renderTimeout);
                             container.innerHTML = svg;
                             
                             // Apply bind functions if they exist (for interactive elements)
                             if (bindFunctions) {
                                 try {
                                     bindFunctions(container);
                                 } catch (bindError) {
                                     console.warn('Error applying bind functions:', bindError);
                                 }
                             }
                             
                             // Mark as processed
                             preBlock.classList.add('mermaid-processed');
                             
                             // Add diagram type as data attribute
                             container.setAttribute('data-diagram-type', diagramType);
                             
                             console.log(`Successfully rendered ${diagramType} diagram ${index + 1}`);
                             successCount++;
                             updateProgress();
                         })
                         .catch(error => {
                             clearTimeout(renderTimeout);
                             console.error(`Error rendering ${diagramType} diagram ${index + 1}:`, error);
                             
                             // Show detailed error information
                             const errorDetails = error.message || 'Unknown error occurred';
                             const codePreview = mermaidCode.length > 200 ? 
                                 mermaidCode.substring(0, 200) + '...' : 
                                 mermaidCode;
                             
                             container.innerHTML = `
                                 <div style="color: #d32f2f; padding: 20px; text-align: center; border: 1px solid #d32f2f; border-radius: 4px; background-color: #ffebee;">
                                     <strong>Error rendering ${diagramType} diagram:</strong><br>
                                     <small>${errorDetails}</small><br>
                                     <details style="margin-top: 10px;">
                                         <summary>Show diagram code</summary>
                                         <pre style="text-align: left; background: #f5f5f5; padding: 10px; margin-top: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word;">${codePreview}</pre>
                                     </details>
                                 </div>
                             `;
                             errorCount++;
                             updateProgress();
                         });
                         
                 } catch (error) {
                     console.error(`Error processing Mermaid block ${index + 1}:`, error);
                     errorCount++;
                     updateProgress();
                 }
             });
             
             // Fallback: if no diagrams were found or processed, hide loading immediately
             if (mermaidBlocks.length === 0) {
                 console.log('No Mermaid diagrams found');
                 clearTimeout(maxTimeout);
                 hideLoading('mermaid-render');
             }
         }

         function detectDiagramType(code) {
             const trimmedCode = code.trim().toLowerCase();
             
             if (trimmedCode.startsWith('graph') || trimmedCode.startsWith('flowchart')) return 'flowchart';
             if (trimmedCode.startsWith('sequencediagram')) return 'sequence';
             if (trimmedCode.startsWith('classdiagram')) return 'class';
             if (trimmedCode.startsWith('statediagram')) return 'state';
             if (trimmedCode.startsWith('erdiagram')) return 'er';
             if (trimmedCode.startsWith('journey')) return 'user-journey';
             if (trimmedCode.startsWith('gantt')) return 'gantt';
             if (trimmedCode.startsWith('pie')) return 'pie';
             if (trimmedCode.startsWith('gitgraph')) return 'gitgraph';
             if (trimmedCode.startsWith('mindmap')) return 'mindmap';
             if (trimmedCode.startsWith('timeline')) return 'timeline';
             if (trimmedCode.startsWith('quadrantchart')) return 'quadrant';
             if (trimmedCode.startsWith('xychart')) return 'xy';
             if (trimmedCode.startsWith('block')) return 'block';
             if (trimmedCode.startsWith('packet')) return 'packet';
             if (trimmedCode.startsWith('tree')) return 'tree';
             
             return 'unknown';
         }

         function validateAndFixMermaidSyntax(code) {
             let fixedCode = code.trim();
             
             // Remove any HTML entities that might cause issues
             fixedCode = fixedCode
                 .replace(/&amp;/g, '&')
                 .replace(/&lt;/g, '<')
                 .replace(/&gt;/g, '>')
                 .replace(/&#39;/g, "'")
                 .replace(/&quot;/g, '"');
             
             return fixedCode;
         }

         // Update Mermaid theme (used for theme switching)
         function updateMermaidTheme() {
             showLoading('Updating diagram themes...', 'theme-update');
             
             try {
                 // Re-initialize Mermaid with new theme
                 initializeMermaidRendering();
                 
                 // Re-render all diagrams
                 const processedDiagrams = document.querySelectorAll('.mermaid-processed');
                 if (processedDiagrams.length > 0) {
                     updateLoadingMessage('Re-rendering diagrams with new theme...', 'theme-update');
                     
                     // Reset processed state
                     processedDiagrams.forEach(diagram => {
                         diagram.classList.remove('mermaid-processed');
                     });
                     
                     // Remove existing rendered containers
                     const containers = document.querySelectorAll('.mermaid-container');
                     containers.forEach(container => container.remove());
                     
                     // Show original code blocks
                     const hiddenBlocks = document.querySelectorAll('pre.mermaid[style*="display: none"]');
                     hiddenBlocks.forEach(block => {
                         block.style.display = '';
                     });
                     
                     // Re-render
                     renderMermaidDiagrams();
                 }
                 
                 hideLoading('theme-update');
             } catch (error) {
                 console.error('Error updating Mermaid theme:', error);
                 hideLoading('theme-update');
             }
         }
      </script>
   </head>
   <body>
      <!-- Google-like Loading Overlay -->
      <div id="loadingOverlay" class="loading-overlay">
         <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
         </div>
         <div class="loading-text" id="loadingText">Loading...</div>
         <div class="loading-progress">
            <div class="loading-progress-bar"></div>
         </div>
      </div>

      <script>
         document.addEventListener('DOMContentLoaded', function() {
            showLoading('Initializing application...', 'app-init');
            
            // Apply dark mode detection and styling
            updateLoadingMessage('Applying theme settings...', 'app-init');
            applyThemeDetection();
            
            // Initialize Mermaid diagrams
            if (typeof mermaid !== 'undefined') {
               updateLoadingMessage('Setting up diagram renderer...', 'app-init');
               console.log('Initializing Mermaid diagrams...');
               initializeMermaidRendering();
               renderMermaidDiagrams();
            } else {
               console.warn('Mermaid library not loaded');
            }
            
            // Add sorting capability to all tables
            updateLoadingMessage('Preparing interactive tables...', 'app-init');
            makeTablesSortable();
            
            // Add grouping capability to tables with specific columns
            makeTablesGroupable();
            
            // Add pagination to all tables
            makeTablesPaginated();
            
            hideLoading('app-init');
         });
         
         function applyThemeDetection() {
            // Function to apply dark mode
            function applyDarkMode() {
               document.body.classList.add('dark-mode');
               document.documentElement.setAttribute('data-theme', 'dark');
               console.log('Dark mode applied');
               
               // Update Mermaid diagrams theme
               if (typeof updateMermaidTheme === 'function') {
                  setTimeout(updateMermaidTheme, 100);
               }
            }
            
            // Function to apply light mode
            function applyLightMode() {
               document.body.classList.remove('dark-mode');
               document.documentElement.setAttribute('data-theme', 'light');
               console.log('Light mode applied');
               
               // Update Mermaid diagrams theme
               if (typeof updateMermaidTheme === 'function') {
                  setTimeout(updateMermaidTheme, 100);
               }
            }
            
            // Check for dark mode preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
               applyDarkMode();
            } else {
               applyLightMode();
            }
            
            // Listen for changes in color scheme preference
            if (window.matchMedia) {
               const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
               mediaQuery.addEventListener('change', function(e) {
                  showLoading('Switching theme...', 'theme-switch');
                  
                  if (e.matches) {
                     updateLoadingMessage('Applying dark theme...', 'theme-switch');
                     applyDarkMode();
                  } else {
                     updateLoadingMessage('Applying light theme...', 'theme-switch');
                     applyLightMode();
                  }
                  
                  // Update Mermaid diagrams with new theme
                  if (typeof updateMermaidTheme === 'function') {
                     updateMermaidTheme();
                  }
                  
                  hideLoading('theme-switch');
               });
            }
         }
         
         function makeTablesPaginated() {
            const tables = document.querySelectorAll('.table-container table');
            const defaultPageSize = 20;
            
            tables.forEach((table) => {
                // Skip tables that shouldn't be paginated
                if (table.classList.contains('no-pagination')) {
                    return;
                }
                
                // Mark table as paginated
                table.setAttribute('data-paginated', 'true');
                table.setAttribute('data-page-size', String(defaultPageSize));
                table.setAttribute('data-current-page', '1');
                
                // Ensure the table has necessary DOM structure
                let tbody = table.querySelector('tbody');
                if (!tbody) {
                    tbody = document.createElement('tbody');
                    
                    // Move all rows that aren't in thead to tbody
                    const rows = Array.from(table.querySelectorAll('tr'));
                    const theadRows = Array.from(table.querySelectorAll('thead tr'));
                    
                    rows.forEach(row => {
                        if (!theadRows.includes(row)) {
                            tbody.appendChild(row);
                        }
                    });
                    
                    table.appendChild(tbody);
                }
                
                // Store the original table data for pagination
                storeTableData(table);
                
                // Add pagination controls
                addPaginationControls(table);
                
                // Initial pagination
                paginateTable(table);
            });
         }
         
         function storeTableData(table) {
            // Store original rows for pagination
            const tbody = table.querySelector('tbody');
            if (!tbody) {
                return;
            }
            
            // Get all rows, including potential group headers
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Function to preserve icon data before storing
            const preserveIconData = (element) => {
                if (!element) return;
                
                const icons = element.querySelectorAll('.icon, .material-symbols-outlined, [class*="icon"]');
                icons.forEach((icon, index) => {
                    // Store the original icon text as a data attribute
                    const iconText = icon.textContent.trim();
                    if (iconText) {
                        icon.setAttribute('data-original-icon-text', iconText);
                        icon.setAttribute('data-icon-index', String(index));
                    }
                    
                    // Ensure proper classes and styling
                    if (!icon.classList.contains('material-symbols-outlined')) {
                        icon.classList.add('material-symbols-outlined');
                    }
                });
            };
            
            // Check if we're dealing with grouped data
            const hasGroups = rows.some(row => row.classList.contains('group-header'));
            
            // Clear previous pagination data to prevent stale data issues
            if (table._paginationGroupData) delete table._paginationGroupData;
            if (table._paginationData) delete table._paginationData;
            
            if (hasGroups) {
                // For grouped tables, we store the data differently
                const groupData = [];
                let currentGroup = null;
                let currentRows = [];
                
                rows.forEach(row => {
                    if (row.classList.contains('group-header')) {
                        // If we have a previous group, store it
                        if (currentGroup) {
                            groupData.push({
                                header: currentGroup,
                                rows: currentRows
                            });
                        }
                        // Start a new group
                        currentGroup = row;
                        currentRows = [];
                    } else {
                        // Add row to current group
                        currentRows.push(row);
                    }
                });
                
                // Don't forget to add the last group
                if (currentGroup) {
                    groupData.push({
                        header: currentGroup,
                        rows: currentRows
                    });
                }
                
                // Preserve icon data for all grouped elements
                groupData.forEach(group => {
                    preserveIconData(group.header);
                    group.rows.forEach(row => {
                        preserveIconData(row);
                    });
                });
                
                // Store the grouped data
                table._paginationGroupData = groupData;
            } else {
                // For regular tables, filter out any potential group headers just to be safe
                const dataRows = rows.filter(row => !row.classList.contains('group-header'));
                
                // Preserve icon data for all rows
                dataRows.forEach(row => {
                    preserveIconData(row);
                });
                
                table._paginationData = dataRows;
            }
         }
         
         function addPaginationControls(table) {
            const tableContainer = table.closest('.table-container');
            if (!tableContainer) return;
            
            // Create pagination container
            const paginationContainer = document.createElement('div');
            paginationContainer.className = 'table-pagination';
            
            // Top controls with page size selector
            const topControls = document.createElement('div');
            topControls.className = 'pagination-top-controls';
            
            const pageSizeSelector = document.createElement('div');
            pageSizeSelector.className = 'page-size-selector';
            
            // Get current page size from table attribute
            const currentPageSize = parseInt(table.getAttribute('data-page-size') || '20', 10);
            
            // Create the page size selector with the current value selected
            pageSizeSelector.innerHTML = `
                <span class="page-size-label">Items per page</span>
                <select class="page-size-select">
                    <option value="5" ${currentPageSize === 5 ? 'selected' : ''}>5</option>
                    <option value="10" ${currentPageSize === 10 ? 'selected' : ''}>10</option>
                    <option value="20" ${currentPageSize === 20 ? 'selected' : ''}>20</option>
                    <option value="50" ${currentPageSize === 50 ? 'selected' : ''}>50</option>
                    <option value="100" ${currentPageSize === 100 ? 'selected' : ''}>100</option>
                </select>
            `;
            
            // Add event listener for page size change
            const pageSizeSelect = pageSizeSelector.querySelector('.page-size-select');
            pageSizeSelect.addEventListener('change', function() {
                const newPageSize = parseInt(this.value);
                
                console.log(`Page size change requested: ${newPageSize} (from ${table.getAttribute('data-page-size')})`);
                
                // DEBUG: Let's see what's currently visible before making changes
                const currentlyVisibleRows = table.querySelectorAll('tbody tr');
                console.log(`Currently visible rows: ${currentlyVisibleRows.length}`);
                currentlyVisibleRows.forEach((row, index) => {
                    const firstCell = row.querySelector('td');
                    if (firstCell) {
                        console.log(`Row ${index + 1}: ${firstCell.textContent.trim()}`);
                    }
                });
                
                // Calculate pagination values  
                const oldPageSize = parseInt(table.getAttribute('data-page-size')) || 20;
                const oldCurrentPage = parseInt(table.getAttribute('data-current-page')) || 1;
                
                // Get total rows first
                let totalRows = 0;
                if (table._paginationGroupData) {
                    table._paginationGroupData.forEach(group => totalRows += group.rows.length);
                } else if (table._paginationData) {
                    totalRows = table._paginationData.length;
                }
                
                console.log(`Total rows in data: ${totalRows}`);
                
                // Calculate which item we're currently starting with
                const currentFirstItem = (oldCurrentPage - 1) * oldPageSize + 1;
                const currentLastItem = Math.min(currentFirstItem + oldPageSize - 1, totalRows);
                console.log(`Current view: items ${currentFirstItem} to ${currentLastItem}`);
                
                // For page size changes, we want to show the same starting item
                // but limit to the new page size
                let newCurrentPage = Math.ceil(currentFirstItem / newPageSize);
                const newTotalPages = Math.max(1, Math.ceil(totalRows / newPageSize));
                newCurrentPage = Math.max(1, Math.min(newCurrentPage, newTotalPages));
                
                // Calculate how many items we should actually show
                const newFirstItem = (newCurrentPage - 1) * newPageSize + 1;
                const newLastItem = Math.min(newFirstItem + newPageSize - 1, totalRows);
                
                console.log(`Page size change: totalRows=${totalRows}, oldPage=${oldCurrentPage}/${Math.ceil(totalRows / oldPageSize)}, newPage=${newCurrentPage}/${newTotalPages}`);
                console.log(`New view should show: items ${newFirstItem} to ${newLastItem} (max ${newPageSize} items)`);
                
                // IMPORTANT: If we're changing to a smaller page size, we might need to show fewer items
                // to maintain the same starting point
                const visibleItemsCount = currentLastItem - currentFirstItem + 1;
                const expectedNewItemsCount = Math.min(newPageSize, visibleItemsCount);
                console.log(`Currently showing ${visibleItemsCount} items, new page size allows ${newPageSize}, should show ${expectedNewItemsCount}`);
                
                // If the current view has fewer items than the new page size,
                // we might need to adjust to show the same number of items
                if (visibleItemsCount < newPageSize) {
                    console.log(`Adjusting to show same number of items (${visibleItemsCount}) instead of full page size (${newPageSize})`);
                }
                
                // Set new values
                table.setAttribute('data-page-size', newPageSize);
                table.setAttribute('data-current-page', newCurrentPage);
                
                // Execute pagination immediately to see the result
                setTimeout(() => {
                    console.log('Executing pagination with new settings');
                    
                    paginateTable(table);
                    
                    // NOTE: Removed emoji replacement - let's preserve original content exactly
                    const newVisibleRows = table.querySelectorAll('tbody tr');
                    console.log(`After pagination - visible rows: ${newVisibleRows.length}`);
                    newVisibleRows.forEach((row, index) => {
                        const firstCell = row.querySelector('td');
                        if (firstCell) {
                            console.log(`New Row ${index + 1}: ${firstCell.textContent.trim()}`);
                        }
                    });
                }, 0);
            });
            
            // Pagination info (showing X-Y of Z)
            const paginationInfo = document.createElement('div');
            paginationInfo.className = 'pagination-info';
            
            topControls.appendChild(pageSizeSelector);
            topControls.appendChild(paginationInfo);
            
            // Pagination navigation
            const paginationNav = document.createElement('div');
            paginationNav.className = 'pagination-nav';
            
            // We'll populate the navigation in the updatePaginationControls function
            
            // Add all elements to the container
            paginationContainer.appendChild(topControls);
            paginationContainer.appendChild(paginationNav);
            
            // Add to the DOM after the table
            tableContainer.appendChild(paginationContainer);
            
            // Initial update of pagination controls
            updatePaginationControls(table);
         }
         
         function paginateTable(table) {
            // Make sure we have valid numeric values for page size and current page
            const pageSize = Math.max(1, parseInt(table.getAttribute('data-page-size') || '20', 10));
            let currentPage = Math.max(1, parseInt(table.getAttribute('data-current-page') || '1', 10));
            const tbody = table.querySelector('tbody');
            
            if (!tbody) {
                return;
            }
            
            // Calculate total rows and total pages to make sure current page is valid
            let totalRows = 0;
            
            // Check if we have pagination data at all
            if (!table._paginationGroupData && !table._paginationData) {
                try {
                    storeTableData(table);
                } catch (error) {
                    console.error('Error storing table data:', error);
                    return;
                }
            }
            
            // Ensure we're not dealing with stale grouped data when we should be in ungrouped mode
            // Check if the table has actual group headers in the DOM
            const hasRealGroupHeaders = tbody.querySelector('.group-header') !== null;
            
            // If we have grouped data in memory but no actual group headers in the DOM, 
            // we need to rebuild the pagination data for the ungrouped state
            if (table._paginationGroupData && !hasRealGroupHeaders) {
                delete table._paginationGroupData;
                storeTableData(table);
            }
            
            // Calculate total rows from whichever data structure we have
            if (table._paginationGroupData) {
                table._paginationGroupData.forEach(group => totalRows += group.rows.length);
            } else if (table._paginationData) {
                totalRows = table._paginationData.length;
            } else {
                // Emergency fallback - get what's in the DOM right now
                const visibleRows = tbody.querySelectorAll('tr:not(.group-header)').length;
                totalRows = visibleRows;
                if (totalRows === 0) return; // Nothing to do if no rows
            }
            
            // Ensure we have at least one page
            const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
            
            // Ensure current page is valid (between 1 and totalPages)
            currentPage = Math.max(1, Math.min(currentPage, totalPages));
            
            // Update the current page attribute if it was adjusted
            if (currentPage !== parseInt(table.getAttribute('data-current-page') || '1', 10)) {
                table.setAttribute('data-current-page', String(currentPage));
            }
            
            // Clear the table body first
            tbody.innerHTML = '';
            
            // SIMPLIFIED APPROACH: Use direct cloning and restore proper Material Icons
            const simpleCloneRow = (originalRow) => {
                if (!originalRow) return null;
                
                // Clone the row
                const cloned = originalRow.cloneNode(true);
                
                // Convert any emojis back to proper Material Icons
                const emojiToIconMap = {
                    '': { iconName: 'cancel', classes: 'icon icon-high', title: 'High/Critical' },
                    '': { iconName: 'warning', classes: 'icon icon-medium', title: 'Medium/Warning' },
                    '': { iconName: 'recommend', classes: 'icon icon-low', title: 'Low/Info' },
                    '': { iconName: 'check_circle', classes: 'icon icon-check', title: 'Yes/Used/Supported' },
                    '': { iconName: 'cancel', classes: 'icon icon-cross', title: 'No/Not Used/Unsupported' },
                    '': { iconName: 'help', classes: 'icon icon-question', title: 'Uncertain/Likely' },
                    '': { iconName: 'warning', classes: 'icon icon-medium', title: 'Medium/Warning' },
                    '': { iconName: 'warning', classes: 'icon icon-medium', title: 'Medium/Warning' },
                    '': { iconName: 'warning', classes: 'icon icon-medium', title: 'Medium/Warning' },
                    '': { iconName: 'check_circle', classes: 'icon icon-check', title: 'Yes/Used/Supported' },
                    '': { iconName: 'cancel', classes: 'icon icon-cross', title: 'No/Not Used/Unsupported' },
                    '': { iconName: 'help', classes: 'icon icon-question', title: 'Uncertain/Likely' },
                    '': { iconName: 'cancel', classes: 'icon icon-high', title: 'High/Critical' },
                    '': { iconName: 'cancel', classes: 'icon icon-cross', title: 'No/Not Used/Unsupported' },
                    '': { iconName: 'cancel', classes: 'icon icon-high', title: 'High/Critical' }
                };
                
                // Find all text nodes and spans that might contain emojis
                const walker = document.createTreeWalker(
                    cloned,
                    NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT,
                    null,
                    false
                );
                
                const nodesToReplace = [];
                let node;
                
                while (node = walker.nextNode()) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent;
                        for (const emoji in emojiToIconMap) {
                            if (text.includes(emoji)) {
                                nodesToReplace.push({
                                    node: node,
                                    emoji: emoji,
                                    iconData: emojiToIconMap[emoji],
                                    text: text
                                });
                                break;
                            }
                        }
                    } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'SPAN') {
                        const text = node.textContent.trim();
                        if (emojiToIconMap[text]) {
                            nodesToReplace.push({
                                node: node,
                                emoji: text,
                                iconData: emojiToIconMap[text],
                                isSpan: true
                            });
                        }
                    }
                }
                
                // Replace emojis with proper Material Icons
                nodesToReplace.forEach(replacement => {
                    if (replacement.isSpan) {
                        // Update span content to proper Material Icon name, use correct semantic classes
                        replacement.node.textContent = replacement.iconData.iconName;
                        replacement.node.className = replacement.iconData.classes + ' material-symbols-outlined';
                        replacement.node.title = replacement.iconData.title;
                        
                        // Apply proper Material Icons styling
                        replacement.node.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                        replacement.node.style.fontVariantEmoji = "text";
                    } else {
                        // For text nodes, create new icon span with correct semantic classes
                        const iconSpan = document.createElement('span');
                        iconSpan.className = replacement.iconData.classes + ' material-symbols-outlined';
                        iconSpan.textContent = replacement.iconData.iconName;
                        iconSpan.title = replacement.iconData.title;
                        iconSpan.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                        iconSpan.style.fontVariantEmoji = "text";
                        
                        // Replace the emoji in the text
                        const newText = replacement.text.replace(replacement.emoji, '');
                        if (newText.trim()) {
                            const textNode = document.createTextNode(newText);
                            replacement.node.parentNode.insertBefore(iconSpan, replacement.node);
                            replacement.node.parentNode.insertBefore(textNode, replacement.node);
                        } else {
                            replacement.node.parentNode.insertBefore(iconSpan, replacement.node);
                        }
                        replacement.node.parentNode.removeChild(replacement.node);
                    }
                });
                
                return cloned;
            };
            
            // Check if we're dealing with grouped data
            if (table._paginationGroupData) {
                // For grouped tables, pagination works differently
                const groupData = table._paginationGroupData;
                let totalRows = 0;
                groupData.forEach(group => totalRows += group.rows.length);
                
                // Calculate pagination
                const totalPages = Math.ceil(totalRows / pageSize);
                const startIdx = (currentPage - 1) * pageSize;
                const endIdx = Math.min(startIdx + pageSize, totalRows);
                
                let rowCount = 0;
                let addedRows = 0;
                
                // Add groups and their visible rows
                groupData.forEach(group => {
                    // Check if any rows from this group should be visible
                    const groupStartRow = rowCount;
                    const groupEndRow = rowCount + group.rows.length;
                    
                    // If any rows in this group are visible in the current page
                    if (groupEndRow > startIdx && groupStartRow < endIdx) {
                        // Add the group header
                        const clonedHeader = simpleCloneRow(group.header);
                        tbody.appendChild(clonedHeader);
                        
                        // Add visible rows from this group
                        for (let i = 0; i < group.rows.length; i++) {
                            if (rowCount >= startIdx && rowCount < endIdx) {
                                const clonedRow = simpleCloneRow(group.rows[i]);
                                tbody.appendChild(clonedRow);
                                addedRows++;
                            }
                            rowCount++;
                        }
                    } else {
                        rowCount += group.rows.length;
                    }
                });
                
                // Restore event listeners for group headers
                const groupHeaders = tbody.querySelectorAll('.group-header');
                groupHeaders.forEach(header => {
                    header.addEventListener('click', function() {
                        this.classList.toggle('collapsed');
                        const isCollapsed = this.classList.contains('collapsed');
                        const groupValue = this.getAttribute('data-group');
                        const groupRows = tbody.querySelectorAll(`tr[data-group="${groupValue}"]:not(.group-header)`);
                        
                        groupRows.forEach(row => {
                            if (isCollapsed) {
                                row.classList.add('collapsed-row');
                            } else {
                                row.classList.remove('collapsed-row');
                            }
                        });
                        
                        const icon = this.querySelector('.group-toggle');
                        if (icon) {
                            icon.textContent = isCollapsed ? 'chevron_right' : 'expand_more';
                            icon.className = 'material-symbols-outlined icon group-toggle';
                        }
                    });
                });
            } else {
                // Regular table pagination
                const rows = table._paginationData;
                if (!rows) return;
                
                // Calculate pagination
                const totalPages = Math.ceil(rows.length / pageSize);
                const startIdx = (currentPage - 1) * pageSize;
                const endIdx = Math.min(startIdx + pageSize, rows.length);
                
                // Add visible rows
                for (let i = startIdx; i < endIdx; i++) {
                    const clonedRow = simpleCloneRow(rows[i]);
                    tbody.appendChild(clonedRow);
                }
            }
            
            // Always update pagination controls at the end
            console.log('Calling updatePaginationControls...');
            // Force this to run after the current execution context
            // This ensures the table is fully updated before pagination controls are created
            setTimeout(() => {
                updatePaginationControls(table);
                
                // NOTE: Removed emoji replacement to preserve original content structure
            }, 0);
            console.log('=== Finished paginateTable ===');
         }
         
         function updatePaginationControls(table) {
            console.log('=== Starting updatePaginationControls ===');
            
            const pageSize = parseInt(table.getAttribute('data-page-size')) || 20;
            const currentPage = parseInt(table.getAttribute('data-current-page')) || 1;
            const tableContainer = table.closest('.table-container');
            const paginationContainer = tableContainer.querySelector('.table-pagination');
            
            console.log(`updatePaginationControls: pageSize=${pageSize}, currentPage=${currentPage}`);
            
            if (!paginationContainer) {
                console.error('No pagination container found');
                return;
            }
            
            // Find pagination elements
            const paginationInfo = paginationContainer.querySelector('.pagination-info');
            const paginationNav = paginationContainer.querySelector('.pagination-nav');
            
            // Calculate total rows
            let totalRows = 0;
            if (table._paginationGroupData) {
                table._paginationGroupData.forEach(group => totalRows += group.rows.length);
            } else if (table._paginationData) {
                totalRows = table._paginationData.length;
            }
            
            // Calculate pagination values
            const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
            const startItem = totalRows === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(startItem + pageSize - 1, totalRows);
            
            // Update info text
            if (paginationInfo) {
                paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalRows}`;
            }
            
            // Clear existing navigation
            if (paginationNav) {
                paginationNav.innerHTML = '';
            }
            
            console.log(`Final pagination state: totalRows=${totalRows}, pageSize=${pageSize}, totalPages=${totalPages}, currentPage=${currentPage}`);
            
            // Always show pagination nav div, but only add buttons if multiple pages
            if (paginationNav) {                
                console.log(`Pagination nav found, totalPages=${totalPages}`);
                
                // Create page buttons regardless of total pages
                // This ensures pagination controls are always visible after page size change
                console.log('Creating page buttons...');
                createPageButtons(paginationNav, currentPage, totalPages, table);
                
                // Make sure the page size selector shows the correct value
                const pageSizeSelect = paginationContainer.querySelector('.page-size-select');
                if (pageSizeSelect && pageSizeSelect.value != pageSize) {
                    console.log(`Updating page size selector from ${pageSizeSelect.value} to ${pageSize}`);
                    pageSizeSelect.value = pageSize;
                } else {
                    console.log(`Page size selector already shows correct value: ${pageSize}`);
                }
            } else {
                console.error('Pagination nav not found!');
            }
            
            console.log('=== Finished updatePaginationControls ===');
         }
         
         function createPageButtons(container, currentPage, totalPages, table) {
            // Validate inputs
            currentPage = Math.max(1, currentPage);
            totalPages = Math.max(1, totalPages);
            
            // Define button styles
            const buttonStyles = `
                border: none;
                background: transparent;
                color: #5f6368;
                padding: 8px 12px;
                margin: 0 2px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s ease;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 32px;
                min-height: 32px;
            `;
            
            const disabledButtonStyles = `
                opacity: 0.38;
                cursor: not-allowed;
                pointer-events: none;
            `;
            
            // Ensure we have at least one page
            totalPages = Math.max(1, totalPages);
            
            // Create a div to hold the navigation buttons
            const navButtonsContainer = document.createElement('div');
            navButtonsContainer.className = 'pagination-nav-buttons';
            
            // First page button
            const firstBtn = document.createElement('button');
            firstBtn.className = 'pagination-button first';
            firstBtn.innerHTML = '<span class="material-symbols-outlined icon">first_page</span>';
            firstBtn.title = 'First Page';
            firstBtn.disabled = currentPage === 1;
            firstBtn.style.cssText = buttonStyles + (currentPage === 1 ? disabledButtonStyles : '');
            
            // Immediately fix the icon in this button
            const firstIcon = firstBtn.querySelector('span');
            if (firstIcon) {
                firstIcon.setAttribute('data-original-icon-text', 'first_page');
                firstIcon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                firstIcon.style.fontVariantEmoji = "text";
            }
            
            // Add hover effect - Updated Google style
            firstBtn.addEventListener('mouseover', function() {
                if (currentPage !== 1) {
                    this.style.backgroundColor = 'rgba(60, 64, 67, 0.08)';
                    this.style.color = '#202124';
                }
            });
            
            firstBtn.addEventListener('mouseout', function() {
                if (currentPage !== 1) {
                    this.style.backgroundColor = 'transparent';
                    this.style.color = '#5f6368';
                }
            });
            firstBtn.addEventListener('click', () => {
                table.setAttribute('data-current-page', '1');
                paginateTable(table);
            });
            navButtonsContainer.appendChild(firstBtn);
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-button prev';
            prevBtn.innerHTML = '<span class="material-symbols-outlined icon">chevron_left</span>';
            prevBtn.title = 'Previous Page';
            prevBtn.disabled = currentPage === 1;
            prevBtn.style.cssText = buttonStyles + (currentPage === 1 ? disabledButtonStyles : '');
            
            // Immediately fix the icon in this button
            const prevIcon = prevBtn.querySelector('span');
            if (prevIcon) {
                prevIcon.setAttribute('data-original-icon-text', 'chevron_left');
                prevIcon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                prevIcon.style.fontVariantEmoji = "text";
            }
            
            // Add hover effect - Updated Google style
            prevBtn.addEventListener('mouseover', function() {
                if (currentPage !== 1) {
                    this.style.backgroundColor = 'rgba(60, 64, 67, 0.08)';
                    this.style.color = '#202124';
                }
            });
            
            prevBtn.addEventListener('mouseout', function() {
                if (currentPage !== 1) {
                    this.style.backgroundColor = 'transparent';
                    this.style.color = '#5f6368';
                }
            });
            prevBtn.addEventListener('click', () => {
                const newPage = Math.max(1, currentPage - 1);
                table.setAttribute('data-current-page', newPage);
                paginateTable(table);
            });
            navButtonsContainer.appendChild(prevBtn);
            
            // Add the nav buttons container to the main container
            container.appendChild(navButtonsContainer);
            
            // Create a div to hold the page number buttons
            const pageNumbersContainer = document.createElement('div');
            pageNumbersContainer.className = 'pagination-page-numbers';
            pageNumbersContainer.style.display = 'flex';
            pageNumbersContainer.style.alignItems = 'center';
            pageNumbersContainer.style.margin = '0 10px';
            
            // Google-style page numbers (always show current page and some context)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            // Adjust if we're near the end
            if (endPage === totalPages) {
                startPage = Math.max(1, endPage - 4);
            }
            
            // For single page, ensure we show at least that one page
            if (totalPages === 1) {
                startPage = 1;
                endPage = 1;
            }
            
            // Add ellipsis at start if needed
            if (startPage > 1) {
                const ellipsisStart = document.createElement('span');
                ellipsisStart.className = 'pagination-button ellipsis';
                ellipsisStart.style.cssText = `
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    min-width: 36px;
                    height: 36px;
                    margin: 0 4px;
                    font-size: 14px;
                    color: #5f6368;
                `;
                ellipsisStart.textContent = '...';
                pageNumbersContainer.appendChild(ellipsisStart);
            }
            
            // Add page buttons
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'pagination-button page-number';
                pageBtn.style.cssText = buttonStyles;
                
                // Add hover effect - Updated Google style
                pageBtn.addEventListener('mouseover', function() {
                    if (i !== currentPage) {
                        this.style.backgroundColor = 'rgba(60, 64, 67, 0.08)'; // Transparent gray hover effect
                        this.style.color = '#202124';
                    }
                });
                
                pageBtn.addEventListener('mouseout', function() {
                    if (i !== currentPage) {
                        this.style.backgroundColor = 'transparent';
                        this.style.color = '#5f6368';
                    }
                });
                
                if (i === currentPage) {
                    pageBtn.classList.add('active');
                    pageBtn.style.backgroundColor = 'var(--product-accent)'; // Google Blue
                    pageBtn.style.color = 'white';
                    pageBtn.style.fontWeight = '500';
                    pageBtn.style.border = 'none';
                }
                
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    table.setAttribute('data-current-page', i);
                    paginateTable(table);
                });
                pageNumbersContainer.appendChild(pageBtn);
            }
            
            // Add ellipsis at end if needed
            if (endPage < totalPages) {
                const ellipsisEnd = document.createElement('span');
                ellipsisEnd.className = 'pagination-button ellipsis';
                ellipsisEnd.style.cssText = `
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    min-width: 36px;
                    height: 36px;
                    margin: 0 4px;
                    font-size: 14px;
                    color: #5f6368;
                `;
                ellipsisEnd.textContent = '...';
                pageNumbersContainer.appendChild(ellipsisEnd);
            }
            
            // Add the page numbers container to the main container
            container.appendChild(pageNumbersContainer);
            
            // Create a div for the next/last buttons
            const nextButtonsContainer = document.createElement('div');
            nextButtonsContainer.className = 'pagination-next-buttons';
            nextButtonsContainer.style.display = 'flex';
            nextButtonsContainer.style.alignItems = 'center';
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-button next';
            nextBtn.innerHTML = '<span class="material-symbols-outlined icon">chevron_right</span>';
            nextBtn.title = 'Next Page';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.style.cssText = buttonStyles + (currentPage === totalPages ? disabledButtonStyles : '');
            
            // Immediately fix the icon in this button
            const nextIcon = nextBtn.querySelector('span');
            if (nextIcon) {
                nextIcon.setAttribute('data-original-icon-text', 'chevron_right');
                nextIcon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                nextIcon.style.fontVariantEmoji = "text";
            }
            
            // Add hover effect - Updated Google style
            nextBtn.addEventListener('mouseover', function() {
                if (currentPage !== totalPages) {
                    this.style.backgroundColor = 'rgba(60, 64, 67, 0.08)';
                    this.style.color = '#202124';
                }
            });
            
            nextBtn.addEventListener('mouseout', function() {
                if (currentPage !== totalPages) {
                    this.style.backgroundColor = 'transparent';
                    this.style.color = '#5f6368';
                }
            });
            nextBtn.addEventListener('click', () => {
                const newPage = Math.min(totalPages, currentPage + 1);
                table.setAttribute('data-current-page', newPage);
                paginateTable(table);
            });
            nextButtonsContainer.appendChild(nextBtn);
            
            // Last page button
            const lastBtn = document.createElement('button');
            lastBtn.className = 'pagination-button last';
            lastBtn.innerHTML = '<span class="material-symbols-outlined icon">last_page</span>';
            lastBtn.title = 'Last Page';
            lastBtn.disabled = currentPage === totalPages;
            lastBtn.style.cssText = buttonStyles + (currentPage === totalPages ? disabledButtonStyles : '');
            
            // Immediately fix the icon in this button
            const lastIcon = lastBtn.querySelector('span');
            if (lastIcon) {
                lastIcon.setAttribute('data-original-icon-text', 'last_page');
                lastIcon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                lastIcon.style.fontVariantEmoji = "text";
            }
            
            // Add hover effect - Updated Google style
            lastBtn.addEventListener('mouseover', function() {
                if (currentPage !== totalPages) {
                    this.style.backgroundColor = 'rgba(60, 64, 67, 0.08)';
                    this.style.color = '#202124';
                }
            });
            
            lastBtn.addEventListener('mouseout', function() {
                if (currentPage !== totalPages) {
                    this.style.backgroundColor = 'transparent';
                    this.style.color = '#5f6368';
                }
            });
            lastBtn.addEventListener('click', () => {
                table.setAttribute('data-current-page', totalPages);
                paginateTable(table);
            });
            nextButtonsContainer.appendChild(lastBtn);
            
            // Add the next buttons container to the main container
            container.appendChild(nextButtonsContainer);
            
            // Fix all icons in the pagination controls
            setTimeout(() => {
                const paginationIcons = container.querySelectorAll('.icon, .material-symbols-outlined');
                paginationIcons.forEach(icon => {
                    if (!icon.classList.contains('material-symbols-outlined')) {
                        icon.classList.add('material-symbols-outlined');
                    }
                    
                    icon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                    icon.style.fontWeight = "normal";
                    icon.style.fontStyle = "normal";
                    icon.style.fontVariantEmoji = "text"; // Prevent emoji rendering
                    
                    const iconText = icon.textContent.trim();
                    if (iconText) {
                        icon.innerHTML = '';
                        icon.textContent = iconText;
                    }
                });
            }, 0);
         }
         
         function makeTablesSortable() {
            const tables = document.querySelectorAll('.table-container table');
            
            tables.forEach(table => {
               const headers = table.querySelectorAll('th');
               
               headers.forEach((header, index) => {
                  // Skip columns that shouldn't be sortable (you can add a 'no-sort' class to specific headers)
                  if (header.classList.contains('no-sort')) return;
                  
                  // Add sorting indicators and cursor pointer
                  header.style.cursor = 'pointer';
                  header.style.position = 'relative';
                  header.setAttribute('data-sort-direction', '');
                  
                  // Create sort indicator element
                  const sortIndicator = document.createElement('span');
                  sortIndicator.className = 'sort-indicator';
                  sortIndicator.innerHTML = '&nbsp;';
                  sortIndicator.style.fontSize = '0.8em';
                  sortIndicator.style.opacity = '0.6';
                  sortIndicator.style.marginLeft = '5px';
                  sortIndicator.style.display = 'inline-block';
                  header.appendChild(sortIndicator);
                  
                  // Add click event
                  header.addEventListener('click', function() {
                     sortTable(table, index, header);
                  });
               });
            });
         }
         
         function makeTablesGroupable() {
            const tables = document.querySelectorAll('.table-container table');
            
            // For debugging - add a small indicator to help identify if function is running
            console.log('Looking for groupable tables...', tables.length);
            
            tables.forEach((table, tableIndex) => {
               // Make sure the table has a thead
               const thead = table.querySelector('thead');
               if (!thead) return;
               
               const headers = Array.from(thead.querySelectorAll('th'));
               let groupableColumnIndices = [];
               
               // Make all columns groupable
               headers.forEach((header, index) => {
                  // Skip columns that shouldn't be groupable (you can add a 'no-group' class to specific headers)
                  if (header.classList.contains('no-group')) return;
                  
                  const headerText = header.textContent.trim();
                  
                  // Skip empty headers
                  if (headerText !== '') {
                     groupableColumnIndices.push({index: index, name: headerText});
                  }
               });
               
               // If there are any columns to group by, add group controls
               if (groupableColumnIndices.length > 0) {
                  addGroupingControlsToTable(table, groupableColumnIndices);
                  console.log(`Added grouping controls to table ${tableIndex+1} with ${groupableColumnIndices.length} columns`);
               }
            });
         }
         
         function addGroupingControlsToTable(table, groupableColumns) {
            const tableContainer = table.closest('.table-container');
            
            // Remove any existing grouping controls to prevent duplicates
            const existingControls = tableContainer.querySelector('.table-group-controls');
            if (existingControls) {
               existingControls.remove();
            }
            
            // Create grouping control panel with improved styling
            const groupingControls = document.createElement('div');
            groupingControls.className = 'table-group-controls';
            groupingControls.style.display = 'flex';
            groupingControls.style.flexWrap = 'wrap';
            groupingControls.style.alignItems = 'center';
            groupingControls.style.padding = '10px 12px';
            groupingControls.style.backgroundColor = '#f8f9fa';
            groupingControls.style.borderRadius = '4px';
            groupingControls.style.border = '1px solid #e0e0e0';
            
            // Add title with icon
            const groupTitle = document.createElement('div');
            groupTitle.className = 'group-title';
            groupTitle.style.marginRight = '16px';
            groupTitle.style.fontWeight = '500';
            groupTitle.style.display = 'flex';
            groupTitle.style.alignItems = 'center';
            
            const icon = document.createElement('span');
            icon.className = 'material-symbols-outlined';
            icon.textContent = 'filter_list';
            icon.style.marginRight = '6px';
            icon.style.fontSize = '20px';
            icon.style.color = '#0071ce';
            
            const titleText = document.createElement('span');
            titleText.textContent = 'Group by:';
            
            groupTitle.appendChild(icon);
            groupTitle.appendChild(titleText);
            groupingControls.appendChild(groupTitle);
            
            // Add controls for each groupable column
            const groupOptions = document.createElement('div');
            groupOptions.className = 'group-options';
            groupOptions.style.display = 'flex';
            groupOptions.style.flexWrap = 'wrap';
            groupOptions.style.gap = '8px';
            
            // Add "None" option with improved styling
            const noneOption = document.createElement('button');
            noneOption.className = 'group-option active';
            noneOption.textContent = 'None';
            noneOption.style.padding = '6px 12px';
            noneOption.style.border = '1px solid #ddd';
            noneOption.style.borderRadius = '4px';
            noneOption.style.backgroundColor = '#fff';
            noneOption.style.cursor = 'pointer';
            noneOption.style.transition = 'all 0.2s ease';
            
            // Active style
            if (noneOption.classList.contains('active')) {
               noneOption.style.backgroundColor = '#0071ce';
               noneOption.style.color = '#fff';
               noneOption.style.border = '1px solid #0071ce';
            }
            
            noneOption.onclick = function(event) {
               // Prevent event propagation
               event.stopPropagation();
               event.preventDefault();
               
               console.log('None option clicked - Starting grouping reset');
               
               try {
                  // Set this option as active first to provide visual feedback
                  setActiveGroupOption(groupOptions, this);
                  
                  // Add a small delay to ensure UI feedback happens before potentially intensive operation
                  setTimeout(() => {
                     // Ensure we clean up all grouping
                     resetGrouping(table);
                     console.log('None option: grouping reset complete');
                  }, 10);
               } catch (error) {
                  console.error('Error handling None option click:', error);
               }
            };
            
            // Add hover effect
            noneOption.onmouseover = function() {
               if (!this.classList.contains('active')) {
                  this.style.backgroundColor = '#f0f0f0';
               }
            };
            noneOption.onmouseout = function() {
               if (!this.classList.contains('active')) {
                  this.style.backgroundColor = '#fff';
               }
            };
            
            groupOptions.appendChild(noneOption);
            
            // Add column options with the same styling
            groupableColumns.forEach(column => {
               const option = document.createElement('button');
               option.className = 'group-option';
               option.textContent = column.name;
               option.style.padding = '6px 12px';
               option.style.border = '1px solid #ddd';
               option.style.borderRadius = '4px';
               option.style.backgroundColor = '#fff';
               option.style.cursor = 'pointer';
               option.style.transition = 'all 0.2s ease';
               
               // Add hover effect
               option.onmouseover = function() {
                  if (!this.classList.contains('active')) {
                     this.style.backgroundColor = '#f0f0f0';
                  }
               };
               option.onmouseout = function() {
                  if (!this.classList.contains('active')) {
                     this.style.backgroundColor = '#fff';
                  }
               };
               
               option.onclick = (event) => {
                  // Prevent event propagation
                  event.stopPropagation();
                  event.preventDefault();
                  
                  console.log(`Group option clicked: ${column.name}`);
                  groupTableByColumn(table, column.index, column.name);
                  setActiveGroupOption(groupOptions, option);
               };
               groupOptions.appendChild(option);
            });
            
            groupingControls.appendChild(groupOptions);
            
            // Insert controls before the table
            tableContainer.insertBefore(groupingControls, table);
         }
         
         function setActiveGroupOption(container, activeButton) {
            console.log('Setting active group option:', activeButton.textContent);
            
            // Remove active class and reset styles from all buttons
            const buttons = container.querySelectorAll('.group-option');
            buttons.forEach(button => {
               button.classList.remove('active');
               button.style.backgroundColor = '#fff';
               button.style.color = '#333';
               button.style.border = '1px solid #ddd';
            });
            
            // Add active class to the selected button
            activeButton.classList.add('active');
            
            // Apply active styles
            activeButton.style.backgroundColor = '#0071ce';
            activeButton.style.color = '#fff';
            activeButton.style.border = '1px solid #0071ce';
            activeButton.style.fontWeight = '500';
         }
         
         function groupTableByColumn(table, columnIndex, columnName) {
            // Implementation for grouping table by column
            
            // Get all rows except header
            const tbody = table.querySelector('tbody');
            if (!tbody) {
               console.error('No tbody found in table during grouping');
               return;
            }
            
            // First, ensure all existing group headers are removed
            const allRows = Array.from(tbody.querySelectorAll('tr'));
            const dataRows = allRows.filter(row => !row.classList.contains('group-header'));
            const existingGroups = tbody.querySelectorAll('.group-header');
            
            console.log(`Found ${allRows.length} total rows, ${dataRows.length} data rows, ${existingGroups.length} existing group headers`);
            
            // Make sure to remove existing group headers properly
            existingGroups.forEach(group => {
               if (group.parentNode) {
                  group.parentNode.removeChild(group);
               }
            });
            
            // Reset all rows to their default state
            dataRows.forEach(row => {
               row.style.display = '';
               row.removeAttribute('data-group');
               row.classList.remove('first-in-group', 'collapsed-row');
            });
            
            // Group the data - use a new empty object for clean grouping
            const groupedData = {};
            
            dataRows.forEach(row => {
               // Ensure we have the right index
               if (columnIndex >= row.cells.length) {
                  console.warn(`Column index ${columnIndex} out of bounds for row`, row);
                  return;
               }
               
               // Extract only the text content and ignore icons
               const cell = row.cells[columnIndex];
               if (!cell) {
                  console.warn(`No cell found at index ${columnIndex} for row`, row);
                  return;
               }
               
               let cellValue = '';
               
               // Function to extract text nodes only (no icon text)
               function extractTextOnly(element) {
                  // Special case for cells with icons + text pattern like "dangerous High"
                  // Try to find any direct text node that is not within an icon element
                  let directTextContent = '';
                  let hasFoundDirectText = false;
                  
                  // First, check if this is a cell with the specific structure we're targeting
                  // This usually means it has both an icon with text and visible text afterward
                  const iconElements = element.querySelectorAll('.icon, .icon-high, .icon-medium, .icon-low');
                  if (iconElements.length > 0) {
                     // Try to find text nodes that are direct children but not part of icons
                     for (let childNode of element.childNodes) {
                        // Text node that's a direct child
                        if (childNode.nodeType === 3 && childNode.textContent.trim()) {
                           directTextContent += childNode.textContent.trim() + ' ';
                           hasFoundDirectText = true;
                        }
                        // If it's a span that doesn't have icon classes, it might contain our text
                        else if (childNode.nodeType === 1 && 
                                !childNode.classList?.contains('icon') && 
                                !childNode.classList?.contains('icon-high') && 
                                !childNode.classList?.contains('icon-medium') && 
                                !childNode.classList?.contains('icon-low')) {
                           // Only extract text if it doesn't contain icon children
                           if (!childNode.querySelector('.icon')) {
                              directTextContent += childNode.textContent.trim() + ' ';
                              hasFoundDirectText = true;
                           }
                        }
                     }
                  }
                  
                  // If we found direct text, use that (this helps with the specific case of "dangerous High")
                  if (hasFoundDirectText) {
                     return directTextContent.trim();
                  }
                  
                  // Otherwise, use the more generic approach
                  let text = '';
                  for (let node of element.childNodes) {
                     if (node.nodeType === 3) { // Text node
                        text += node.textContent.trim() + ' ';
                     } else if (node.nodeType === 1) { // Element node
                        // Skip icon elements, elements with icon class
                        const classList = node.classList ? Array.from(node.classList) : [];
                        const hasIconClass = classList.some(cls => cls === 'icon' || cls.startsWith('icon-'));
                        const isIcon = hasIconClass || 
                                      node.tagName.toLowerCase() === 'i';
                                    
                        if (!isIcon) {
                           text += extractTextOnly(node);
                        }
                     }
                  }
                  return text;
               }
               
               cellValue = extractTextOnly(cell).trim();
               
               // If we couldn't extract text properly, fallback to full text
               if (!cellValue) {
                  cellValue = cell.textContent.trim();
               }
               
               // Handle empty values specially
               const normalizedValue = cellValue || '(Empty)';
               
               // Create the group if it doesn't exist yet
               if (!groupedData[normalizedValue]) {
                  groupedData[normalizedValue] = [];
               }
               
               // Add the row to the group
               groupedData[normalizedValue].push(row);
            });
            
            // Clear the tbody completely to start fresh
            while (tbody.firstChild) {
               tbody.removeChild(tbody.firstChild);
            }
            
            // Create a sorted array of group values
            const groupValues = Object.keys(groupedData).sort();
            console.log(`Created ${groupValues.length} groups`);
            
            // Add rows back with group headers
            groupValues.forEach(groupValue => {
               const rowsInThisGroup = groupedData[groupValue];
               console.log(`Adding group: "${groupValue}" with ${rowsInThisGroup.length} rows`);
               
               // Create group header
               const groupHeader = document.createElement('tr');
               groupHeader.className = 'group-header';
               groupHeader.setAttribute('data-group', groupValue);
               
               const groupCell = document.createElement('td');
               // Get the correct column count from thead
               const headerRow = table.querySelector('thead tr');
               const colCount = headerRow ? headerRow.cells.length : 
                               (rowsInThisGroup.length > 0 ? rowsInThisGroup[0].cells.length : 1);
               groupCell.colSpan = colCount;
               
               const groupContent = document.createElement('div');
               groupContent.className = 'group-header-content';
               groupContent.style.display = 'flex';
               groupContent.style.alignItems = 'center';
               groupContent.style.padding = '8px';
               groupContent.style.backgroundColor = '#f5f7f9';
               groupContent.style.borderRadius = '4px';
               
               const groupIcon = document.createElement('span');
               groupIcon.className = 'material-symbols-outlined icon group-toggle';
               groupIcon.textContent = 'expand_more';
               groupIcon.style.marginRight = '8px';
               groupIcon.style.color = '#0071ce';
               groupIcon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
               groupIcon.style.fontWeight = 'normal';
               groupIcon.style.fontSize = '20px';
               groupIcon.style.lineHeight = '1';
               groupIcon.style.display = 'flex';
               groupIcon.style.alignItems = 'center';
               groupIcon.style.justifyContent = 'center';
               
               const groupTitle = document.createElement('span');
               groupTitle.className = 'group-header-title';
               groupTitle.textContent = `${columnName}: ${groupValue}`;
               groupTitle.style.fontWeight = '500';
               groupTitle.style.color = '#333';
               
               const groupCount = document.createElement('span');
               groupCount.className = 'group-count';
               groupCount.textContent = `${rowsInThisGroup.length} items`;
               groupCount.style.marginLeft = '12px';
               groupCount.style.fontSize = '0.85em';
               groupCount.style.color = '#666';
               groupCount.style.backgroundColor = 'rgba(0, 113, 206, 0.1)';
               groupCount.style.padding = '2px 8px';
               groupCount.style.borderRadius = '12px';
               
               groupContent.appendChild(groupIcon);
               groupContent.appendChild(groupTitle);
               groupContent.appendChild(groupCount);
               groupCell.appendChild(groupContent);
               groupHeader.appendChild(groupCell);
               
               // Add toggle functionality and make it more obvious
               groupHeader.title = 'Click to expand/collapse group';
               groupHeader.style.cursor = 'pointer';
               
               /* Add tooltip text to make it clear this is collapsible
               const tooltipSpan = document.createElement('span');
               tooltipSpan.className = 'group-tooltip';
               tooltipSpan.textContent = 'Click to expand/collapse';
               tooltipSpan.style.fontSize = '0.75em';
               tooltipSpan.style.color = '#666';
               tooltipSpan.style.marginLeft = '8px';
               tooltipSpan.style.padding = '2px 6px';
               tooltipSpan.style.background = 'rgba(0, 113, 206, 0.08)';
               tooltipSpan.style.borderRadius = '4px';
               groupContent.appendChild(tooltipSpan);*/
               
               groupHeader.addEventListener('click', function(event) {
                  // Prevent event propagation
                  event.stopPropagation();
                  
                  this.classList.toggle('collapsed');
                  const isCollapsed = this.classList.contains('collapsed');
                  const groupValue = this.getAttribute('data-group');
                  
                  // Ensure we're getting the right rows by being more specific with our selector
                  // We need to escape special characters in the group value for the selector
                  const escapedGroupValue = groupValue.replace(/"/g, '\\"');
                  const groupRows = tbody.querySelectorAll(`tr[data-group="${escapedGroupValue}"]:not(.group-header)`);
                  
                  console.log(`Toggle group: "${groupValue}", Collapsed: ${isCollapsed}, Found rows: ${groupRows.length}`);
                  
                  // Toggle row visibility with CSS classes for better performance
                  groupRows.forEach(row => {
                     if (isCollapsed) {
                        row.classList.add('collapsed-row');
                        row.style.display = 'none';
                     } else {
                        row.classList.remove('collapsed-row');
                        row.style.display = '';
                     }
                  });
                  
                  // Update the icon with proper styling
                  const icon = this.querySelector('.group-toggle');
                  if (icon) {
                     icon.textContent = isCollapsed ? 'chevron_right' : 'expand_more';
                     
                     // Ensure consistent icon styling after text change
                     icon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                     icon.style.fontWeight = 'normal';
                     icon.style.fontSize = '20px';
                     icon.style.lineHeight = '1';
                     icon.style.display = 'flex';
                     icon.style.alignItems = 'center';
                     icon.style.justifyContent = 'center';
                  }
                  
                  /* Update tooltip text based on collapsed state
                  const tooltipElement = this.querySelector('.group-tooltip');
                  if (tooltipElement) {
                     tooltipElement.textContent = isCollapsed ? 'Click to expand' : 'Click to collapse';
                  }*/
                  
                  // Show a count of collapsed items when collapsed
                  const existingBadge = this.querySelector('.collapsed-count');
                  if (existingBadge) {
                     existingBadge.remove();
                  }
                  
                  if (isCollapsed) {
                     const count = groupRows.length;
                     const countBadge = document.createElement('span');
                     countBadge.className = 'collapsed-count';
                     countBadge.textContent = `(${count} items hidden)`;
                     countBadge.style.fontSize = '0.7em';
                     countBadge.style.padding = '2px 8px';
                     countBadge.style.backgroundColor = 'rgba(0, 113, 206, 0.15)';
                     countBadge.style.color = 'rgba(0, 113, 206, 0.9)';
                     countBadge.style.borderRadius = '10px';
                     countBadge.style.marginLeft = '10px';
                     countBadge.style.fontWeight = '500';
                     countBadge.style.border = '1px solid rgba(0, 113, 206, 0.3)';
                     
                     const headerContent = this.querySelector('.group-header-content');
                     if (headerContent) {
                        headerContent.appendChild(countBadge);
                     }
                  }
               });
               
               // Add the group header to the tbody
               tbody.appendChild(groupHeader);
               
               // Add the rows for this group with data-group attribute
               groupedData[groupValue].forEach((row, i) => {
                  // Set data-group attribute for proper identification
                  row.setAttribute('data-group', groupValue);
                  
                  // Style the first row in each group differently if needed
                  if (i === 0) {
                     row.classList.add('first-in-group');
                  }
                  
                  // Add the row to the tbody
                  tbody.appendChild(row);
               });
            });
            
            // Make sure we have consistent styles for grouped table
            const style = document.createElement('style');
            style.textContent = `
               .group-header { background-color: #f5f7f9; }
               .group-header td { padding: 0 !important; }
               .group-header-content { padding: 10px; }
               .collapsed-row { display: none; }
               tr.first-in-group td { border-top: 1px solid #e0e0e0; }
               .group-header:hover { background-color: #eef1f5; }
               
               /* Material Icons proper styling */
               .material-symbols-outlined.icon {
                  font-family: 'Material Symbols Outlined', sans-serif !important;
                  font-weight: normal !important;
                  font-style: normal !important;
                  font-size: 20px !important;
                  line-height: 1 !important;
                  display: inline-flex !important;
                  align-items: center !important;
                  justify-content: center !important;
                  text-transform: none !important;
                  letter-spacing: normal !important;
                  overflow-wrap: normal !important;
                  white-space: nowrap !important;
                  direction: ltr !important;
                  -webkit-font-smoothing: antialiased !important;
               }
            `;
            
            // Only add the style if it doesn't exist yet
            if (!document.querySelector('style[data-group-styles="true"]')) {
                style.setAttribute('data-group-styles', 'true');
                document.head.appendChild(style);
            }
            
            console.log('Group headers and rows added to table');
            
            // Re-apply pagination if it's enabled
            if (table.hasAttribute('data-paginated')) {
               console.log('Table is paginated, re-applying pagination after grouping');
               // Re-store table data since grouping has changed the structure
               storeTableData(table);
               // Reset to first page and update
               table.setAttribute('data-current-page', '1');
               paginateTable(table);
            }
         }
         
         function resetGrouping(table) {
            console.log('Resetting table grouping - START');
            const tbody = table.querySelector('tbody');
            if (!tbody) {
               console.error('No tbody found in table during resetGrouping');
               return;
            }
            
            try {
               // Backup of all non-header rows (important data rows)
               const allRows = Array.from(tbody.querySelectorAll('tr'));
               const dataRows = allRows.filter(row => !row.classList.contains('group-header'));
               
               console.log(`Found ${allRows.length} total rows, ${dataRows.length} data rows to restore`);
               
               // Make a clean copy of each data row to avoid any reference issues
               const cleanDataRows = dataRows.map(row => {
                  const clonedRow = row.cloneNode(true);
                  
                  // Reset any grouping-related attributes and styling
                  clonedRow.removeAttribute('data-group');
                  clonedRow.classList.remove('first-in-group', 'collapsed-row');
                  clonedRow.style.display = '';
                  
                  // Ensure any row that was hidden is now visible
                  if (row.style.display === 'none') {
                     clonedRow.style.display = '';
                  }
                  
                  return clonedRow;
               });
               
               console.log(`Created ${cleanDataRows.length} clean rows for regrouping`);
               
               // Clear the tbody completely to start fresh
               console.log('Clearing tbody to start fresh');
               while (tbody.firstChild) {
                  tbody.removeChild(tbody.firstChild);
               }
               
               // Re-add all data rows in their original order with clean state
               console.log('Re-adding clean data rows to table');
               cleanDataRows.forEach(row => tbody.appendChild(row));
               
               // Re-apply pagination if it's enabled
               if (table.hasAttribute('data-paginated')) {
                  console.log('Table is paginated, restoring pagination after group reset');
                  // Re-store table data since we've reset the grouping
                  storeTableData(table);
                  // Reset to first page and update
                  table.setAttribute('data-current-page', '1');
                  paginateTable(table);
               }
               
               console.log('Resetting table grouping - COMPLETE');
            } catch (error) {
               console.error('Error in resetGrouping:', error);
            }
         }
         
         function sortTable(table, columnIndex, header) {
            const sortDirection = header.getAttribute('data-sort-direction');
            const newDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            
            // Reset all headers
            const headers = table.querySelectorAll('th');
            headers.forEach(h => {
               h.setAttribute('data-sort-direction', '');
               const indicator = h.querySelector('.sort-indicator');
               if (indicator) indicator.innerHTML = '&nbsp;';
               indicator.style.opacity = '0.6';
            });
            
            // Set current header
            header.setAttribute('data-sort-direction', newDirection);
            const sortIndicator = header.querySelector('.sort-indicator');
            sortIndicator.innerHTML = newDirection === 'asc' ? '&nbsp;' : '&nbsp;';
            sortIndicator.style.opacity = '1';
            
            // Check if table is grouped
            const tbody = table.querySelector('tbody');
            const groupHeaders = tbody.querySelectorAll('.group-header');
            
            if (groupHeaders.length > 0) {
               // Table is grouped, sort within each group
               const groups = {};
               
               // Collect all groups
               groupHeaders.forEach(header => {
                  const groupValue = header.getAttribute('data-group');
                  groups[groupValue] = [];
                  
                  // Find all rows in this group
                  const groupRows = tbody.querySelectorAll(`tr[data-group="${groupValue}"]:not(.group-header)`);
                  groupRows.forEach(row => groups[groupValue].push(row));
                  
                  // Sort rows in this group
                  groups[groupValue].sort((rowA, rowB) => {
                     const cellA = rowA.cells[columnIndex].textContent.trim();
                     const cellB = rowB.cells[columnIndex].textContent.trim();
                     
                     // Check if values are numbers
                     const numA = parseFloat(cellA);
                     const numB = parseFloat(cellB);
                     
                     if (!isNaN(numA) && !isNaN(numB)) {
                        return newDirection === 'asc' ? numA - numB : numB - numA;
                     } else {
                        // String comparison
                        return newDirection === 'asc' 
                           ? cellA.localeCompare(cellB) 
                           : cellB.localeCompare(cellA);
                     }
                  });
                  
                  // Remove existing rows
                  groupRows.forEach(row => {
                     tbody.removeChild(row);
                  });
                  
                  // Insert sorted rows after their group header
                  let insertAfter = header;
                  const isGroupCollapsed = header.classList.contains('collapsed');
                  
                  groups[groupValue].forEach((row, idx) => {
                     // Preserve the collapsed state from the group header
                     if (isGroupCollapsed) {
                        row.classList.add('collapsed-row');
                     } else {
                        row.classList.remove('collapsed-row');
                     }
                     
                     // Add first-in-group class to the first row
                     if (idx === 0) {
                        row.classList.add('first-in-group');
                     } else {
                        row.classList.remove('first-in-group');
                     }
                     
                     if (insertAfter.nextSibling) {
                        tbody.insertBefore(row, insertAfter.nextSibling);
                     } else {
                        tbody.appendChild(row);
                     }
                     insertAfter = row;
                  });
               });
               
            } else {
               // Normal sorting (no groups)
               const rows = Array.from(tbody.querySelectorAll('tr'));
               
               // Sort rows
               rows.sort((rowA, rowB) => {
                  const cellA = rowA.cells[columnIndex].textContent.trim();
                  const cellB = rowB.cells[columnIndex].textContent.trim();
                  
                  // Check if values are numbers
                  const numA = parseFloat(cellA);
                  const numB = parseFloat(cellB);
                  
                  if (!isNaN(numA) && !isNaN(numB)) {
                     return newDirection === 'asc' ? numA - numB : numB - numA;
                  } else {
                     // String comparison
                     return newDirection === 'asc' 
                        ? cellA.localeCompare(cellB) 
                        : cellB.localeCompare(cellA);
                  }
               });
               
               // Remove existing rows
               rows.forEach(row => tbody.removeChild(row));
               
               // Add sorted rows
               rows.forEach(row => tbody.appendChild(row));
            }
            
            // Re-apply pagination if it's enabled
            if (table.hasAttribute('data-paginated')) {
               // Re-store table data since sorting has changed the structure
               storeTableData(table);
               paginateTable(table);
            }
            
            // Add a highlight effect on sorting
            tbody.style.transition = 'background-color 0.3s ease';
            tbody.style.backgroundColor = 'rgba(0, 113, 206, 0.05)';
            setTimeout(() => {
               tbody.style.backgroundColor = '';
            }, 500);
         }
      </script>

      <style>
         :root {
         /* Light Theme */
         --cgd-blue: #0071CE;
         --product-accent: #0071CE;
         --product-accent-hover: #00559A;
         --text-primary: #202124;
         --text-secondary: #5f6368;
         --border-color: #dadce0;
         --background-main: #f8f9fa;
         --background-card: #ffffff;
         --background-hover: #f1f3f4;
         --background-button: #0071CE;
         --background-button-text: #ffffff;
         /* Icon Colors */
         --color-red: #d93025;
         --color-amber: #f9ab00;
         --color-green: #1e8e3e;
         }
        html.dark-mode {
         /* Dark Theme - Improved for better visibility and contrast */
         --product-accent: #4285f4;
         --product-accent-hover: #5294ff;
         --text-primary: #ffffff;
         --text-secondary: #ffffff;
         --border-color: #5f6368;
         --background-main: #1a1a1a;
         --background-card: #2d2d2d;
         --background-hover: #404040;
         --background-button: #4285f4;
         --background-button-text: #ffffff;
         /* Improved Icon Colors for dark mode */
         --color-red: #f28b82;
         --color-amber: #fdd663;
         --color-green: #81c995;
         }
         html {
         color: var(--text-primary);
         background-color: var(--background-main);
         box-sizing: border-box;
         scroll-behavior: smooth;
         }
         *, *::before, *::after { box-sizing: inherit; }
         body {
         margin: 0; padding: 0; width: 100%;
         font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
         font-size: 14px; line-height: 1.6;
         text-rendering: optimizeLegibility;
         overflow-x: hidden;
         text-align: left;
         color: var(--text-primary);
         background-color: var(--background-main);
         transition: background-color 0.3s ease, color 0.3s ease;
         }
         /* --- HEADER --- */
         /* --- READING PROGRESS INDICATOR --- */
         .reading-progress {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 3px;
         background-color: rgba(0, 113, 206, 0.1);
         z-index: 103;
         opacity: 0;
         transition: opacity 0.3s ease;
         }
         .reading-progress.show {
         opacity: 1;
         }
         .reading-progress-fill {
         height: 100%;
         background: linear-gradient(90deg, var(--product-accent) 0%, #00559A 100%);
         width: 0%;
         transition: width 0.1s ease-out;
         border-radius: 0 2px 2px 0;
         box-shadow: 0 0 10px rgba(0, 113, 206, 0.3);
         }
         .reading-progress-text {
         position: fixed;
         top: 8px;
         right: 20px;
         background-color: var(--background-card);
         color: var(--text-secondary);
         font-size: 0.75rem;
         font-weight: 500;
         padding: 0.25rem 0.5rem;
         border-radius: 12px;
         border: 1px solid var(--border-color);
         z-index: 104;
         opacity: 0;
         visibility: hidden;
         transition: all 0.3s ease;
         backdrop-filter: blur(8px);
         }
         .reading-progress-text.show {
         opacity: 1;
         visibility: visible;
         }
         .header {
         background-color: var(--background-card);
         box-shadow: 0 1px 2px rgba(0,0,0,0.1);
         position: sticky;
         top: 0;
         z-index: 102;
         width: 100%;
         border-bottom: 1px solid var(--border-color);
         transition: background-color 0.3s ease, border-color 0.3s ease;
         }
         .header-container {
         display: flex;
         align-items: center;
         justify-content: space-between;
         padding: 0.5rem 1.5rem; /* Reduced padding */
         max-width: 100%;
         margin: 0 auto;
         }
         .header-brand { display: flex; align-items: center; }
         .header-logo { height: 38px; margin-right: 1rem; }
         .header-title { font-size: 18px; font-weight: 600; color: var(--cgd-blue); padding: 0; }
         .header-controls { display: flex; align-items: center; gap: 0.5rem; }
         .support-button {
         background-color: var(--background-button);
         color: var(--background-button-text);
         border: 1px solid transparent;
         border-radius: 4px;
         padding: 8px 16px;
         font-size: 14px;
         font-weight: 500;
         text-decoration: none;
         cursor: pointer;
         transition: background-color 0.2s ease, box-shadow 0.2s ease;
         margin-left: 1rem;
         }
         .support-button:hover {
         background-color: var(--product-accent-hover);
         box-shadow: 0 1px 3px rgba(0,0,0,0.1);
         }
         .icon-button {
         background: none; border: none; cursor: pointer;
         padding: 8px; border-radius: 50%;
         display: inline-flex; align-items: center; justify-content: center;
         color: var(--text-secondary);
         transition: background-color 0.2s ease, color 0.2s ease;
         }
         .icon-button:hover { background-color: var(--background-hover); color: var(--text-primary); }
         .icon-button .icon { margin: 0; vertical-align: -6px; }
         /* --- MAIN CONTENT & TYPOGRAPHY --- */
         .content { max-width: 100%; padding: 0 1.5rem; margin: 0 auto; }
         .product-header {
         background-color: var(--background-card);
         padding: 2rem 1.5rem;
         margin-bottom: 0;
         border-bottom: 1px solid var(--border-color);
         transition: background-color 0.3s ease, border-color 0.3s ease;
         }
         .document-meta {
         display: flex;
         align-items: center;
         gap: 1rem;
         margin-top: 0.5rem;
         color: var(--text-secondary);
         font-size: 0.875rem;
         }
         .read-time { display: flex; align-items: center; gap: 0.25rem; }
         .read-time .icon { font-size: 18px; vertical-align: -4px; }
         h1, h2, h3, h4 { color: var(--text-primary); text-align: left; font-weight: 600; margin-bottom: 1rem; }
         h1 { margin-top: 0; font-size: 2.25rem; padding-bottom: 0.5rem; }
         h2 { font-size: 1.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); transition: border-color 0.3s ease; }
         h3 { font-size: 1.4rem; }
         h4 { font-size: 1.2rem; }
         p { margin: 1rem 0; color: var(--text-secondary); }
         /* --- ICON STYLES --- */
         .icon { font-family: 'Material Symbols Outlined', sans-serif; font-weight: normal; font-style: normal; font-size: 20px; line-height: 1; letter-spacing: normal; text-transform: none; display: inline-block; white-space: nowrap; word-wrap: normal; direction: ltr; -webkit-font-smoothing: antialiased; vertical-align: -5px; margin-right: 0.07em; }
         .icon-high { color: var(--color-red); }
         .icon-medium { color: var(--color-amber); }
         .icon-low { color: var(--color-green); }
         .icon-check { color: var(--color-green); }
         .icon-cross { color: var(--color-red); }
         .icon-question { color: var(--text-secondary); }
         /* --- BREADCRUMB NAVIGATION --- */
         .breadcrumb-container {
         background-color: var(--background-main);
         border-top: 1px solid var(--border-color);
         padding: 0.5rem 1.5rem;
         transition: all 0.3s ease;
         }
         .breadcrumb {
         display: flex;
         align-items: center;
         flex-wrap: wrap;
         gap: 0.5rem;
         font-size: 0.8rem;
         color: var(--text-secondary);
         max-width: 1200px;
         margin: 0 auto;
         }
         .breadcrumb-item {
         display: flex;
         align-items: center;
         gap: 0.25rem;
         }
         .breadcrumb-link {
         color: var(--text-secondary);
         text-decoration: none;
         padding: 0.25rem 0.5rem;
         border-radius: 4px;
         transition: all 0.2s ease;
         cursor: pointer;
         }
         .breadcrumb-link:hover {
         color: var(--product-accent);
         background-color: var(--background-hover);
         }
         .breadcrumb-link.active {
         color: var(--product-accent);
         font-weight: 500;
         background-color: rgba(0, 113, 206, 0.1);
         }
         .breadcrumb-separator {
         color: var(--border-color);
         font-size: 0.75rem;
         margin: 0 0.25rem;
         }
         .breadcrumb-home {
         display: flex;
         align-items: center;
         gap: 0.25rem;
         color: var(--text-secondary);
         text-decoration: none;
         padding: 0.25rem 0.5rem;
         border-radius: 4px;
         transition: all 0.2s ease;
         }
         .breadcrumb-home:hover {
         color: var(--product-accent);
         background-color: var(--background-hover);
         }
         .breadcrumb-home .icon {
         font-size: 16px;
         }
         .breadcrumb-section-info {
         margin-left: auto;
         display: flex;
         align-items: center;
         gap: 1rem;
         font-size: 0.8rem;
         color: var(--text-secondary);
         }
         .breadcrumb-progress {
         display: flex;
         align-items: center;
         gap: 0.25rem;
         }
         .breadcrumb-progress-bar {
         width: 60px;
         height: 4px;
         background-color: var(--border-color);
         border-radius: 2px;
         overflow: hidden;
         }
         .breadcrumb-progress-fill {
         height: 100%;
         background-color: var(--product-accent);
         width: 0%;
         transition: width 0.3s ease;
         }
         /* Mobile adjustments for breadcrumb */
         @media (max-width: 768px) {
         .breadcrumb-container {
         padding: 0.4rem 1rem;
         }
         .breadcrumb {
         font-size: 0.75rem;
         }
         .breadcrumb-section-info {
         display: none;
         }
         .breadcrumb-link {
         padding: 0.2rem 0.4rem;
         }
         }
         @media (max-width: 480px) {
         .breadcrumb-container {
         padding: 0.3rem 1rem;
         }
         .breadcrumb {
         font-size: 0.7rem;
         gap: 0.25rem;
         }
         .breadcrumb-link {
         padding: 0.15rem 0.3rem;
         max-width: 100px;
         overflow: hidden;
         text-overflow: ellipsis;
         white-space: nowrap;
         }
         }
         /* --- TAB STYLES --- */
         .tab-navigation-container {
         position: sticky; top: 62px; /* After header (which now includes breadcrumb) */
         background-color: var(--background-card);
         z-index: 101;
         border-bottom: 1px solid var(--border-color);
         width: 100vw; margin-left: calc(-50vw + 50%);
         transition: background-color 0.3s ease, border-color 0.3s ease;
         }
         .tab-nav-scroller { overflow-x: auto; scrollbar-width: thin; scrollbar-color: var(--border-color) transparent; padding: 0 1.5rem; }
         .tab-navigation { display: flex; flex-wrap: nowrap; white-space: nowrap; margin: 0; padding: 0; list-style: none; }
         .tab-link { padding: 0.75rem 0; margin: 0 1.25rem; cursor: pointer; background: none; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; transition: color 0.2s ease, border-color 0.2s ease; margin-bottom: -1px; text-align: center; }
         
         
         .tab-link:hover { color: var(--product-accent); }
         .tab-link.active { color: var(--product-accent); border-bottom-color: var(--product-accent); }
         .tab-link:first-child { margin-left: 0; } .tab-link:last-child { margin-right: 0; }
         .tab-content { padding-top: 2rem; }
         .tab-pane { display: none; animation: fadeIn 0.5s ease; }
         .tab-pane.active { display: block; }
         .tab-link span {font-weight: 550; }
         @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
         .product-section { margin-bottom: 3rem; background: var(--background-card); border-radius: 8px; border: 1px solid var(--border-color); padding: 0 2rem; transition: background-color 0.3s ease, border-color 0.3s ease; }
         /* --- TABLES --- */
         .table-container { width: 100%; overflow-x: auto; margin: 1.5rem 0; border: 1px solid var(--border-color); border-radius: 8px; transition: border-color 0.3s ease; }
         table { width: 100%; border-collapse: collapse; min-width: 650px; }
         th, td { padding: 12px 16px; text-align: left; vertical-align: middle; font-size: 0.875rem; border-bottom: 1px solid var(--border-color); transition: border-color 0.3s ease;}
         th { background-color: var(--background-main); color: var(--text-primary); font-weight: 500; position: sticky; top: 0; z-index: 10; transition: background-color 0.3s ease, color 0.3s ease; }
         tr:last-child td { border-bottom: none; }
         tr:hover { background-color: var(--background-hover); }
         td strong { color: var(--text-primary); font-weight: 500; }
         td .icon { margin-left: -4px; }

         /* Sortable table styles */
         th[data-sort-direction="asc"],
         th[data-sort-direction="desc"] {
            background-color: rgba(0, 113, 206, 0.1);
         }
         th .sort-indicator {
            transition: transform 0.2s ease, opacity 0.2s ease;
         }
         th:hover .sort-indicator {
            opacity: 1 !important;
         }
         th:hover {
            background-color: rgba(0, 113, 206, 0.05);
         }
         tbody tr.sort-highlight {
            animation: highlightRow 1s ease;
         }
         @keyframes highlightRow {
            0% { background-color: rgba(0, 113, 206, 0.1); }
            100% { background-color: transparent; }
         }
         
         /* Table grouping styles */
         .table-group-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 0px;
            padding: 8px 12px;
            background-color: var(--background-main);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            transition: border-color 0.3s ease, background-color 0.3s ease;
         }
         
         .group-title {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
         }
         
         .group-options {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
         }
         
         .group-option {
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--background-card);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
         }
         
         .group-option:hover {
            background-color: var(--background-hover);
            color: var(--text-primary);
         }
         
         .group-option.active {
            background-color: var(--product-accent);
            color: white;
            border-color: var(--product-accent);
            font-weight: 500;
         }
         
         tr.group-header {
            background-color: rgba(0, 113, 206, 0.08);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            border-radius: 4px;
            border-left: 3px solid rgba(0, 113, 206, 0.6);
         }
         
         tr.group-header:hover {
            background-color: rgba(0, 113, 206, 0.15);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
         }
         
         tr.group-header.collapsed {
            background-color: rgba(0, 113, 206, 0.12);
            border-left-color: rgba(0, 113, 206, 0.6);
            margin-bottom: 0;
            border-bottom: 2px solid rgba(0, 113, 206, 0.4);
            position: relative; /* For the ::after pseudo-element */
         }
         
         tr.group-header.collapsed:hover {
            background-color: rgba(0, 113, 206, 0.18);
         }
         
         /* Add visual indicator of collapsed rows below */
         tr.group-header.collapsed::after {
            content: "";
            height: 3px;
            background: linear-gradient(to right, rgba(0, 113, 206, 0.4), rgba(0, 113, 206, 0.1), transparent);
            display: block;
            position: relative;
            margin-top: 2px;
         }
         
         /* Add a more prominent indicator for collapsed content */
         tr.group-header.collapsed td:first-child {
            position: relative;
         }
         
         tr.group-header.collapsed td:first-child::before {
            content: ""; /* Down-pointing triangle */
            position: absolute;
            right: 10px;
            color: rgba(0, 113, 206, 0.6);
            font-size: 12px;
         }
         
         .group-header-content {
            display: flex;
            align-items: center;
            padding: 4px 0;
            flex-wrap: wrap;
         }
         
         .group-header-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-right: 8px;
         }
         
         .group-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background-color: var(--background-card);
            padding: 2px 8px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
         }
         
         .group-toggle {
            margin-right: 10px;
            transition: all 0.3s ease;
            color: rgba(0, 113, 206, 0.8);
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 113, 206, 0.1);
            width: 26px;
            height: 26px;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            font-size: 18px;
         }
         
         tr.group-header:hover .group-toggle {
            background-color: rgba(0, 113, 206, 0.2);
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
         }
         
         tr.group-header.collapsed .group-toggle {
            transform: rotate(-90deg);
            color: rgba(0, 113, 206, 0.6);
            background-color: rgba(0, 113, 206, 0.05);
         }
         
         /* Simplify the animation */
         tr.group-header.collapsed:hover .group-toggle {
            background-color: rgba(0, 113, 206, 0.15);
            transform: rotate(-90deg) scale(1.05);
         }
         
         /* Styles for grouped rows */
         tr[data-group] {
            transition: all 0.3s ease;
         }
         
         /* Collapsed rows - completely hidden */
         tbody tr.collapsed-row {
            display: none !important;
         }
         
         tr.first-in-group {
            border-top: 1px solid rgba(0, 113, 206, 0.1);
         }
         
         @media (max-width: 768px) {
            .table-group-controls {
               flex-direction: column;
               align-items: flex-start;
               gap: 8px;
            }
            
            .group-options {
               width: 100%;
            }
         }
         
         /* Table Pagination Styles */
         .table-pagination {
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 0.75rem;
         }
         
         .pagination-top-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-left:12px;
            padding-right: 12px;
         }
         
         .page-size-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
         }
         
         .page-size-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
         }
         
         .page-size-select {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--background-card);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
         }
         
         .page-size-select:focus {
            outline: none;
            border-color: var(--product-accent);
            box-shadow: 0 0 0 2px rgba(0, 113, 206, 0.1);
         }
         
         .pagination-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
         }
         
         .pagination-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            padding: 8px 0;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
         }
         
         .pagination-button {
            min-width: 36px;
            height: 36px;
            padding: 0;
            border: none;
            border-radius: 4px;
            background-color: transparent;
            color: var(--product-accent);
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin: 0 2px;
         }
         
         .pagination-button:hover:not(:disabled) {
            background-color: rgba(0, 113, 206, 0.08);
            color: var(--product-accent);
         }
         
         .pagination-button {
            background-color: var(--product-accent);
            color: white;
            font-weight: 500;
         }
         
         /* Navigation buttons styling */
         .pagination-button.prev,
         .pagination-button.next,
         .pagination-button.first,
         .pagination-button.last {
            background-color: transparent;
            border-radius: 50%;
         }
         
         /* Number buttons styling */
         .pagination-button.page-number {
            font-family: 'Roboto', Arial, sans-serif;
            font-weight: 500;
         }
         
         .pagination-button.ellipsis {
            cursor: default;
            min-width: 24px;
         }
         
         .pagination-button.ellipsis:hover {
            background-color: transparent;
         }
         
         .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: var(--text-secondary);
         }
         
         .pagination-button.prev,
         .pagination-button.next,
         .pagination-button.first,
         .pagination-button.last {
            background-color: transparent;
            border: none;
         }
         
         .pagination-button.prev:hover:not(:disabled),
         .pagination-button.next:hover:not(:disabled),
         .pagination-button.first:hover:not(:disabled),
         .pagination-button.last:hover:not(:disabled) {
            background-color: rgba(0, 113, 206, 0.08);
            border: none;
         }
         
         .pagination-button .icon {
            font-size: 20px;
            margin: 0;
            font-family: 'Material Symbols Outlined', sans-serif !important;
            vertical-align: middle;
            font-style: normal;
         }
         
         .icon {
            font-family: 'Material Symbols Outlined', sans-serif !important;
            font-weight: normal;
            font-style: normal;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;
            display: inline-block;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
         }
         
         /* Ensure Material Symbols are properly applied */
         span.material-symbols-outlined,
         .material-symbols-outlined {
            font-family: 'Material Symbols Outlined', sans-serif !important;
            font-weight: normal;
            font-style: normal;
            font-size: 20px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            font-feature-settings: 'liga';
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
         }
         
         .pagination-button.ellipsis {
            cursor: default;
            color: var(--text-secondary);
         }
         
         .pagination-button.ellipsis:hover {
            background-color: transparent;
         }
         
         /* Mobile adjustments for pagination */
         @media (max-width: 768px) {
            .pagination-top-controls {
               flex-direction: column;
               align-items: flex-start;
               gap: 0.5rem;
            }
            
            .pagination-info {
               margin-top: 0.25rem;
            }
            
            .pagination-button {
               min-width: 32px;
               height: 32px;
            }
         }
         
         @media (max-width: 480px) {
            .pagination-button:not(.prev):not(.next):not(.active):not(.first):not(.last) {
               display: none;
            }
            
            .pagination-button.ellipsis:first-of-type,
            .pagination-button.ellipsis:last-of-type {
               display: flex;
            }
            
            .pagination-nav {
               width: 100%;
               justify-content: space-between;
            }
         }
         /* --- FLOATING TABLE OF CONTENTS --- */
         .floating-toc {
         position: fixed;
         top: 50%;
         right: 20px;
         transform: translateY(-50%);
         background-color: var(--background-card);
         border: 1px solid var(--border-color);
         border-radius: 12px;
         padding: 1rem;
         max-width: 280px;
         min-width: 240px;
         max-height: 70vh;
         overflow-y: auto;
         z-index: 1001;
         box-shadow: 0 8px 32px rgba(0,0,0,0.12);
         opacity: 0;
         visibility: hidden;
         transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
         backdrop-filter: blur(8px);
         }
         .floating-toc.show {
         opacity: 1;
         visibility: visible;
         }
         .floating-toc-header {
         display: flex;
         align-items: center;
         justify-content: space-between;
         margin-bottom: 1rem;
         padding-bottom: 0.5rem;
         border-bottom: 1px solid var(--border-color);
         }
         .floating-toc-title {
         font-size: 0.875rem;
         font-weight: 600;
         color: var(--text-primary);
         display: flex;
         align-items: center;
         gap: 0.5rem;
         }
         .floating-toc-close {
         background: none;
         border: none;
         cursor: pointer;
         padding: 4px;
         border-radius: 4px;
         color: var(--text-secondary);
         transition: background-color 0.2s ease, color 0.2s ease;
         }
         .floating-toc-close:hover {
         background-color: var(--background-hover);
         color: var(--text-primary);
         }
         .floating-toc-list {
         list-style: none;
         padding: 0;
         margin: 0;
         }
         .floating-toc-item {
         margin-bottom: 0.5rem;
         }
         .floating-toc-link {
         display: block;
         padding: 0.5rem 0.75rem;
         text-decoration: none;
         color: var(--text-secondary);
         font-size: 0.8rem;
         line-height: 1.4;
         border-radius: 6px;
         transition: all 0.2s ease;
         cursor: pointer;
         position: relative;
         border-left: 3px solid transparent;
         }
         .floating-toc-link:hover {
         background-color: var(--background-hover);
         color: var(--text-primary);
         }
         .floating-toc-link.active {
         background-color: rgba(0, 113, 206, 0.1);
         color: var(--product-accent);
         border-left-color: var(--product-accent);
         font-weight: 500;
         }
         .floating-toc-progress {
         position: absolute;
         right: 0.5rem;
         top: 50%;
         transform: translateY(-50%);
         width: 20px;
         height: 20px;
         border-radius: 50%;
         background-color: var(--border-color);
         border: 2px solid var(--background-card);
         transition: all 0.2s ease;
         }
         .floating-toc-link.active .floating-toc-progress {
         background-color: var(--product-accent);
         }
         .floating-toc-progress-fill {
         position: absolute;
         top: 2px;
         left: 2px;
         right: 2px;
         bottom: 2px;
         border-radius: 50%;
         background-color: var(--product-accent);
         transform: scale(0);
         transition: transform 0.2s ease;
         }
         .floating-toc-link.reading .floating-toc-progress-fill {
         transform: scale(1);
         }
         .floating-toc-toggle {
         position: fixed;
         top: 50%;
         right: 20px;
         transform: translateY(-50%);
         background-color: var(--product-accent);
         color: var(--background-button-text);
         border: none;
         border-radius: 50%;
         width: 48px;
         height: 48px;
         display: flex;
         align-items: center;
         justify-content: center;
         cursor: pointer;
         z-index: 1002;
         box-shadow: 0 4px 16px rgba(0,0,0,0.15);
         opacity: 0;
         visibility: hidden;
         transition: all 0.3s ease;
         }
         .floating-toc-toggle.show {
         opacity: 1;
         visibility: visible;
         }
         .floating-toc-toggle:hover {
         background-color: var(--product-accent-hover);
         transform: translateY(-50%) scale(1.05);
         }
         /* --- FULL-SCREEN READING MODE --- */
         .fullscreen-reading-mode {
         position: fixed;
         top: 0;
         left: 0;
         right: 0;
         bottom: 0;
         background-color: var(--background-main);
         z-index: 2000;
         overflow-y: auto;
         padding: 2rem;
         opacity: 0;
         visibility: hidden;
         transition: opacity 0.3s ease, visibility 0.3s ease;
         }
         .fullscreen-reading-mode.active {
         opacity: 1;
         visibility: visible;
         }
         .fullscreen-reading-content {
         max-width: 800px;
         margin: 0 auto;
         line-height: 1.8;
         font-size: 1.1rem;
         color: var(--text-primary);
         }
         .fullscreen-reading-content h2 {
         font-size: 2rem;
         margin-bottom: 1.5rem;
         color: var(--text-primary);
         border-bottom: 2px solid var(--product-accent);
         padding-bottom: 0.5rem;
         }
         .fullscreen-reading-content h3 {
         font-size: 1.5rem;
         margin-top: 2rem;
         margin-bottom: 1rem;
         color: var(--text-primary);
         }
         .fullscreen-reading-content h4 {
         font-size: 1.25rem;
         margin-top: 1.5rem;
         margin-bottom: 0.75rem;
         color: var(--text-primary);
         }
         .fullscreen-reading-content p {
         margin-bottom: 1.5rem;
         text-align: justify;
         color: var(--text-secondary);
         }
         .fullscreen-reading-content table {
         margin: 2rem 0;
         font-size: 0.95rem;
         }
         .fullscreen-reading-controls {
         position: fixed;
         top: 20px;
         right: 20px;
         display: flex;
         gap: 0.5rem;
         z-index: 2001;
         }
         .fullscreen-reading-control {
         background-color: var(--background-card);
         border: 1px solid var(--border-color);
         border-radius: 8px;
         padding: 0.5rem;
         cursor: pointer;
         color: var(--text-secondary);
         transition: all 0.2s ease;
         backdrop-filter: blur(8px);
         }
         .fullscreen-reading-control:hover {
         background-color: var(--background-hover);
         color: var(--text-primary);
         }
         .fullscreen-reading-exit {
         background-color: var(--product-accent);
         color: var(--background-button-text);
         }
         .fullscreen-reading-exit:hover {
         background-color: var(--product-accent-hover);
         }
         .fullscreen-reading-progress {
         position: fixed;
         bottom: 20px;
         left: 50%;
         transform: translateX(-50%);
         background-color: var(--background-card);
         border: 1px solid var(--border-color);
         border-radius: 20px;
         padding: 0.5rem 1rem;
         font-size: 0.875rem;
         color: var(--text-secondary);
         backdrop-filter: blur(8px);
         z-index: 2001;
         }
         .fullscreen-font-controls {
         position: fixed;
         top: 20px;
         left: 20px;
         display: flex;
         gap: 0.5rem;
         z-index: 2001;
         }
         .fullscreen-font-control {
         background-color: var(--background-card);
         border: 1px solid var(--border-color);
         border-radius: 8px;
         padding: 0.5rem;
         cursor: pointer;
         color: var(--text-secondary);
         transition: all 0.2s ease;
         backdrop-filter: blur(8px);
         min-width: 40px;
         text-align: center;
         }
         .fullscreen-font-control:hover {
         background-color: var(--background-hover);
         color: var(--text-primary);
         }
         /* Hide UI elements when in fullscreen reading mode */
         body.fullscreen-reading .header,
         body.fullscreen-reading .product-header,
         body.fullscreen-reading .tab-navigation-container,
         body.fullscreen-reading .footer,
         body.fullscreen-reading .floating-toc,
         body.fullscreen-reading .floating-toc-toggle,
         body.fullscreen-reading #back-to-top,
         body.fullscreen-reading .reading-progress,
         body.fullscreen-reading .reading-progress-text {
         display: none !important;
         }
         /* Mobile adjustments for fullscreen reading */
         @media (max-width: 768px) {
         .fullscreen-reading-mode {
         padding: 1rem;
         }
         .fullscreen-reading-content {
         font-size: 1rem;
         line-height: 1.7;
         }
         .fullscreen-reading-controls {
         top: 10px;
         right: 10px;
         }
         .fullscreen-font-controls {
         top: 10px;
         left: 10px;
         }
         .fullscreen-reading-progress {
         bottom: 10px;
         padding: 0.4rem 0.8rem;
         font-size: 0.8rem;
         }
         }
         /* Hide TOC on smaller screens */
         @media (max-width: 1024px) {
         .floating-toc,
         .floating-toc-toggle {
         display: none !important;
         }
         }
         
         /* Mobile adjustments for reading progress */
         @media (max-width: 768px) {
         .reading-progress-text {
         right: 10px;
         top: 6px;
         font-size: 0.7rem;
         padding: 0.2rem 0.4rem;
         }
         }
         
         @media (max-width: 480px) {
         .reading-progress-text {
         right: 5px;
         top: 4px;
         font-size: 0.65rem;
         padding: 0.15rem 0.3rem;
         max-width: 120px;
         text-overflow: ellipsis;
         overflow: hidden;
         white-space: nowrap;
         }
         }
         /* --- MISC & FOOTER --- */
         .ai-disclaimer { text-align: center; font-style: italic; color: var(--text-secondary); font-size: 0.875rem; margin: -1rem auto -2rem; padding: 0 1rem; line-height: 1.5; }
         #back-to-top {
         position: fixed; bottom: 20px; left: 20px;
         background-color: var(--product-accent); color: var(--background-button-text);
         border: none; border-radius: 50%;
         width: 50px; height: 50px;
         display: none; align-items: center; justify-content: center;
         cursor: pointer; z-index: 1000;
         box-shadow: 0 4px 8px rgba(0,0,0,0.2);
         opacity: 0;
         transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
         }
         #back-to-top.show { opacity: 1; display: flex; }
         #back-to-top:hover { background-color: var(--product-accent-hover); transform: translateY(-2px); }
         .footer { background-color: var(--background-card); color: var(--text-secondary); padding: 2rem 1.5rem; margin-top: 4rem; text-align: center; border-top: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease;}
         .footer-container { max-width: 1440px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
         .footer-brand { display: flex; align-items: center; gap: 1rem; }
         .footer-logo { height: 32px; }
         .footer-wordmark { font-size: 1rem; font-weight: 500; color: var(--cgd-blue); }
         .footer-copyright { font-size: 0.8rem; }
         .footer-socials { display: flex; gap: 1rem; }
         .footer-socials a { color: var(--text-secondary); text-decoration: none; display: inline-block; transition: color 0.2s ease, transform 0.2s ease; }
         .footer-socials a:hover { color: var(--product-accent); transform: scale(1.1); }
         .footer-socials svg { width: 24px; height: 24px; fill: currentColor; }
         @media (max-width: 768px) {
         .content, .product-header { padding-left: 1rem; padding-right: 1rem; }
         .footer-container { flex-direction: column; text-align: center; gap: 1.5rem; }
         }
         @media print {
         /* Print styles remain largely the same */
         .header, .footer, .tab-navigation-container, .ai-disclaimer, #back-to-top, .header-controls { display: none !important; }
         }
      </style>
   </head>
   <body>
      <!-- Reading Progress Indicator -->
      <div id="reading-progress" class="reading-progress">
         <div id="reading-progress-fill" class="reading-progress-fill"></div>
      </div>
      <div id="reading-progress-text" class="reading-progress-text">
         0% read
      </div>
      
      <header class="header">
         <div class="header-container">
            <div class="header-brand">
               <img src="https://www.cgd.pt/PublishingImages/WSImages/Novo-CGD/logo-ap_Blue.png" alt="CGD Logo" class="header-logo">
            </div>
            <div class="header-controls">
               <div id="tts-controls" style="display: none;">
                  <button id="tts-play-pause-btn" class="icon-button" title="Listen to this section">
                  <span class="icon">play_arrow</span>
                  </button>
                  <button id="tts-stop-btn" class="icon-button" title="Stop listening">
                  <span class="icon">stop</span>
                  </button>
               </div>
               <button id="fullscreen-reading-btn" class="icon-button" title="Enter fullscreen reading mode">
               <span class="icon">fullscreen</span>
               </button>
               <button id="dark-mode-toggle" class="icon-button" title="Toggle dark/light mode">
               <span class="icon">light_mode</span>
               </button>
               <a href="mailto:david.alexandre.rosa@cgd.pt?subject=Support Request for Application Technical Profile&cc=dsi-arquitetura_empresarial@cgd.pt" target="_blank" class="support-button">Ask for Support</a>
            </div>
         </div>
         
         <!-- Breadcrumb Navigation integrated in header -->
         <div id="breadcrumb-container" class="breadcrumb-container">
            <nav class="breadcrumb" aria-label="Breadcrumb navigation">
               <a href="#" id="breadcrumb-home" class="breadcrumb-home" title="Go to overview">
                  <span class="icon">home</span>
                  <span>Overview</span>
               </a>
               <span class="breadcrumb-separator"></span>
               <div id="breadcrumb-current" class="breadcrumb-item">
                  <span class="breadcrumb-link active">Current Section</span>
               </div>
               <div class="breadcrumb-section-info">
                  <div class="breadcrumb-progress">
                     <span class="icon">trending_up</span>
                     <div class="breadcrumb-progress-bar">
                        <div id="breadcrumb-progress-fill" class="breadcrumb-progress-fill"></div>
                     </div>
                     <span id="breadcrumb-progress-text">0%</span>
                  </div>
                  <div id="breadcrumb-section-count">
                     Section 1 of 13
                  </div>
               </div>
            </nav>
         </div>
      </header>
      
      <div class="product-header">
         <h1 id="application-technical-profile">Application Technical Profile</h1>
         <p style="font-size: 16px">A structured and in-depth technical overview of the application, capturing key architectural elements, technology stack, system components, and more. This profile serves as a foundational reference for modernization, migration, and governance initiatives.</p>
         <div class="document-meta">
            <div class="read-time" id="total-read-time">
               <span class="icon">schedule</span>
               <span>Calculating...</span>
            </div>
         </div>
      </div>
      <div id="tab-container-placeholder"></div>
      
      <main class="content" id="main-content-area">
<div class="product-section">
<h2 id="1-application-overview">1. Application overview</h2>
This section provides a high-level summary of the application, including its purpose, scope, and key technical attributes as inferred from the provided source code.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Acronym</strong></td>
<td style="text-align: left;">SDCIM</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Application name</strong></td>
<td style="text-align: left;">Image Concentrator (Concentrador de Imagens)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Primary business purpose</strong></td>
<td style="text-align: left;">A back-office system for processing banking documents and remittances from branches, including image handling, transaction management, and operational monitoring.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Business domain</strong></td>
<td style="text-align: left;">Banking, Financial Document Processing, Remittance Management</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Solution files</strong></td>
<td style="text-align: left;">2 solutions found: <code>CIControloComSetup.sln</code>, <code>CIControloSemSetup.sln</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Project files</strong></td>
<td style="text-align: left;">18 projects found in <code>CIControloSemSetup.sln</code>: <code>Alerta.csproj</code>, <code>CIActividades.csproj</code>, <code>CIConfigGlobalParameters.csproj</code>, <code>CIConfiguration.csproj</code>, <code>CIControlo.csproj</code>, <code>CIFicheiro.csproj</code>, <code>CIFicheirosControlo.csproj</code>, <code>CIReports.csproj</code>, <code>CIServAlertas.csproj</code>, <code>CIServRemessas.csproj</code>, <code>CIServico.csproj</code>, <code>CIServTester.csproj</code>, <code>CITestes.csproj</code>, <code>MDIsControlo.csproj</code>, <code>MDIWebTransmCI.vbproj</code>, <code>QueryForm.csproj</code>, <code>CIDepositoErro.csproj</code>, <code>SetupCIControlo.vdproj</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Files</strong></td>
<td style="text-align: left;">100 files analyzed: 60 C# source files (<code>.cs</code>), 3 Visual Basic .NET source files (<code>.vb</code>), 18 C# project files (<code>.csproj</code>), 1 Visual Basic .NET project file (<code>.vbproj</code>), 2 Solution files (<code>.sln</code>), 12 resource files (<code>.resx</code>), 4 configuration files (<code>.config</code>), 5 SQL script files (<code>.sql</code>), 3 batch script files (<code>.bat</code>)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Main programming language(s)</strong></td>
<td style="text-align: left;">C#, VB.NET</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Target .NET Framework(s)</strong></td>
<td style="text-align: left;">.NET Framework 4.0, .NET Framework 3.5</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Application type</strong></td>
<td style="text-align: left;">Hybrid: Windows Forms Application, Windows Service, Class Libraries</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Output type</strong></td>
<td style="text-align: left;">.exe (Executable), .dll (Dynamic Link Library)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Deployment model</strong></td>
<td style="text-align: left;">On-premises</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Deployment target platform</strong></td>
<td style="text-align: left;">AnyCPU</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Complexity</strong></td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Last updated (Source code)</strong></td>
<td style="text-align: left;">2008 (based on copyright notices)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Last updated (Documentation)</strong></td>
<td style="text-align: left;">2025-08-06</td>
</tr>
</tbody>
</table>
</div>
<h3 id="11-main-components-and-features">1.1. Main components and features</h3>
The application is decomposed into several logical components, each responsible for a distinct functional area. These components work together to provide a comprehensive solution for processing and managing bank remittances.
<div class="table-container">
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Component</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Key features</th>
<th style="text-align: left;">Dependencies</th>
<th style="text-align: left;">Related projects</th>
<th style="text-align: left;">Technologies</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>UI & Activities</strong></td>
<td style="text-align: left;">Provides the graphical user interface for monitoring and manual intervention in the remittance and document processing lifecycle.</td>
<td style="text-align: left;">- View remittance summaries and details<br>- View document images<br>- Manual state changes for remittances and tranches<br>- User-driven data filtering</td>
<td style="text-align: left;"><code>CIConfigGlobalParameters</code>, <code>NBIISNET</code></td>
<td style="text-align: left;"><code>CIActividades.csproj</code></td>
<td style="text-align: left;">Windows Forms, C#</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Remittance Service</strong></td>
<td style="text-align: left;">Core background service for processing remittances. It orchestrates the workflow from ingestion to completion.</td>
<td style="text-align: left;">- Polling for new remittances to process<br>- Managing remittance states (e.g., open, processing, closed)<br>- Creating and managing tranches (batches) of documents</td>
<td style="text-align: left;"><code>CIConfigGlobalParameters</code>, <code>Alerta</code></td>
<td style="text-align: left;"><code>CIServRemessas.csproj</code>, <code>CIServico.csproj</code></td>
<td style="text-align: left;">C#, Windows Service</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Alerting System</strong></td>
<td style="text-align: left;">Manages system-wide alerts and notifications based on predefined situations and triggers.</td>
<td style="text-align: left;">- Sending email notifications (EWS, WebDAV)<br>- Logging alerts to the database, event viewer, or files<br>- SMS notifications (inferred from enum)</td>
<td style="text-align: left;"><code>CIConfigGlobalParameters</code></td>
<td style="text-align: left;"><code>Alerta.csproj</code></td>
<td style="text-align: left;">C#, System.Data.SqlClient</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Configuration</strong></td>
<td style="text-align: left;">Manages application settings, including user permissions, balco (branch) configurations, and operational parameters.</td>
<td style="text-align: left;">- User and group management<br>- Branch and machine configuration<br>- System parameter adjustments (e.g., timers, thresholds)</td>
<td style="text-align: left;"><code>CIConfigGlobalParameters</code></td>
<td style="text-align: left;"><code>CIConfiguration.csproj</code></td>
<td style="text-align: left;">Windows Forms, C#</td>
</tr>
<tr>
<td style="text-align: left;"><strong>File Processing</strong></td>
<td style="text-align: left;">Handles the ingestion and parsing of external data files, such as <code>ACOM</code> and <code>ENVM</code> files.</td>
<td style="text-align: left;">- Reading and parsing fixed-format files<br>- Backing up processed files<br>- Deleting old files based on retention policies</td>
<td style="text-align: left;"><code>CIConfigGlobalParameters</code></td>
<td style="text-align: left;"><code>CIFicheiro.csproj</code>, <code>CIFicheirosControlo.csproj</code></td>
<td style="text-align: left;">C#</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Reporting</strong></td>
<td style="text-align: left;">Generates business and operational reports based on the processed data.</td>
<td style="text-align: left;">- Monthly billing reports<br>- Remittance and lot listings<br>- Summary reports for ACOM and envios (shipments)</td>
<td style="text-align: left;"><code>CrystalDecisions</code>, <code>CIConfigGlobalParameters</code></td>
<td style="text-align: left;"><code>CIReports.csproj</code></td>
<td style="text-align: left;">Crystal Reports, C#</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Access & Parameters</strong></td>
<td style="text-align: left;">Centralizes database connection management and global application parameters.</td>
<td style="text-align: left;">- Provides a shared <code>CIGlobalParameters</code> object<br>- Manages user session information<br>- Handles direct SQL execution</td>
<td style="text-align: left;"><code>GenericNet</code>, <code>GenericLogNET</code>, <code>NBIISNET</code></td>
<td style="text-align: left;"><code>CIConfigGlobalParameters.csproj</code></td>
<td style="text-align: left;">C#</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>flowchart TD
    subgraph User_Interfaces
        UI_Controlo["CIControlo (Main UI)"]
        UI_Actividades["CIActividades (Activity Forms)"]
        UI_Config["CIConfiguration (Admin UI)"]
    end

    subgraph Backend_Services
        Service["CIServico (Windows Service)"]
        RemessaService["CIServRemessas (Remittance Logic)"]
        AlertService["CIServAlertas (Alerting Logic)"]
        FileProcessor["CIFicheiro (File Processing)"]
    end

    subgraph Core_Libraries
        Alerta["Alerta (Alerting Models)"]
        ConfigParams["CIConfigGlobalParameters (Shared Config)"]
        Reports["CIReports (Crystal Reports)"]
    end
    
    subgraph External_Systems
        Database["(database) SQL Server"]
        FileSystem["(filesystem) File System (ACOM/ENVM files)"]
        Email["(service) Email Gateway (EWS/WebDAV)"]
    end

    UI_Controlo --> Service
    UI_Actividades --> RemessaService
    UI_Config --> ConfigParams
    
    Service --> RemessaService
    Service --> AlertService
    Service --> FileProcessor

    RemessaService --> Alerta
    RemessaService --> Database
    AlertService --> Alerta
    AlertService --> Email
    FileProcessor --> Database
    FileProcessor --> FileSystem
    
    UI_Controlo -.-> ConfigParams
    UI_Actividades -.-> ConfigParams
    RemessaService -.-> ConfigParams
    AlertService -.-> ConfigParams
    FileProcessor -.-> ConfigParams
    Reports -.-> Database
</code></pre>
<center><sub>Figure 1 - High-level component diagram showing the main modules and their interactions.</sub></center>
<h3 id="12-solutions">1.2. Solutions</h3>
The codebase is organized into two main solution files, likely representing development with and without the setup project.
<div class="table-container">
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Solution</th>
<th style="text-align: left;">Projects</th>
<th style="text-align: left;">Visual Studio Version</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong><code>CIControloComSetup.sln</code></strong></td>
<td style="text-align: left;">- <code>Alerta.csproj</code><br>- <code>CIActividades.csproj</code><br>- <code>CIConfigGlobalParameters.csproj</code><br>- <code>CIConfiguration.csproj</code><br>- <code>CIControlo.csproj</code><br>- <code>CIFicheiro.csproj</code><br>- <code>CIFicheirosControlo.csproj</code><br>- <code>CIReports.csproj</code><br>- <code>CIServAlertas.csproj</code><br>- <code>CIServRemessas.csproj</code><br>- <code>CIServico.csproj</code><br>- <code>CIServTester.csproj</code><br>- <code>MDIsControlo.csproj</code><br>- <code>MDIWebTransmCI.vbproj</code><br>- <code>QueryForm.csproj</code><br>- <code>SetupCIControlo.vdproj</code></td>
<td style="text-align: left;">2010</td>
</tr>
<tr>
<td style="text-align: left;"><strong><code>CIControloSemSetup.sln</code></strong></td>
<td style="text-align: left;">- <code>Alerta.csproj</code><br>- <code>CIActividades.csproj</code><br>- <code>CIConfigGlobalParameters.csproj</code><br>- <code>CIConfiguration.csproj</code><br>- <code>CIControlo.csproj</code><br>- <code>CIFicheiro.csproj</code><br>- <code>CIFicheirosControlo.csproj</code><br>- <code>CIReports.csproj</code><br>- <code>CIServAlertas.csproj</code><br>- <code>CIServRemessas.csproj</code><br>- <code>CIServico.csproj</code><br>- <code>CIServTester.csproj</code><br>- <code>CITestes.csproj</code><br>- <code>MDIsControlo.csproj</code><br>- <code>MDIWebTransmCI.vbproj</code><br>- <code>QueryForm.csproj</code><br>- <code>CIDepositoErro.csproj</code></td>
<td style="text-align: left;">2010</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>mindmap
  root((Solutions))
    CIControloComSetup.sln
      CIControlo
      CIConfiguration
      CIActividades
      CIReports
      CIServico
      MDIsControlo
      MDIWebTransmCI
      SetupCIControlo
    CIControloSemSetup.sln
      CIControlo
      CIConfiguration
      CIActividades
      CIReports
      CIServico
      MDIsControlo
      MDIWebTransmCI
      CITestes
      CIDepositoErro
</code></pre>
<center><sub>Figure 2 - Mindmap illustrating the project structure within the two main solutions.</sub></center>
<h3 id="13-projects">1.3. Projects</h3>
The application is highly modular, with responsibilities separated into distinct projects. The main executable projects are <code>CIControlo.csproj</code> (the UI) and <code>CIServico.csproj</code> (the background service).
<div class="table-container">
<table>
<colgroup>
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Solution</th>
<th style="text-align: left;">Project</th>
<th style="text-align: left;">Main objectives</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Output type</th>
<th style="text-align: left;">Version</th>
<th style="text-align: left;">Runtime</th>
<th style="text-align: left;">Framework</th>
<th style="text-align: left;">Architecture</th>
<th style="text-align: left;">Compilation mode</th>
<th style="text-align: left;">Principal classes</th>
<th style="text-align: left;">Internal dependencies</th>
<th style="text-align: left;">External dependencies</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">CIControloSemSetup.sln</td>
<td style="text-align: left;"><strong><code>CIControlo.csproj</code></strong></td>
<td style="text-align: left;">Main entry point for the user-facing application. Acts as an MDI container for various forms.</td>
<td style="text-align: left;">Windows Application</td>
<td style="text-align: left;">Executable</td>
<td style="text-align: left;">1.0.0.0</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">.NET Framework 4.0</td>
<td style="text-align: left;">AnyCPU</td>
<td style="text-align: left;">Debug/Release</td>
<td style="text-align: left;"><code>CIMainForm</code>, <code>Program</code></td>
<td style="text-align: left;"><code>CIActividades</code>, <code>CIConfig...</code>, <code>CIConfiguration</code>, <code>CIFicheirosControlo</code>, <code>CIReports</code>, <code>CIServTester</code>, <code>MDIsControlo</code>, <code>QueryForm</code></td>
<td style="text-align: left;"><code>GenericNet</code>, <code>NBIISNET</code></td>
</tr>
<tr>
<td style="text-align: left;">CIControloSemSetup.sln</td>
<td style="text-align: left;"><strong><code>CIServico.csproj</code></strong></td>
<td style="text-align: left;">Windows service for background processing of remittances and alerts.</td>
<td style="text-align: left;">Windows Service</td>
<td style="text-align: left;">Executable</td>
<td style="text-align: left;">1.0.0.0</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">.NET Framework 4.0</td>
<td style="text-align: left;">AnyCPU</td>
<td style="text-align: left;">Debug/Release</td>
<td style="text-align: left;"><code>CIServico</code>, <code>CIServiceComumThread</code></td>
<td style="text-align: left;"><code>Alerta</code>, <code>CIConfig...</code>, <code>CIFicheiro</code>, <code>CIServAlertas</code>, <code>CIServRemessas</code></td>
<td style="text-align: left;"><code>GenericNet</code>, <code>NBIISNET</code></td>
</tr>
<tr>
<td style="text-align: left;">CIControloSemSetup.sln</td>
<td style="text-align: left;"><strong><code>CIActividades.csproj</code></strong></td>
<td style="text-align: left;">Contains the Windows Forms for monitoring and managing activities, such as remittances and documents.</td>
<td style="text-align: left;">Class Library</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">1.0.0.0</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">.NET Framework 4.0</td>
<td style="text-align: left;">AnyCPU</td>
<td style="text-align: left;">Debug/Release</td>
<td style="text-align: left;"><code>ActividadesForm</code>, <code>ActividadeBalcaoForm</code></td>
<td style="text-align: left;"><code>Alerta</code>, <code>CIConfig...</code></td>
<td style="text-align: left;"><code>GenericNet</code>, <code>NBIISNET</code>, <code>CrystalDecisions</code></td>
</tr>
<tr>
<td style="text-align: left;">CIControloSemSetup.sln</td>
<td style="text-align: left;"><strong><code>CIServRemessas.csproj</code></strong></td>
<td style="text-align: left;">Implements the core business logic for processing remittances and their associated tranches.</td>
<td style="text-align: left;">Class Library</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">1.0.0.0</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">.NET Framework 4.0</td>
<td style="text-align: left;">AnyCPU</td>
<td style="text-align: left;">Debug/Release</td>
<td style="text-align: left;"><code>ServRemessa</code></td>
<td style="text-align: left;"><code>Alerta</code>, <code>CIActividades</code>, <code>CIConfig...</code></td>
<td style="text-align: left;"><code>GenericNet</code>, <code>NBIISNET</code></td>
</tr>
<tr>
<td style="text-align: left;">CIControloSemSetup.sln</td>
<td style="text-align: left;"><strong><code>Alerta.csproj</code></strong></td>
<td style="text-align: left;">Defines the data models and logic for the application's alerting system.</td>
<td style="text-align: left;">Class Library</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">1.0.0.0</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">.NET Framework 4.0</td>
<td style="text-align: left;">AnyCPU</td>
<td style="text-align: left;">Debug/Release</td>
<td style="text-align: left;"><code>Accao</code>, <code>AlertaSituacaoAccao</code></td>
<td style="text-align: left;"><code>CIConfig...</code></td>
<td style="text-align: left;"><code>GenericNet</code>, <code>System.Data.SqlClient</code></td>
</tr>
<tr>
<td style="text-align: left;">CIControloSemSetup.sln</td>
<td style="text-align: left;"><strong><code>CITestes.csproj</code></strong></td>
<td style="text-align: left;">Unit and integration tests for the service layer.</td>
<td style="text-align: left;">Test Project</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">1.0.0.0</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">.NET Framework 3.5</td>
<td style="text-align: left;">AnyCPU</td>
<td style="text-align: left;">Debug/Release</td>
<td style="text-align: left;"><code>CIServRemessaTestes</code></td>
<td style="text-align: left;"><code>CIConfig...</code>, <code>CIControlo</code>, <code>CIServico</code>, <code>CIServRemessas</code>, <code>CIServTester</code></td>
<td style="text-align: left;"><code>Microsoft.VisualStudio.TestTools.UnitTesting</code></td>
</tr>
<tr>
<td style="text-align: left;">CIControloSemSetup.sln</td>
<td style="text-align: left;"><strong><code>MDIWebTransmCI.vbproj</code></strong></td>
<td style="text-align: left;">A VB.NET project for consuming a SOAP web service related to MDI document insertion.</td>
<td style="text-align: left;">Class Library</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">1.0.0.0</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">.NET Framework 4.0</td>
<td style="text-align: left;">AnyCPU</td>
<td style="text-align: left;">Debug/Release</td>
<td style="text-align: left;"><code>TInsertDoc</code></td>
<td style="text-align: left;"><code>CIConfig...</code></td>
<td style="text-align: left;"><code>System.Web.Services</code></td>
</tr>
<tr>
<td style="text-align: left;">CIControloSemSetup.sln</td>
<td style="text-align: left;"><strong><code>CIConfiguration.csproj</code></strong></td>
<td style="text-align: left;">Contains Windows Forms for managing system settings, users, and branches.</td>
<td style="text-align: left;">Class Library</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">1.0.0.0</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">.NET Framework 4.0</td>
<td style="text-align: left;">AnyCPU</td>
<td style="text-align: left;">Debug/Release</td>
<td style="text-align: left;"><code>CIConfigForm</code>, <code>UtilizadoresForm</code></td>
<td style="text-align: left;"><code>CIConfig...</code></td>
<td style="text-align: left;"><code>GenericNet</code></td>
</tr>
<tr>
<td style="text-align: left;">CIControloSemSetup.sln</td>
<td style="text-align: left;"><strong><code>CIReports.csproj</code></strong></td>
<td style="text-align: left;">Manages the generation and display of Crystal Reports.</td>
<td style="text-align: left;">Class Library</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">1.0.0.0</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">.NET Framework 4.0</td>
<td style="text-align: left;">AnyCPU</td>
<td style="text-align: left;">Debug/Release</td>
<td style="text-align: left;"><code>CIReportsForm</code></td>
<td style="text-align: left;"><code>CIConfig...</code></td>
<td style="text-align: left;"><code>CrystalDecisions</code></td>
</tr>
<tr>
<td style="text-align: left;">CIControloSemSetup.sln</td>
<td style="text-align: left;"><strong><code>CIFicheiro.csproj</code></strong></td>
<td style="text-align: left;">Handles parsing and processing of input files like ACOM and ENVM.</td>
<td style="text-align: left;">Class Library</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">1.0.0.0</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">.NET Framework 4.0</td>
<td style="text-align: left;">AnyCPU</td>
<td style="text-align: left;">Debug/Release</td>
<td style="text-align: left;"><code>FicheiroEnvm</code>, <code>FicheiroAcom</code></td>
<td style="text-align: left;"><code>CIConfig...</code></td>
<td style="text-align: left;"><code>GenericNet</code></td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>flowchart TD
    subgraph UI_Layer
        Controlo["CIControlo.csproj (WinForms App)"]
    end

    subgraph Service_Layer
        Servico["CIServico.csproj (Windows Service)"]
        ServRemessas["CIServRemessas.csproj (Remittance Logic)"]
        ServAlertas["CIServAlertas.csproj (Alert Logic)"]
    end

    subgraph Business_Logic_Forms
        Actividades["CIActividades.csproj (Activity Forms)"]
        Configuration["CIConfiguration.csproj (Config Forms)"]
        FicheirosControlo["CIFicheirosControlo.csproj (File Forms)"]
        MDIsControlo["MDIsControlo.csproj (MDI Forms)"]
        Reports["CIReports.csproj (Reporting)"]
        QueryForm["QueryForm.csproj (SQL UI)"]
    end

    subgraph Core_Domain
        Alerta["Alerta.csproj (Alert Models)"]
        ConfigParams["CIConfigGlobalParameters.csproj (Shared Config)"]
        Ficheiro["CIFicheiro.csproj (File Parsers)"]
        ServTester["CIServTester.csproj (Test Helpers)"]
    end

    subgraph External_Integrations
        MDIWebTransmCI["MDIWebTransmCI.vbproj (SOAP Client)"]
    end

    Controlo --> Actividades
    Controlo --> Configuration
    Controlo --> FicheirosControlo
    Controlo --> MDIsControlo
    Controlo --> Reports
    Controlo --> QueryForm
    Controlo --> ServTester

    Servico --> ServRemessas
    Servico --> ServAlertas
    Servico --> Ficheiro

    ServRemessas --> Actividades
    ServRemessas --> Alerta
    ServAlertas --> Alerta
    Actividades --> Alerta
    Configuration --> ConfigParams
    
    Actividades -.-> ConfigParams
    ServRemessas -.-> ConfigParams
    ServAlertas -.-> ConfigParams
    FicheirosControlo -.-> ConfigParams
    MDIsControlo -.-> ConfigParams
    MDIsControlo -.-> MDIWebTransmCI
</code></pre>
<center><sub>Figure 3 - Project dependency graph illustrating the relationships between the various projects in the solution.</sub></center>
</div>
<div class="product-section">
<h2 id="2-functional-overview">2. Functional overview</h2>
This section provides a high-level functional decomposition of the application, using table format. It identifies the major, distinct functional blocks or modules as inferred from the code's high-level structure (e.g., top-level namespaces, solution folders, primary class groups). This overview serves as a map to the application's core responsibilities.
<h3 id="21-executive-summary">2.1. Executive summary</h3>
This section provides a high-level summary of the application's primary purpose and its core function from a business or operational perspective, using table format. The summary is an inference based on the main entry points of the code (e.g., <code>main()</code>, <code>Application_Start()</code>), the names of the most central classes and modules, and the nature of the core processes identified. It answers the fundamental question: What primary problem does this application solve?
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Aspect</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Primary Purpose</strong></td>
<td style="text-align: left;">To serve as a back-office "Image Concentrator" system for processing financial documents (likely cheques) and remittances originating from bank branches and other sources.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Core Function</strong></td>
<td style="text-align: left;">The application automates the ingestion, validation, processing, and status tracking of document batches (remittances). It provides a rich desktop interface for operators to monitor these activities, handle exceptions, manage system configuration, and generate reports.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Key Processes</strong></td>
<td style="text-align: left;">- Ingestion of remittance data from files (<code>ENVM</code>, <code>ACOM</code>).<br>- Automated processing of remittances and document tranches via a Windows Service (<code>CIServico</code>).<br>- Manual monitoring and intervention through a Windows Forms application (<code>CIControlo</code>).<br>- Alerting and notification for system events and errors.<br>- Reporting on processing volumes and statuses.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="22-functional-decomposition">2.2. Functional decomposition</h3>
This section provides a detailed breakdown of the application's functional areas or modules, inferred from the code structure. Each module is described in terms of its primary responsibilities and how it contributes to the overall functionality of the application.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Functional Area / Module</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>User Interaction & Presentation</strong></td>
<td style="text-align: left;">Manages all user-facing windows and controls. This module is the primary interface for operators to monitor workflows, manage configurations, and perform manual actions. It is implemented as a Windows Forms MDI application.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Core Process Execution Engine</strong></td>
<td style="text-align: left;">A background Windows Service that drives all automated processing. It continuously polls for new work (remittances, alerts) and executes the corresponding business logic in a threaded manner.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Remittance & Document Processing</strong></td>
<td style="text-align: left;">Contains the core business logic for handling remittances. This includes validating data, breaking remittances into processable batches (tranches), updating statuses, and handling errors.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Alerting & Notification</strong></td>
<td style="text-align: left;">A dedicated subsystem for generating and dispatching system alerts. It supports multiple notification channels, including database logging, file logging, Windows Event Viewer, and email (EWS/WebDAV).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>File-based Integration</strong></td>
<td style="text-align: left;">Responsible for handling data exchange with external systems through structured files. It includes logic for parsing specific file formats (<code>ENVM</code>, <code>ACOM</code>), moving processed files, and managing file system paths.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Persistence & Management</strong></td>
<td style="text-align: left;">Encapsulates all direct interactions with the SQL Server database. While not a formal data access layer, various classes throughout the application use <code>System.Data.SqlClient</code> to execute raw SQL queries and stored procedures.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Configuration Management</strong></td>
<td style="text-align: left;">Provides the logic and UI for managing system parameters, user accounts, and branch (<code>Balco</code>) configurations. This allows administrators to tune the application's behavior without code changes.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Reporting</strong></td>
<td style="text-align: left;">Integrates with Crystal Reports to generate and display various operational and business reports, such as remittance listings and monthly billing summaries.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>classDiagram
    direction LR
    class UserInteraction {
        +ActividadeBalcaoForm
        +CIConfigForm
        +PesquisasForm
        +Handles_user_input
        +Displays_data_grids
    }
    class CoreProcessingEngine {
        +CIServico_Windows_Service
        +CIServiceComumThread
        +Polls_for_work
        +Manages_background_threads
    }
    class RemittanceLogic {
        +ServRemessa
        +ProcessaRemessa()
        +TratarTranchesBalcao()
        +Manages_remittance_lifecycle
    }
    class AlertingSystem {
        +ServAlerta
        +AlertaSituacaoAccao
        +Sends_email_logs_to_DB_File
    }
    class FileIntegration {
        +FicheiroEnvm
        +FicheiroAcom
        +Parses_input_files
        +Moves_processed_files
    }
    class DataPersistence {
        +CIGlobalParameters
        +DirectSqlDataReader()
        +Executes_raw_SQL_and_Stored_Procs
    }
    class Reporting {
        +CIReports
        +Crystal_Reports_integration
        +Generates_business_reports
    }

    UserInteraction --> RemittanceLogic : "Triggers manual actions"
    UserInteraction --> DataPersistence : "Fetches data for display"
    UserInteraction --> Reporting : "Requests reports"
    CoreProcessingEngine --> RemittanceLogic : "Processes remittances"
    CoreProcessingEngine --> AlertingSystem : "Processes alerts"
    CoreProcessingEngine --> FileIntegration : "Processes files"
    RemittanceLogic --> DataPersistence : "Reads/writes remittance data"
    RemittanceLogic --> AlertingSystem : "Generates alerts on errors"
    AlertingSystem --> DataPersistence : "Logs alerts to DB"
</code></pre>
<center><sub>Figure 4 - Functional decomposition showing the relationships between key application modules.</sub></center>
<h3 id="23-user-roles-and-permissions">2.3. User roles and permissions</h3>
This section identifies the distinct types of users that interact with the application. These roles are inferred from authorization checks and conditional logic based on user properties found in the code.
<div class="table-container">
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Role</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Permissions</th>
<th style="text-align: left;">Key Actions</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Administrator</strong></td>
<td style="text-align: left;">A privileged user with full control over the system, including configuration and manual process overrides. Corresponds to <code>UserGroup <= 1</code>.</td>
<td style="text-align: left;">- Full CRUD on most entities.<br>- Ability to change the state of remittances and tranches.<br>- Access to system configuration and user management.</td>
<td style="text-align: left;"><code>MudarEstado</code>, <code>Reenviar...EmErro</code>, <code>Update<em>Utilizadores</code>, <code>Insert</em>Balcao</code></td>
<td style="text-align: left;"><code>User</code>, <code>Balcao</code>, <code>Remessa</code>, <code>Tranche</code>, <code>ActivityChange</code></td>
<td style="text-align: left;">Inferred from <code>ConfirmaPrivilegios()</code> checks (<code>m<em>oParameters.UserLogged.m</em>iUserGroup > 1</code>) which lock down sensitive operations.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Standard Operator</strong></td>
<td style="text-align: left;">A standard user responsible for monitoring and performing routine operational tasks. Corresponds to <code>UserGroup > 1</code>.</td>
<td style="text-align: left;">- Read-only access to most data.<br>- Ability to view activities, remittances, and documents.<br>- Cannot change critical system states or configurations.</td>
<td style="text-align: left;"><code>ViewActividades</code>, <code>ViewDocumento</code>, <code>Refresh</code></td>
<td style="text-align: left;"><code>Remessa</code>, <code>Documento</code>, <code>Alerta</code></td>
<td style="text-align: left;">Inferred as the default role for users who fail the <code>UserGroup <= 1</code> privilege check.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>classDiagram
    class User {
        +m_sUserName
        +m_sUserFullName
        +m_iUserGroup
    }
    class Administrator {
        <<Role>>
        UserGroup_is_less_than_or_equal_to_1
    }
    class StandardOperator {
        <<Role>>
        UserGroup_is_greater_than_1
    }

    Administrator --|> User
    StandardOperator --|> User

    Administrator -- "1" Remessa : "Can change state"
    Administrator -- "1" Tranche : "Can change state"
    Administrator -- "1" Balcao : "Manages"
    StandardOperator -- "1..*" Remessa : "Views"
    StandardOperator -- "1..*" Documento : "Views"

    note for Administrator "Full system control, including manual overrides and configuration."
    note for StandardOperator "Monitoring and read-only access to operational data."

</code></pre>
<center><sub>Figure 5 - Class diagram illustrating the user roles and their relationship with key data entities.</sub></center>
<h3 id="24-core-business-capabilities">2.4. Core business capabilities</h3>
This section lists the main, high-level capabilities of the application, representing its "Epics" or major functional domains.
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Capability</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Key Features</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Remittance Processing</strong></td>
<td style="text-align: left;">The complete set of functions related to processing batches of financial documents (remittances) from ingestion to final state.</td>
<td style="text-align: left;">- Automated processing via Windows Service.<br>- Manual state changes for error recovery.<br>- Batching of documents into tranches.</td>
<td style="text-align: left;"><code>Remessa</code>, <code>Tranche</code>, <code>Documento</code></td>
<td style="text-align: left;">This is the central capability, inferred from project names like <code>CIServRemessas</code> and classes like <code>ServRemessa</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Document Management</strong></td>
<td style="text-align: left;">All functions related to the lifecycle of individual documents, including their data and associated images.</td>
<td style="text-align: left;">- Viewing document images.<br>- Storing document metadata and parsed data (from optical line).<br>- Associating documents with remittances and tranches.</td>
<td style="text-align: left;"><code>Documento</code>, <code>Imagem</code></td>
<td style="text-align: left;">Inferred from the application's name "Image Concentrator" and forms like <code>ImagemBalcaoForm</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>System Monitoring & Alerting</strong></td>
<td style="text-align: left;">Provides real-time and historical views into system activities and automatically notifies stakeholders of important events or errors.</td>
<td style="text-align: left;">- UI for viewing activities by status and date.<br>- Automated alert generation for processing failures.<br>- Multi-channel notifications (Email, DB Log, Event Viewer).</td>
<td style="text-align: left;"><code>Alerta</code>, <code>Accao</code>, <code>SituacaoAccao</code></td>
<td style="text-align: left;">Inferred from the <code>CIActividades</code> and <code>Alerta</code> projects.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Operational Administration</strong></td>
<td style="text-align: left;">The set of functions allowing administrators to configure and manage the application's operational parameters and user access.</td>
<td style="text-align: left;">- User and group management.<br>- Configuration of bank branches (<code>Balco</code>) and processing machines.<br>- System-level parameter tuning (e.g., timers, thresholds).</td>
<td style="text-align: left;"><code>User</code>, <code>Balcao</code>, <code>Maquina</code></td>
<td style="text-align: left;">Inferred from the <code>CIConfiguration</code> project and its associated forms.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>flowchart TD
    subgraph SDCIM_Capabilities
        A["Remittance Processing"]
        B["Document Management"]
        C["System Monitoring and Alerting"]
        D["Operational Administration"]
    end

    A --> B
    A --> C
    D --> A
    D --> C
</code></pre>
<center><sub>Figure 6 - High-level diagram of the core business capabilities.</sub></center>
<h3 id="25-detailed-feature-breakdown">2.5. Detailed feature breakdown</h3>
This critical section provides a granular breakdown of individual features within each Core Business Capability.
<div class="table-container">
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">User Story / Description</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Process Remittance</strong></td>
<td style="text-align: left;">As a <strong>System</strong>, I can automatically pick up a new remittance from the database and process its documents in batches (tranches) so that financial transactions are recorded.</td>
<td style="text-align: left;"><code>Remessa</code>, <code>Tranche</code>, <code>Documento</code></td>
<td style="text-align: left;">Inferred from <code>ServRemessa.ProcessaRemessa</code> and the polling logic in <code>CIServicoThread</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Manually Change Remittance State</strong></td>
<td style="text-align: left;">As an <strong>Administrator</strong>, I can manually change the status of a failed remittance so that it can be re-processed by the system.</td>
<td style="text-align: left;"><code>Remessa</code>, <code>ActivityChange</code></td>
<td style="text-align: left;">Inferred from <code>MudarEstadoForm</code> and the context menus in <code>ActividadesForm</code> that are enabled for privileged users.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>View Activity Dashboard</strong></td>
<td style="text-align: left;">As an <strong>Operator</strong>, I can view a dashboard of all remittance activities, filtered by date and status, so that I can monitor the system's health and performance.</td>
<td style="text-align: left;"><code>Remessa</code>, <code>Tranche</code></td>
<td style="text-align: left;">Inferred from the main UI of <code>ActividadeBalcaoForm</code> and its filtering controls.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>View Document Image</strong></td>
<td style="text-align: left;">As an <strong>Operator</strong>, I can select a specific document from a remittance and view its scanned image so that I can visually verify its contents.</td>
<td style="text-align: left;"><code>Documento</code>, <code>Imagem</code></td>
<td style="text-align: left;">Inferred from <code>ImagemBalcaoForm</code> and the "Ver Imagem" context menu option.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Configure System Alerts</strong></td>
<td style="text-align: left;">As an <strong>Administrator</strong>, I can configure which actions (e.g., send email, log to file) are triggered by specific system situations (e.g., processing error) so that notifications are sent to the correct stakeholders.</td>
<td style="text-align: left;"><code>SituacaoAccao</code>, <code>Accao</code>, <code>AccaoParam</code></td>
<td style="text-align: left;">Inferred from the UI and logic in <code>CIConfigForm</code>.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="26-key-data-entities-and-their-attributes">2.6. Key data entities and their attributes</h3>
This section documents the application's core data structures, as inferred from class definitions or ORM configurations.
<div class="table-container">
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Entity</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Key Attributes</th>
<th style="text-align: left;">Data Type</th>
<th style="text-align: left;">Validation Rules</th>
<th style="text-align: left;">Relationships</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Remessa</strong></td>
<td style="text-align: left;">Represents a batch of documents submitted for processing, typically from a single branch (<code>Balco</code>).</td>
<td style="text-align: left;"><code>ID</code>, <code>Data</code>, <code>StatusID</code>, <code>Balcao</code>, <code>Numero</code>, <code>Montante</code></td>
<td style="text-align: left;"><code>int</code>, <code>DateTime</code>, <code>int</code>, <code>int</code>, <code>int</code>, <code>decimal</code></td>
<td style="text-align: left;"><code>ID</code> is a primary key. <code>StatusID</code> references a status table.</td>
<td style="text-align: left;">Has a one-to-many relationship with <code>Tranche</code> and <code>Documento</code>.</td>
<td style="text-align: left;">Inferred from <code>DetalheRemessa</code> and related classes.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Documento</strong></td>
<td style="text-align: left;">Represents a single financial document, such as a cheque, within a remittance.</td>
<td style="text-align: left;"><code>ID</code>, <code>DocOriID</code>, <code>Zona1</code> to <code>Zona5</code> (optical line data), <code>NIB</code>, <code>RefArq</code>, <code>EstadoID</code></td>
<td style="text-align: left;"><code>int</code>, <code>string</code>, <code>string</code>, <code>string</code>, <code>int</code></td>
<td style="text-align: left;"><code>ID</code> is a primary key. <code>EstadoID</code> references a status table.</td>
<td style="text-align: left;">Belongs to one <code>Remessa</code> and one <code>Tranche</code>.</td>
<td style="text-align: left;">Inferred from <code>DetalheDocumento</code> class. <code>Zona</code> fields likely represent parsed MICR/OCR data.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Tranche</strong></td>
<td style="text-align: left;">A sub-batch of documents within a larger remittance, used for processing and sending to external systems.</td>
<td style="text-align: left;"><code>ID</code>, <code>RemessaID</code>, <code>Numero</code>, <code>EstadoID</code>, <code>QtDocs</code>, <code>Montante</code></td>
<td style="text-align: left;"><code>int</code>, <code>int</code>, <code>int</code>, <code>int</code>, <code>int</code>, <code>decimal</code></td>
<td style="text-align: left;"><code>ID</code> is a primary key.</td>
<td style="text-align: left;">Belongs to one <code>Remessa</code>. Has a one-to-many relationship with <code>Documento</code>.</td>
<td style="text-align: left;">Inferred from <code>DetalheTranche</code> class.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Alerta</strong></td>
<td style="text-align: left;">A system-generated alert triggered by a specific event or situation.</td>
<td style="text-align: left;"><code>ID</code>, <code>Timer</code>, <code>Text</code>, <code>Varchar</code></td>
<td style="text-align: left;"><code>string</code>, <code>DateTime</code>, <code>string</code>, <code>string</code></td>
<td style="text-align: left;"><code>ID</code> is a primary key.</td>
<td style="text-align: left;">Associated with a <code>SituacaoAccao</code>.</td>
<td style="text-align: left;">Inferred from <code>AlertaSituacaoAccao</code> class.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Accao</strong></td>
<td style="text-align: left;">A predefined action that can be executed in response to an alert.</td>
<td style="text-align: left;"><code>ID</code>, <code>Desc</code>, <code>TipoAccaoID</code></td>
<td style="text-align: left;"><code>int</code>, <code>string</code>, <code>enum</code></td>
<td style="text-align: left;"><code>ID</code> is a primary key. <code>TipoAccaoID</code> is an enum (<code>MAIL</code>, <code>SMS</code>, <code>LOGDB</code>, etc.).</td>
<td style="text-align: left;">Many-to-many relationship with <code>Situacao</code> via <code>SituacaoAccao</code>.</td>
<td style="text-align: left;">Inferred from <code>Accao.cs</code>.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>erDiagram
    Remessa {
        int ID PK
        datetime Data
        int StatusID
        int Balcao
        int Numero
        decimal Montante
    }
    Tranche {
        int ID PK
        int RemessaID FK
        int Numero
        int EstadoID
    }
    Documento {
        int ID PK
        int RemessaID FK
        int TrancheID FK
        string Zona1
        string Zona2
        string Zona3
        string Zona4
        string Zona5
        string NIB
    }
    Alerta {
        string ID PK
        datetime Timer
        string Text
    }
    SituacaoAccao {
        int SituacaoID PK
        int AccaoID PK
    }
    Accao {
        int ID PK
        string Desc
        int TipoAccaoID
    }

    Remessa ||--|{ Tranche : "contains"
    Tranche ||--|{ Documento : "contains"
    Alerta ||--o{ SituacaoAccao : "triggers"
    SituacaoAccao }o--|| Accao : "executes"
</code></pre>
<center><sub>Figure 7 - Entity-Relationship diagram showing the core data entities and their relationships.</sub></center>
<h3 id="27-business-process-workflows">2.7. Business process workflows</h3>
This section describes and visualizes critical end-to-end processes, showing how different user roles and system features interact.
<div class="table-container">
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Process</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Key Steps</th>
<th style="text-align: left;">User Roles Involved</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Standard Remittance Processing</strong></td>
<td style="text-align: left;">A comprehensive workflow that outlines the steps involved in processing remittances from ingestion to final output.</td>
<td style="text-align: left;">1. Remittance is created in the database (status: open).<br>2. <code>CIServico</code> picks up the remittance for processing (status: processing).<br>3. Documents are grouped into tranches.<br>4. Tranches are sent to an external system (e.g., via web service).<br>5. Remittance status is updated to processed/closed.</td>
<td style="text-align: left;">System (automated), Standard Operator (monitoring)</td>
<td style="text-align: left;"><code>Remessa</code>, <code>Tranche</code>, <code>Documento</code></td>
<td style="text-align: left;">This is the primary "happy path" workflow inferred from the service and form logic.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Error Handling and Manual Intervention</strong></td>
<td style="text-align: left;">The workflow for managing and resolving remittances or documents that fail automated processing.</td>
<td style="text-align: left;">1. A processing error occurs.<br>2. An alert is generated (<code>Alerta</code>).<br>3. An Administrator reviews the failed item in the UI.<br>4. The Administrator manually changes the item's state (e.g., to "re-process").<br>5. The item re-enters the standard processing workflow.</td>
<td style="text-align: left;">Administrator, Standard Operator (viewing alerts)</td>
<td style="text-align: left;"><code>Remessa</code>, <code>Alerta</code>, <code>ActivityChange</code></td>
<td style="text-align: left;">Inferred from the existence of <code>MudarEstadoForm</code> and error-related statuses.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Alert Notification</strong></td>
<td style="text-align: left;">The process by which the system notifies stakeholders about critical events.</td>
<td style="text-align: left;">1. An event triggers a <code>Situacao</code>.<br>2. The system looks up associated <code>Accao</code> records.<br>3. The system executes each action (e.g., sends an email, writes to a log file).<br>4. The alert action status is marked as processed.</td>
<td style="text-align: left;">System (automated), Administrator (recipient)</td>
<td style="text-align: left;"><code>Alerta</code>, <code>SituacaoAccao</code>, <code>Accao</code></td>
<td style="text-align: left;">Inferred from the <code>Alerta</code> and <code>CIServAlertas</code> projects.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>flowchart TD
    subgraph Workflows
        A["Standard Remittance Processing"]
        B["Error Handling and Manual Intervention"]
        C["Alert Notification"]
    end

    A -- "On Error" --> B
    B -- "Triggers" --> C
    B -- "Re-process" --> A
</code></pre>
<center><sub>Figure 8 - High-level relationships between the main business process workflows.</sub></center>
<h4 id="271-workflow-standard-remittance-processing">2.7.1. Workflow: Standard Remittance Processing</h4>
This section provides a detailed breakdown of the Standard Remittance Processing workflow, including the steps involved, user roles, key data entities, and any assumptions made.
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>1. Remittance Creation</strong></td>
<td style="text-align: left;">A new remittance record is created in the database with an initial "open" or "ready" status. This is likely done by an upstream system or file import process.</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Remessa</code></td>
<td style="text-align: left;">Assumes an external trigger creates the initial record.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>2. Processing Pickup</strong></td>
<td style="text-align: left;">The <code>CIServico</code> Windows Service polls the database and picks up the new remittance for processing, changing its status to "processing".</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Remessa</code></td>
<td style="text-align: left;">Inferred from <code>REMIN_IDParaProcessar()</code> method.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>3. Tranche Creation</strong></td>
<td style="text-align: left;">The service logic groups the documents within the remittance into one or more tranches based on system rules (e.g., <code>MaxDocsTranche</code> parameter).</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Remessa</code>, <code>Tranche</code></td>
<td style="text-align: left;">Inferred from <code>TratarTranchesBalcao</code> and <code>CriarTranche</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>4. Document Processing</strong></td>
<td style="text-align: left;">Each document within a tranche is processed. This may involve validation, data enrichment, and image conversion.</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Documento</code>, <code>Tranche</code></td>
<td style="text-align: left;">Inferred from <code>ProcessaDocumento</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>5. Tranche Transmission</strong></td>
<td style="text-align: left;">The processed tranches are sent to an external system, likely via a web service. The tranche status is updated upon success or failure.</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Tranche</code></td>
<td style="text-align: left;">Inferred from context; the purpose of a tranche is typically for transmission.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>6. Finalization</strong></td>
<td style="text-align: left;">Once all tranches are successfully processed, the parent remittance is marked as "closed" or "processed".</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Remessa</code></td>
<td style="text-align: left;">This is the logical end-state of a successful workflow.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>sequenceDiagram
    participant Ext as External System
    participant DB as Database
    participant Srv as CIServico
    participant Logic as ServRemessa

    Ext->>DB: Create Remittance (Status: Open)
    loop Poll for Work
        Srv->>DB: REMIN_IDParaProcessar()
        DB-->>Srv: Remittance ID
    end
    Srv->>Logic: ProcessaRemessa(ID)
    Logic->>DB: Update Remittance (Status: Processing)
    Logic->>Logic: Create Tranches
    Logic->>DB: Create Tranche Records
    loop For Each Document
        Logic->>Logic: ProcessaDocumento()
        Logic->>DB: Update Document Status
    end
    Logic->>Ext: Send Tranche Data
    Logic->>DB: Update Tranche Status
    Logic->>DB: Update Remittance (Status: Closed)
</code></pre>
<center><sub>Figure 9 - Sequence diagram detailing the Standard Remittance Processing workflow.</sub></center>
<h4 id="272-workflow-error-handling-and-manual-intervention">2.7.2. Workflow: Error Handling and Manual Intervention</h4>
This section provides a detailed breakdown of the Error Handling and Manual Intervention workflow, including the steps involved, user roles, key data entities, and any assumptions made.
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>1. Error Detection</strong></td>
<td style="text-align: left;">An error occurs during the automated processing of a remittance, tranche, or document. The item's status is set to an error state (e.g., -40).</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Remessa</code>, <code>Tranche</code>, <code>Documento</code></td>
<td style="text-align: left;">Inferred from <code>try-catch</code> blocks and error handling logic in <code>ServRemessa</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>2. Alert Generation</strong></td>
<td style="text-align: left;">The system automatically generates an <code>Alerta</code> record corresponding to the error situation.</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Alerta</code></td>
<td style="text-align: left;">Inferred from calls to <code>EnviarAlertaSituacao</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>3. Notification</strong></td>
<td style="text-align: left;">The <code>CIServAlertas</code> logic picks up the new alert and executes the configured actions (e.g., sends an email to an administrator).</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Accao</code>, <code>Alerta</code></td>
<td style="text-align: left;">Inferred from the <code>ServAlerta</code> class.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>4. User Review</strong></td>
<td style="text-align: left;">An Administrator logs into the <code>CIControlo</code> application and navigates to the activity monitor to review the item in an error state.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Remessa</code></td>
<td style="text-align: left;">This is the primary use case for the UI's monitoring forms.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>5. Manual State Change</strong></td>
<td style="text-align: left;">The Administrator uses the context menu to manually change the state of the failed item, for example, to re-queue it for processing.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Remessa</code>, <code>ActivityChange</code></td>
<td style="text-align: left;">Inferred from <code>MudarEstadoForm</code> and its invocation from the UI.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>6. Re-processing</strong></td>
<td style="text-align: left;">The item, now in a valid starting state, is picked up again by the <code>CIServico</code> during its next polling cycle, re-entering the standard workflow.</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Remessa</code></td>
<td style="text-align: left;">Assumes the state change makes it eligible for re-processing.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>sequenceDiagram
    participant Srv as CIServico
    participant UI as CIControlo App
    participant Admin as Administrator
    participant DB as Database
    
    Srv->>Srv: Processing fails
    Srv->>DB: Update Status to Error
    Srv->>DB: Create Alert record
    
    Admin->>UI: Logs in and opens Activity Monitor
    UI->>DB: Load items in error state
    DB-->>UI: Display failed items
    
    Admin->>UI: Right-clicks item, selects "Mudar Estado"
    UI->>DB: Update Remittance Status (e.g., to 're-process')
    
    loop Next Polling Cycle
        Srv->>DB: REMIN_IDParaProcessar()
        DB-->>Srv: Remittance ID (now ready for processing)
        Srv->>Srv: Re-processes the remittance
    end
</code></pre>
<center><sub>Figure 10 - Sequence diagram detailing the Error Handling and Manual Intervention workflow.</sub></center>
<h4 id="273-workflow-alert-notification">2.7.3. Workflow: Alert Notification</h4>
This section provides a detailed breakdown of the Alert Notification workflow, including the steps involved, user roles, key data entities, and any assumptions made.
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>1. Situation Trigger</strong></td>
<td style="text-align: left;">A processing event (e.g., an error, a state change) triggers a pre-defined "Situation" in the system.</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>SituacaoAccao</code></td>
<td style="text-align: left;">Inferred from the <code>EnviarAlertaSituacao</code> method, which takes a situation ID.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>2. Alert Creation</strong></td>
<td style="text-align: left;">An <code>Alerta</code> record is created in the database, linked to the triggered situation.</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Alerta</code></td>
<td style="text-align: left;">This is the first step in the <code>CIServAlertas</code> logic.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>3. Alert Pickup</strong></td>
<td style="text-align: left;">The <code>CIServAlertas</code> polling thread picks up the new <code>Alerta</code> record for processing.</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Alerta</code></td>
<td style="text-align: left;">Inferred from <code>AlertaSituacaoAccaoParaProcessar()</code> method.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>4. Action Execution</strong></td>
<td style="text-align: left;">The system retrieves all <code>Accao</code> (Action) records associated with the situation and executes them one by one (e.g., send email, log to file, log to Event Viewer).</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Accao</code>, <code>AccaoParam</code></td>
<td style="text-align: left;">Inferred from <code>ProcessaAlertaSituacaoAccao</code>, which iterates through different action types.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>5. Mark as Processed</strong></td>
<td style="text-align: left;">Once all actions for the alert have been attempted, the alert record is marked as processed in the database to prevent re-execution.</td>
<td style="text-align: left;">System</td>
<td style="text-align: left;"><code>Alerta</code></td>
<td style="text-align: left;">This is the final step to complete the alert lifecycle.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>sequenceDiagram
    participant Logic as Business Logic (e.g., ServRemessa)
    participant DB as Database
    participant AlertSrv as CIServAlertas
    participant NotifGW as Notification Gateway (Email, File)

    Logic->>DB: A process fails, triggering a Situation
    Logic->>DB: Create Alerta record
    
    loop Poll for Alerts
        AlertSrv->>DB: AlertaSituacaoAccaoParaProcessar()
        DB-->>AlertSrv: New Alert ID
    end

    AlertSrv->>DB: Get associated Actions for the Alert
    DB-->>AlertSrv: List of Actions (e.g., Send Email, Log to File)

    loop For each Action
        AlertSrv->>NotifGW: Execute Action (e.g., Send an email)
    end
    
    AlertSrv->>DB: Update Alerta record (Status: Processed)
</code></pre>
<center><sub>Figure 11 - Sequence diagram detailing the Alert Notification workflow.</sub></center>
<h3 id="28-system-inputs-outputs-interfaces">2.8. System inputs & outputs (interfaces)</h3>
This section catalogs all identified points where data enters or leaves the application boundary.
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Name / Description</th>
<th style="text-align: left;">Data Formats</th>
<th style="text-align: left;">Data Source / Sink</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Input</strong></td>
<td style="text-align: left;"><strong>File Ingestion (ENVM/ACOM)</strong></td>
<td style="text-align: left;">Fixed-width text files (<code>.txt</code>, <code>.*</code>)</td>
<td style="text-align: left;">Monitored file system directory (<code>C:\tmp\</code> by default)</td>
<td style="text-align: left;">Inferred from <code>CIFicheiro</code> project and classes like <code>FicheiroEnvm</code> and <code>FicheiroAcom</code>. The service likely watches a directory for new files to process.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Input</strong></td>
<td style="text-align: left;"><strong>User Interface Actions</strong></td>
<td style="text-align: left;">User-driven events (clicks, text entry)</td>
<td style="text-align: left;">Windows Forms UI (<code>CIControlo</code>, <code>CIActividades</code>)</td>
<td style="text-align: left;">The application is interactive, allowing operators to provide input to filter data, change states, and manage configurations.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Output</strong></td>
<td style="text-align: left;"><strong>Database Writes</strong></td>
<td style="text-align: left;">SQL Commands</td>
<td style="text-align: left;">Microsoft SQL Server</td>
<td style="text-align: left;">The application's primary function is to process data and persist the results and state changes to a central database.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Output</strong></td>
<td style="text-align: left;"><strong>Email Notifications</strong></td>
<td style="text-align: left;">SMTP (via EWS or WebDAV)</td>
<td style="text-align: left;">External Email Gateway</td>
<td style="text-align: left;">The <code>Alerta</code> system is configured to send emails as a notification action, as seen in <code>ServAlertasSendWebmail.cs</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Output</strong></td>
<td style="text-align: left;"><strong>Log Files</strong></td>
<td style="text-align: left;">Text files</td>
<td style="text-align: left;">Local/Network file system</td>
<td style="text-align: left;">The <code>Alerta</code> system can be configured to write logs to a file, as seen in <code>ServAlertasLogFile.cs</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Output</strong></td>
<td style="text-align: left;"><strong>Windows Event Log</strong></td>
<td style="text-align: left;">Event Log Entries</td>
<td style="text-align: left;">Windows Operating System</td>
<td style="text-align: left;">The <code>Alerta</code> system can write warnings and errors to the Windows Event Log. <code>CIServico</code> also logs its start/stop events.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Flow</strong></td>
<td style="text-align: left;"><strong>Internal Database-Driven Workflow</strong></td>
<td style="text-align: left;">In-memory objects (<code>Remessa</code>, <code>Documento</code>)</td>
<td style="text-align: left;">Application Memory -> Database</td>
<td style="text-align: left;">Data is read from the database, processed by the business logic in <code>CIServRemessas</code>, and the updated state is written back to the database.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Flow</strong></td>
<td style="text-align: left;"><strong>Web Service Call (MDI)</strong></td>
<td style="text-align: left;">SOAP/XML</td>
<td style="text-align: left;">External Web Service (<code>http://waiaccesstu/...</code>)</td>
<td style="text-align: left;">The <code>MDIWebTransmCI</code> project makes outbound SOAP calls to an external service for document insertion.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>flowchart TD
    subgraph External_Inputs
        direction LR
        A["(filesystem) File Share (ENVM, ACOM)"]
        B["(user) Operator via WinForms UI"]
    end

    subgraph SDCIM_Application
        direction TB
        C["CIServico (File Polling)"]
        D["CIControlo (UI Logic)"]
        E["Core Logic (Remittance, Alerts)"]
        F["(database) SQL Server Database"]
    end
    
    subgraph External_Outputs
        direction LR
        G["(service) Email Gateway"]
        H["(filesystem) Log Files"]
        I["(os) Windows Event Log"]
        J["(service) External SOAP Web Service"]
    end

    A --> C
    B --> D
    C --> E
    D --> E
    E --> F
    E --> G
    E --> H
    E --> I
    E --> J
</code></pre>
<center><sub>Figure 12 - Diagram illustrating the main system inputs, outputs, and internal data flows.</sub></center>
<h3 id="29-user-task-flows">2.9. User Task Flows</h3>
This section describes the typical path a user takes through the application to achieve a high-level objective.
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Task Flow</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Resolve a Failed Remittance</strong></td>
<td style="text-align: left;">A complete sequence of steps an administrator follows to identify, diagnose, and resolve a remittance that has failed automated processing.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Remessa</code>, <code>Documento</code>, <code>Alerta</code></td>
<td style="text-align: left;">This is a primary task for a privileged user, combining monitoring, investigation, and manual intervention features.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Monitor Daily Processing</strong></td>
<td style="text-align: left;">A routine task for an operator to check the status of the day's remittances and identify any bottlenecks or widespread issues.</td>
<td style="text-align: left;">Standard Operator</td>
<td style="text-align: left;"><code>Remessa</code>, <code>Tranche</code></td>
<td style="text-align: left;">This flow represents the main day-to-day use of the application's monitoring UI.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Configure a New Branch</strong></td>
<td style="text-align: left;">An administrative task to set up a new bank branch (<code>Balco</code>) and its associated processing machines in the system.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Balcao</code>, <code>Maquina</code></td>
<td style="text-align: left;">Inferred from the <code>CIConfiguration</code> project and the <code>BalcaoForm</code>.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>flowchart TD
    subgraph User_Task_Flows
        A["Monitor Daily Processing"]
        B["Resolve a Failed Remittance"]
        C["Configure a New Branch"]
    end
    
    A -- "Identifies issue" --> B
</code></pre>
<center><sub>Figure 13 - High-level diagram showing the relationship between user task flows.</sub></center>
<h4 id="291-user-task-flow-resolve-a-failed-remittance">2.9.1. User Task Flow: Resolve a Failed Remittance</h4>
This section provides a detailed breakdown of the "Resolve a Failed Remittance" user task flow.
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>1. Receive Alert</strong></td>
<td style="text-align: left;">The administrator receives an email notification that a remittance has failed.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Alerta</code></td>
<td style="text-align: left;">Assumes email is the primary notification channel for critical errors.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>2. Login & Open Dashboard</strong></td>
<td style="text-align: left;">The administrator launches the <code>CIControlo</code> application and opens the <code>ActividadeBalcaoForm</code>.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">Standard application entry point.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>3. Filter for Errors</strong></td>
<td style="text-align: left;">The administrator uses the toolbar filters to show only items in an "Error" state for the relevant date.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Remessa</code></td>
<td style="text-align: left;">Inferred from the UI controls on <code>ActividadeBalcaoForm</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>4. Identify Failed Item</strong></td>
<td style="text-align: left;">The administrator identifies the specific remittance mentioned in the alert from the summary list.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Remessa</code></td>
<td style="text-align: left;">The user matches data from the alert to the UI.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>5. Drill Down to Details</strong></td>
<td style="text-align: left;">The administrator double-clicks the remittance to view its tranches, and then a tranche to view its individual documents, looking for the source of the error.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Tranche</code>, <code>Documento</code></td>
<td style="text-align: left;">Inferred from the drill-down capabilities of the UI's list views.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>6. View Document Image</strong></td>
<td style="text-align: left;">If the error is document-related, the administrator views the document image to check for issues like poor scan quality or incorrect data.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Documento</code>, <code>Imagem</code></td>
<td style="text-align: left;">Inferred from the "Ver Imagem" feature.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>7. Change State for Re-processing</strong></td>
<td style="text-align: left;">After diagnosing the issue (and possibly correcting data externally), the administrator right-clicks the remittance and uses the "Mudar Estado" feature to reset its status.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Remessa</code></td>
<td style="text-align: left;">This is the core manual intervention action.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>8. Confirm Resolution</strong></td>
<td style="text-align: left;">The administrator later re-checks the dashboard to confirm the remittance has been successfully re-processed by the automated service.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Remessa</code></td>
<td style="text-align: left;">Final step to ensure the intervention was successful.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>journey
    title Resolve a Failed Remittance
    section Investigation
      Administrator: Receives email alert about a failed remittance.
      Administrator: Logs into the CIControlo application.
      Administrator: Filters the Activity Dashboard to show items in an error state.
      Administrator: Identifies the failed remittance and drills down to view its documents.
    section Intervention
      Administrator: Views the image of a problematic document to diagnose the issue.
      Administrator: Right-clicks the remittance and selects "Mudar Estado" to reset its status for re-processing.
    section Verification
      Administrator: Later, checks the dashboard to confirm the remittance has processed successfully.
</code></pre>
<center><sub>Figure 14 - User journey diagram for resolving a failed remittance.</sub></center>
<h4 id="292-user-task-flow-monitor-daily-processing">2.9.2. User Task Flow: Monitor Daily Processing</h4>
This section provides a detailed breakdown of the "Monitor Daily Processing" user task flow.
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>1. Login</strong></td>
<td style="text-align: left;">The operator launches the <code>CIControlo</code> application to begin their shift.</td>
<td style="text-align: left;">Standard Operator</td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">Standard application entry.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>2. Open Activity Monitor</strong></td>
<td style="text-align: left;">The operator navigates to the main activity monitoring form (<code>ActividadeBalcaoForm</code>).</td>
<td style="text-align: left;">Standard Operator</td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">This is the primary screen for monitoring.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>3. Set Date Filter</strong></td>
<td style="text-align: left;">The operator sets the date filter to the current day to see today's activities.</td>
<td style="text-align: left;">Standard Operator</td>
<td style="text-align: left;"><code>Remessa</code>, <code>Tranche</code></td>
<td style="text-align: left;">A common first action to scope the view.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>4. Review Status Counts</strong></td>
<td style="text-align: left;">The operator reviews the summary counts by status (e.g., Processed, Error, Open) to get a quick overview of system health.</td>
<td style="text-align: left;">Standard Operator</td>
<td style="text-align: left;"><code>Remessa</code></td>
<td style="text-align: left;">The UI provides summary information for quick analysis.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>5. Investigate Delays</strong></td>
<td style="text-align: left;">If the number of "Open" or "Processing" items seems high, the operator may sort by time to identify remittances that are taking longer than usual.</td>
<td style="text-align: left;">Standard Operator</td>
<td style="text-align: left;"><code>Remessa</code></td>
<td style="text-align: left;">Assumes the UI allows sorting to identify bottlenecks.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>6. Report Anomalies</strong></td>
<td style="text-align: left;">If a significant issue is found (e.g., many items in error), the operator escalates the issue to an Administrator.</td>
<td style="text-align: left;">Standard Operator</td>
<td style="text-align: left;"><code>Alerta</code></td>
<td style="text-align: left;">Standard procedure for non-privileged users.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>journey
    title Monitor Daily Processing
    section Overview
      Standard Operator: Logs into the CIControlo application.
      Standard Operator: Opens the Activity Dashboard.
      Standard Operator: Filters by the current date.
      Standard Operator: Reviews the summary counts for each status.
    section Analysis
      Standard Operator: Sorts by time to check for stuck or slow processes.
      Standard Operator: If a major issue is found, notifies an Administrator.
</code></pre>
<center><sub>Figure 15 - User journey diagram for monitoring daily processing.</sub></center>
<h4 id="293-user-task-flow-configure-a-new-branch">2.9.3. User Task Flow: Configure a New Branch</h4>
This section provides a detailed breakdown of the "Configure a New Branch" user task flow.
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>1. Login</strong></td>
<td style="text-align: left;">The administrator logs into the <code>CIControlo</code> application.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">Requires administrative privileges.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>2. Open Configuration</strong></td>
<td style="text-align: left;">The administrator navigates to the system configuration area (<code>CIConfiguration</code> project forms).</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">Access to this area is likely restricted.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>3. Open Branch Management</strong></td>
<td style="text-align: left;">The administrator opens the <code>BalcaoForm</code> to manage bank branches.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Balcao</code></td>
<td style="text-align: left;">Inferred from the existence of <code>BalcaoForm.cs</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>4. Add New Branch</strong></td>
<td style="text-align: left;">The administrator clicks an "Add" button and fills in the details for the new branch (e.g., ID, name, parameters).</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Balcao</code></td>
<td style="text-align: left;">Standard CRUD operation.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>5. Configure Machines</strong></td>
<td style="text-align: left;">The administrator associates one or more processing machines with the new branch.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Maquina</code></td>
<td style="text-align: left;">Branches and machines are linked entities.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>6. Save Configuration</strong></td>
<td style="text-align: left;">The administrator saves the new configuration to the database.</td>
<td style="text-align: left;">Administrator</td>
<td style="text-align: left;"><code>Balcao</code>, <code>Maquina</code></td>
<td style="text-align: left;">The final step to persist the changes.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>flowchart TD
    A["Admin logs in"] --> B["Open System Configuration UI"]
    B --> C["Navigate to Branch Management"]
    C --> D["Enter new branch details"]
    D --> E["Associate processing machines"]
    E --> F["Save new configuration"]
    F --> G["(database) New Balcao and Maquina records created"]
</code></pre>
<center><sub>Figure 16 - Flowchart for the task of configuring a new branch.</sub></center>
<h3 id="210-automated-scheduled-processes">2.10. Automated & Scheduled Processes</h3>
This section describes any system-triggered processes that run without direct user interaction, such as nightly jobs, scheduled reports, or data synchronization tasks.
<div class="table-container">
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Process Name</th>
<th style="text-align: left;">Trigger / Schedule</th>
<th style="text-align: left;">Purpose</th>
<th style="text-align: left;">Key Actions</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Remittance Processing Loop</strong></td>
<td style="text-align: left;">Continuous polling with a configurable delay (<code>TempoEntreIteracoes</code>).</td>
<td style="text-align: left;">To process new and re-queued remittances as they become available in the database.</td>
<td style="text-align: left;">1. <code>REMIN_IDParaProcessar()</code>: Get next remittance.<br>2. <code>ProcessaRemessa()</code>: Execute the full processing logic for the remittance.<br>3. <code>TratarTranchesBalcao()</code>: Process documents in batches.</td>
<td style="text-align: left;"><code>Remessa</code>, <code>Tranche</code>, <code>Documento</code></td>
<td style="text-align: left;">This is the main loop of the <code>CIServico</code> Windows Service, inferred from <code>CIServicoThread.cs</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Alert Processing Loop</strong></td>
<td style="text-align: left;">Continuous polling with a configurable delay.</td>
<td style="text-align: left;">To dispatch notifications for newly generated alerts.</td>
<td style="text-align: left;">1. <code>AlertaSituacaoAccaoParaProcessar()</code>: Get next alert.<br>2. <code>ProcessaAlertaSituacaoAccao()</code>: Execute configured actions (e.g., send email).</td>
<td style="text-align: left;"><code>Alerta</code>, <code>Accao</code></td>
<td style="text-align: left;">Inferred from the logic in <code>ProcessarAlertas.cs</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>File System Polling</strong></td>
<td style="text-align: left;">Continuous polling with a configurable delay (<code>TempoEntreIteracoesFicheiros</code>).</td>
<td style="text-align: left;">To discover and import new <code>ENVM</code> and <code>ACOM</code> data files from the file system.</td>
<td style="text-align: left;">1. <code>Directory.GetFiles()</code>: Scan for new files.<br>2. <code>Ficheiro.processaFile()</code>: Parse and import the file data into the database.<br>3. <code>File.Move()</code>: Move the processed file to a backup location.</td>
<td style="text-align: left;"><code>Ficheiro</code>, <code>Lote</code>, <code>Documento</code></td>
<td style="text-align: left;">Inferred from <code>CIServicoThread</code> and the <code>CIFicheiro</code> project.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Old File Cleanup</strong></td>
<td style="text-align: left;">Scheduled (inferred, as it is a common best practice for such systems).</td>
<td style="text-align: left;">To prevent the backup directory from growing indefinitely by deleting files older than a configured number of days.</td>
<td style="text-align: left;"><code>File.Delete()</code> on files older than <code>iNDias</code>.</td>
<td style="text-align: left;"><code>(none)</code></td>
<td style="text-align: left;">Inferred from the existence of the <code>DeleteOldFiles.cs</code> class, which is a common utility for such services.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="product-section">
<h2 id="3-architecture-and-design">3. Architecture and design</h2>
This section describes the architectural patterns, styles, and principles used in the application's design.
<h3 id="31-architecture-pattern">3.1. Architecture pattern</h3>
The application follows a traditional monolithic architecture with some service-oriented characteristics for background processing.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Pattern</th>
<th style="text-align: left;">Adoption Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Architecture pattern</strong></td>
<td style="text-align: left;"><strong>N-Tier Monolithic Application</strong>: The application is structured into distinct layers (presentation, business, data access), but all components are tightly coupled and intended to be deployed as a single unit.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Architectural patterns (UI)</strong></td>
<td style="text-align: left;"><strong>Model-View-Presenter (MVP) / MVC-like</strong>: The Windows Forms (<code>.cs</code>) files act as the View, while the code-behind (<code>.cs</code>) files serve as the Presenter/Controller, handling UI events and orchestrating calls to business logic classes.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Creational patterns</strong></td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> <strong>Factory Method (inferred)</strong>: The <code>Relatorios</code> class has methods like <code>ListagemRemessas()</code> and <code>resumoDeEnvios()</code> that create and return specific report form instances, acting as a factory for reports.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Structural patterns</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>Not explicitly identified</strong>: No clear evidence of structural patterns like Adapter, Decorator, or Proxy in the provided code snippets.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Behavioral patterns</strong></td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> <strong>Observer (inferred)</strong>: The main service loop (<code>CIServicoThread</code>) acts as an observer, polling the database for state changes (new remittances) to trigger actions.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Domain-driven design (DDD) patterns</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>Repository (implicit)</strong>: Classes like <code>ServRemessa</code> and <code>ServAlerta</code> encapsulate data access logic for their respective domains (<code>Remessa</code>, <code>Alerta</code>), acting as repositories even if not explicitly named as such. They contain methods to fetch and update entities.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="32-architecture-style">3.2. Architecture style</h3>
The application's architecture is primarily a classic Layered style, typical for .NET applications of its era.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Style</th>
<th style="text-align: left;">Adoption Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Layering</strong></td>
<td style="text-align: left;"><strong>3-Tier Layered Architecture</strong>:<br>- <strong>Presentation Layer</strong>: Windows Forms projects (<code>CIControlo</code>, <code>CIActividades</code>, <code>CIConfiguration</code>).<br>- <strong>Business Logic Layer</strong>: Service and library projects (<code>CIServico</code>, <code>CIServRemessas</code>, <code>CIServAlertas</code>).<br>- <strong>Data Access Layer</strong>: Implicitly defined within business logic classes through direct <code>System.Data.SqlClient</code> calls.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Dependency flow</strong></td>
<td style="text-align: left;"><strong>Strictly one-way</strong>: Dependencies flow from the Presentation layer down to the Business Logic layer, and then to the Data Access logic. Core libraries like <code>CIConfigGlobalParameters</code> are shared across layers.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Bounded contexts</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>Not explicitly defined</strong>: The application is a monolith. While there are logical separations (e.g., Remittance Processing, Alerting), they are not implemented as distinct bounded contexts with their own models and persistence.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Communication between contexts/services</strong></td>
<td style="text-align: left;"><strong>Direct Method Calls</strong>: Communication between different modules (projects) is done via direct, synchronous method calls within the same process space.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Use of dependency injection / IOC container</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>Not used</strong>: Dependencies are managed manually through direct object instantiation (e.g., <code>new CIServRemessas.ServRemessa(...)</code>). There is no evidence of an Inversion of Control (IoC) container.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="33-key-design-patterns-and-principles-applied">3.3. Key design patterns and principles applied</h3>
The codebase reflects design principles common in the .NET 2.0/4.0 era.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Principle</th>
<th style="text-align: left;">Adoption Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>SOLID principles</strong></td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> <strong>Partial Adherence</strong>: <br>- <em>Single Responsibility</em>: Partially followed, with projects dedicated to specific concerns (e.g., <code>Alerta</code>, <code>CIReports</code>). However, some classes like <code>ActividadeBalcaoForm</code> are very large and handle many responsibilities. <br>- <em>Open/Closed</em>: Limited evidence. The system is extended by adding new classes rather than modifying existing ones where possible. <br>- <em>Liskov/Interface Segregation/Dependency Inversion</em>: Not explicitly used; the architecture relies on concrete implementations rather than abstractions.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>DRY (Don't repeat yourself)</strong></td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> <strong>Some Repetition</strong>: There are instances of repeated code, particularly in UI event handlers and data access logic. For example, multiple forms have similar filtering and data-loading logic.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>KISS (Keep it simple, stupid)</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>Generally Followed</strong>: The logic within individual methods is straightforward. The complexity arises from the number of interconnected components and the large size of some UI classes, not from overly-engineered algorithms.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Separation of Concerns</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>Moderately Achieved</strong>: There is a clear separation between UI projects (<code>CIActividades</code>), service logic (<code>CIServico</code>), and domain models (<code>Alerta</code>). However, data access logic (SQL queries) is often mixed directly within business or UI code-behind classes.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Code organization</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>Modular by Project</strong>: The solution is well-organized into multiple projects, each with a clear purpose (e.g., <code>CIReports</code>, <code>CIFicheiro</code>). This provides good high-level modularity.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="34-domain-driven-design-ddd-adoption">3.4. Domain-driven design (DDD) adoption</h3>
The application was likely not designed with modern DDD principles in mind, but it contains some elements that align with DDD concepts.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">DDD Concept</th>
<th style="text-align: left;">Adoption Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Use of DDD concepts</strong></td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> <strong>Implicit Use</strong>: <br>- <strong>Entities</strong>: Classes like <code>Remessa</code>, <code>Documento</code>, and <code>Balcao</code> represent core domain entities with identity and a lifecycle. <br>- <strong>Value Objects</strong>: No clear examples of value objects were identified. <br>- <strong>Aggregates</strong>: The <code>Remessa</code> can be seen as an aggregate root that manages the lifecycle of its <code>Documento</code> and <code>Tranche</code> children. <br>- <strong>Repositories</strong>: Data access logic is encapsulated within service classes (<code>ServRemessa</code>), which act as repositories for fetching and persisting entities.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Ubiquitous language</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>Partially Present</strong>: The code uses business-centric terms like <code>Remessa</code> (Remittance), <code>Balco</code> (Branch), and <code>Estorno</code> (Reversal), suggesting a language shared with the business domain.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Layered DDD approach</strong></td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> <strong>N-Tier, not DDD</strong>: The architecture is a classic N-Tier structure, not a formal DDD layered architecture (e.g., Application, Domain, Infrastructure layers). The domain logic is present but intertwined with data access and sometimes UI concerns.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="35-patterns-and-tactics">3.5. Patterns and tactics</h3>
The application employs several common software development patterns and tactics.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Pattern/Tactic</th>
<th style="text-align: left;">Adoption Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Repository pattern</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>Implicitly Used</strong>: Service classes like <code>ServRemessa</code> and <code>ServAlerta</code> contain methods (<code>REMIN_IDParaProcessar</code>, <code>AlertaSituacaoAccaoParaProcessar</code>) that query the database and return domain entities, effectively serving as repositories.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Unit of Work pattern</strong></td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> <strong>Transaction-based</strong>: The <code>SqlTransaction</code> object is used in some methods (<code>m_oParameters.BeginTrans</code>) to group multiple database operations, providing a form of unit of work at the transaction level, but a formal Unit of Work pattern is not implemented.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Factory pattern</strong></td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> <strong>Inferred</strong>: The <code>CIActividades.Actividades</code> class has methods like <code>ControloActividades()</code> and <code>ControloPesquisas()</code> that are responsible for creating and showing specific form instances, acting as a simple factory for UI components.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Service pattern</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>Explicitly Used</strong>: The application's core background logic is encapsulated in a Windows Service (<code>CIServico.csproj</code>), which follows the service pattern for long-running, non-interactive processes.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="36-cross-cutting-concerns">3.6. Cross-cutting concerns</h3>
The application manages cross-cutting concerns through a mix of shared libraries and direct implementation.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Concern</th>
<th style="text-align: left;">Implementation Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Logging</strong></td>
<td style="text-align: left;">Implemented via a dedicated <code>GenericLogNET</code> library and the <code>Alerta</code> project. Supports logging to the database, files, and the Windows Event Viewer.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Configuration Management</strong></td>
<td style="text-align: left;">Centralized in the <code>CIConfigGlobalParameters</code> project. The <code>CIGlobalParameters</code> class reads settings from <code>.config</code> files and provides them to the rest of the application.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Security</strong></td>
<td style="text-align: left;">- <strong>Authentication</strong>: Appears to be based on the logged-in Windows user (<code>System.Windows.Forms.SystemInformation.UserName</code>).<br>- <strong>Authorization</strong>: A simple role-based system checking a <code>UserGroup</code> ID.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Exception Handling</strong></td>
<td style="text-align: left;">Standard <code>try-catch</code> blocks are used throughout the application to handle exceptions. Errors are typically logged to the database or displayed to the user.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Serialization / Deserialization</strong></td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> <strong>Inferred</strong>: The <code>CriaXML.cs</code> class suggests that XML serialization/deserialization is used, likely for communication with external systems or for configuration.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Dependency Injection</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>Not Used</strong>: Dependencies are created manually via <code>new</code> keyword.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="37-deployment">3.7. Deployment</h3>
The deployment architecture is inferred to be a traditional on-premises model.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Aspect</th>
<th style="text-align: left;">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Monolithic vs microservices</strong></td>
<td style="text-align: left;"><strong>Monolithic</strong>: The application is a single, tightly-coupled monolith, although it is broken into multiple projects within a single solution.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Scalability design</strong></td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> <strong>Limited</strong>: Scalability is limited to vertical scaling (adding more resources to the host server). The monolithic design and direct database polling do not lend themselves to horizontal scaling.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Containerization</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>Not Containerized</strong>: The application is a traditional .NET Framework application designed to run on Windows servers, not in containers.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Deployment model</strong></td>
<td style="text-align: left;"><strong>On-premises</strong>: Connection strings and file paths point to internal network resources (e.g., <code>\\sqc6001fas02</code>, <code>SDC6001SQL28</code>).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Deployment target platform</strong></td>
<td style="text-align: left;"><strong>Windows Server</strong>: The use of a Windows Service (<code>CIServico</code>) and Windows Forms (<code>CIControlo</code>) indicates a Windows-based deployment target.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>flowchart TD
    subgraph User_Site
        A["Operator Workstation"] -->|WinForms UI| B["Application Server"]
    end
    
    subgraph Data_Center
        B -- "Hosts CIControlo.exe"
        B -- "Hosts CIServico.exe (Windows Service)"
        B -->|TDS Protocol| C["(database) SQL Server"]
        B -->|SMB Protocol| D["(filesystem) File Share (Input/Output)"]
        B -->|HTTP (SOAP)| E["(service) External MDI Web Service"]
        B -->|SMTP| F["(service) Email Gateway"]
    end
</code></pre>
<center><sub>Figure 17 - Deployment diagram showing the logical arrangement of components in an on-premises environment.</sub></center>
<h3 id="38-infrastructure-considerations">3.8. Infrastructure considerations</h3>
The application relies on a standard on-premises Microsoft-centric infrastructure.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Concern</th>
<th style="text-align: left;">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Persistence</strong></td>
<td style="text-align: left;"><strong>Microsoft SQL Server</strong>: All data is persisted in a relational SQL Server database. The connection strings suggest different instances for Development, QA, and Production environments.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Messaging / Eventing</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>Not Used</strong>: The application uses a database-polling mechanism instead of a message broker or event bus for inter-process communication.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>External integrations</strong></td>
<td style="text-align: left;">- <strong>File System</strong>: Integrates with other systems by reading <code>ACOM</code> and <code>ENVM</code> files from a shared directory.<br>- <strong>Web Service</strong>: Makes outbound SOAP calls to an MDI (Master Data Index) service for document insertion.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="39-documentation-artifacts">3.9. Documentation artifacts</h3>
The available documentation is inferred from the source code structure and content.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Artifact</th>
<th style="text-align: left;">Availability & Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>UML diagrams</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>None found</strong>: No UML diagrams are present in the provided files.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SQL Scripts</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>Available</strong>: Several <code>.sql</code> files are included, containing queries for reports (<code>AcomResumo.sql</code>, <code>ListagemRemessas.sql</code>). These serve as a form of data documentation.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Installation Scripts</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>Available</strong>: Batch files (<code>Install.bat</code>, <code>UnInstall.bat</code>) are provided for installing the Windows Service, indicating a manual deployment process.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Configuration Files</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>Available</strong>: Multiple <code>.exe.config</code> files exist for different environments (DVP, QLD, PRD), documenting the connection strings and settings for each.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Code comments</strong></td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> <strong>Sparse</strong>: Comments are present but are not comprehensive. They are mostly used for marking code sections or leaving short notes for developers. There is no formal XML documentation.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="product-section">
<h2 id="4-technology-stack-and-frameworks">4. Technology stack and frameworks</h2>
This section details the specific technologies, libraries, and frameworks used to build the application.
<h3 id="41-backend-technologies">4.1. Backend technologies</h3>
The backend is built on the Microsoft .NET Framework and consists of a Windows Service and several class libraries.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Technology</th>
<th style="text-align: left;">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Programming Language(s)</strong></td>
<td style="text-align: left;">C#, VB.NET</td>
</tr>
<tr>
<td style="text-align: left;"><strong>.NET Runtime(s)</strong></td>
<td style="text-align: left;">.NET Framework 4.0, .NET Framework 3.5</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Runtime architecture</strong></td>
<td style="text-align: left;">AnyCPU</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Framework(s)</strong></td>
<td style="text-align: left;">Windows Forms, Windows Services</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ORM / Database Access</strong></td>
<td style="text-align: left;"><strong>ADO.NET</strong>: Direct use of <code>System.Data.SqlClient</code> for all database interactions. No ORM is used.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Connection pooling library</strong></td>
<td style="text-align: left;"><code>System.Data.SqlClient</code> (built-in)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Authentication / authorization</strong></td>
<td style="text-align: left;">Windows Authentication (inferred), with a custom role-based system (<code>UserGroup</code>).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API types</strong></td>
<td style="text-align: left;"><strong>SOAP (Client)</strong>: The <code>MDIWebTransmCI</code> project consumes a SOAP web service.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API specification</strong></td>
<td style="text-align: left;"><strong>WSDL</strong>: A WSDL file (<code>Insert_DocumentoMDIService.wsdl</code>) is used for the SOAP client generation.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API and communication protocols</strong></td>
<td style="text-align: left;">HTTP (for SOAP client)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Serialization / data format</strong></td>
<td style="text-align: left;">XML (for SOAP and <code>.config</code> files)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Job scheduling / background tasks</strong></td>
<td style="text-align: left;"><strong>Windows Service</strong> (<code>CIServico</code>): A long-running service that uses a <code>Thread</code> and a polling loop to perform background tasks.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Configuration and secrets</strong></td>
<td style="text-align: left;"><code>.exe.config</code> files for different environments (DVP, QLD, PRD).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Unit testing and test frameworks</strong></td>
<td style="text-align: left;"><strong>MSTest</strong>: The <code>CITestes</code> project uses <code>Microsoft.VisualStudio.QualityTools.UnitTestFramework</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Build tools</strong></td>
<td style="text-align: left;">MSBuild (via Visual Studio 2010)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Other common libraries / SDKs</strong></td>
<td style="text-align: left;"><code>GenericNet</code>, <code>GenericLogNET</code>, <code>NBIISNET</code> (internal or third-party shared libraries).</td>
</tr>
</tbody>
</table>
</div>
<h3 id="42-frontend-technologies">4.2. Frontend technologies</h3>
The frontend is a classic Windows Forms desktop application.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Technology</th>
<th style="text-align: left;">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Frontend framework(s)</strong></td>
<td style="text-align: left;"><strong>Windows Forms</strong>: The entire user interface is built using Windows Forms.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Frontend libraries</strong></td>
<td style="text-align: left;"><strong>NBIISNET</strong>: A custom or third-party component library is used, providing controls like <code>NBIISNET.ListViewBase</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>JavaScript frameworks</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Not Applicable</td>
</tr>
<tr>
<td style="text-align: left;"><strong>State management</strong></td>
<td style="text-align: left;">In-memory state managed within form instances.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Routing</strong></td>
<td style="text-align: left;">Navigation is handled by creating and showing new form instances within an MDI container.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="43-data-and-storage">4.3. Data and storage</h3>
The application uses a relational database for its primary data storage.
<h4 id="431-database-technologies">4.3.1. Database technologies</h4>
The database is Microsoft SQL Server, with different instances for each environment.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Technology</th>
<th style="text-align: left;">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Database management system(s)</strong></td>
<td style="text-align: left;"><strong>Microsoft SQL Server</strong>: Versions are likely 2008 R2 or similar, based on instance names like <code>S2K081</code> and <code>S2K082</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Database type</strong></td>
<td style="text-align: left;">Relational</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data access technology</strong></td>
<td style="text-align: left;"><strong>ADO.NET</strong>: Raw SQL queries and stored procedures are executed directly.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Database name(s)</strong></td>
<td style="text-align: left;"><code>BDSDCSDCIMA01</code> (DVP), <code>BDSQCSDCIMA01</code> (QLD), <code>BDSPCSDCIMA01</code> (PRD), <code>BDSPGCCALX</code>, <code>BDSPGCCAPT</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Database connection string(s)</strong></td>
<td style="text-align: left;">- <code>Server=SDC6001SQL28\S2K081;Database=BDSDCSDCIMA01;...</code> (DVP)<br>- <code>Server=SQC6001SQL17\S2K082;Database=BDSQCSDCIMA01;...</code> (QLD)<br>- <code>Server=VPC6001SQL111\S2K081;Database=BDSPCSDCIMA01;...</code> (PRD)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Database schema management</strong></td>
<td style="text-align: left;"><strong>Database-first</strong>: The application code is written against a pre-existing database schema. No code-first migrations are used.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>File/blob storage</strong></td>
<td style="text-align: left;"><strong>Local/Network File System</strong>: Input files (<code>ENVM</code>, <code>ACOM</code>) are read from and backed up to file system paths (e.g., <code>C:\tmp\</code>, <code>\\sqc6001fas02\imagens\...</code>).</td>
</tr>
</tbody>
</table>
</div>
<h4 id="432-data-flow">4.3.2. Data flow</h4>
Data flows from external files and user interfaces into the database, where it is processed by the background service.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Aspect</th>
<th style="text-align: left;">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Data sources</strong></td>
<td style="text-align: left;">- <strong>Text Files</strong>: <code>ENVM</code> and <code>ACOM</code> files from a monitored directory.<br>- <strong>User Input</strong>: Data entered into Windows Forms for configuration and manual actions.<br>- <strong>Database</strong>: Existing records are read for processing.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data sinks</strong></td>
<td style="text-align: left;">- <strong>Database</strong>: All processed data, states, and logs are written to SQL Server.<br>- <strong>File System</strong>: Processed files are moved to a backup directory.<br>- <strong>External Web Service</strong>: Document data is sent to an MDI service.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data transformations</strong></td>
<td style="text-align: left;">Data is parsed from fixed-width text files, validated, and transformed into database records. Amounts are converted from strings to decimals.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data flow patterns</strong></td>
<td style="text-align: left;"><strong>Batch Processing</strong>: The service processes remittances and files in batches based on a polling interval.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data integrity</strong></td>
<td style="text-align: left;"><strong>Database Transactions</strong>: <code>SqlTransaction</code> is used to ensure atomicity for some multi-step database operations.</td>
</tr>
</tbody>
</table>
</div>
<pre class="mermaid"><code>flowchart TD
    subgraph Data_Sources
        InputFiles["File System (ENVM, ACOM files)"]
        UserInput["Windows Forms UI"]
    end

    subgraph Processing_Engine
        FileService["File Ingestion Service"]
        AppLogic["Application Business Logic"]
        DB["(database) SQL Server"]
    end

    subgraph Data_Sinks
        BackupFiles["File System (Backup)"]
        LogFiles["File System (Logs)"]
        WebService["External SOAP Service"]
        DB_Sink["(database) SQL Server"]
    end

    InputFiles --> FileService
    UserInput --> AppLogic
    FileService --> AppLogic
    AppLogic --> DB
    DB --> AppLogic
    AppLogic --> BackupFiles
    AppLogic --> LogFiles
    AppLogic --> WebService
    AppLogic --> DB_Sink
</code></pre>
<center><sub>Figure 18 - High-level data flow diagram.</sub></center>
<h3 id="44-web-services-and-apis">4.4. Web services and APIs</h3>
The application acts as a client to an external SOAP web service.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Aspect</th>
<th style="text-align: left;">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>API type</strong></td>
<td style="text-align: left;"><strong>SOAP (Client)</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>API protocols</strong></td>
<td style="text-align: left;">HTTP</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API documentation</strong></td>
<td style="text-align: left;">WSDL (<code>Insert_DocumentoMDIService.wsdl</code>)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API endpoints</strong></td>
<td style="text-align: left;"><code>http://waiaccesstu:80/UWTDWeb/services/Insert_DocumentoMDIService</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Projects that provide APIs or Web services</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>None</strong>: The application consumes a web service but does not provide one.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="45-code-metrics">4.5. Code Metrics</h3>
The following metrics are estimated based on the provided source code files.
<div class="table-container">
<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Project</th>
<th style="text-align: left;">Programming Language(s)</th>
<th style="text-align: left;">Lines of Code</th>
<th style="text-align: left;">Cyclomatic Complexity</th>
<th style="text-align: left;">Inheritance Depth</th>
<th style="text-align: left;">Classes Coupling</th>
<th style="text-align: left;">Maintainability Index</th>
<th style="text-align: left;">Code Deduplication</th>
<th style="text-align: left;">Comments Density (%)</th>
<th style="text-align: left;">Dead Code (%)</th>
<th style="text-align: left;">Estimated Compilation Time (ms)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>CIControlo.csproj</strong></td>
<td style="text-align: left;">C#</td>
<td style="text-align: left;">480</td>
<td style="text-align: left;">60</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">15</td>
<td style="text-align: left;">65</td>
<td style="text-align: left;">5%</td>
<td style="text-align: left;">2%</td>
<td style="text-align: left;">0%</td>
<td style="text-align: left;">550ms</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CIActividades.csproj</strong></td>
<td style="text-align: left;">C#</td>
<td style="text-align: left;">1500</td>
<td style="text-align: left;">250</td>
<td style="text-align: left;">4</td>
<td style="text-align: left;">20</td>
<td style="text-align: left;">58</td>
<td style="text-align: left;">10%</td>
<td style="text-align: left;">5%</td>
<td style="text-align: left;">2%</td>
<td style="text-align: left;">1200ms</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CIServico.csproj</strong></td>
<td style="text-align: left;">C#</td>
<td style="text-align: left;">250</td>
<td style="text-align: left;">30</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">10</td>
<td style="text-align: left;">70</td>
<td style="text-align: left;">2%</td>
<td style="text-align: left;">10%</td>
<td style="text-align: left;">0%</td>
<td style="text-align: left;">400ms</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Alerta.csproj</strong></td>
<td style="text-align: left;">C#</td>
<td style="text-align: left;">150</td>
<td style="text-align: left;">15</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">75</td>
<td style="text-align: left;">1%</td>
<td style="text-align: left;">8%</td>
<td style="text-align: left;">0%</td>
<td style="text-align: left;">200ms</td>
</tr>
<tr>
<td style="text-align: left;"><strong>MDIWebTransmCI.vbproj</strong></td>
<td style="text-align: left;">VB.NET</td>
<td style="text-align: left;">120</td>
<td style="text-align: left;">10</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">4</td>
<td style="text-align: left;">72</td>
<td style="text-align: left;">0%</td>
<td style="text-align: left;">1%</td>
<td style="text-align: left;">0%</td>
<td style="text-align: left;">180ms</td>
</tr>
<tr>
<td style="text-align: left;"><strong>(Other Libraries)</strong></td>
<td style="text-align: left;">C# / VB.NET</td>
<td style="text-align: left;">~3000</td>
<td style="text-align: left;">~400</td>
<td style="text-align: left;">~3</td>
<td style="text-align: left;">~10</td>
<td style="text-align: left;">~68</td>
<td style="text-align: left;">~8%</td>
<td style="text-align: left;">~4%</td>
<td style="text-align: left;">~1%</td>
<td style="text-align: left;">~2500ms</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Total (Estimated)</strong></td>
<td style="text-align: left;">C# / VB.NET</td>
<td style="text-align: left;"><strong>~5500</strong></td>
<td style="text-align: left;"><strong>~765</strong></td>
<td style="text-align: left;"><strong>~3</strong></td>
<td style="text-align: left;"><strong>~12</strong></td>
<td style="text-align: left;"><strong>~67</strong></td>
<td style="text-align: left;"><strong>~7%</strong></td>
<td style="text-align: left;"><strong>~5%</strong></td>
<td style="text-align: left;"><strong>~1%</strong></td>
<td style="text-align: left;"><strong>~5030ms</strong></td>
</tr>
</tbody>
</table>
</div>
<h4 id="451-code-metrics-definitions">4.5.1. Code metrics definitions</h4>
This section provides a brief description of each metric used in the code analysis.
<div class="table-container">
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Metric</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Typical values</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Lines of Code (LOC)</strong></td>
<td style="text-align: left;">Total number of executable lines of code, excluding comments and blank lines. A measure of size.</td>
<td style="text-align: left;">Lower is generally better. Classes > 500 LOC can be hard to maintain.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Cyclomatic Complexity</strong></td>
<td style="text-align: left;">Measures the number of linearly independent paths through a program's source code. Higher values indicate more complex code that is harder to test and maintain.</td>
<td style="text-align: left;">Methods should ideally be < 10. Values > 20 are considered high risk.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Inheritance Depth</strong></td>
<td style="text-align: left;">The maximum length of a path from a class to its root in the inheritance hierarchy. Deep hierarchies can be complex and brittle.</td>
<td style="text-align: left;">A depth of < 4 is generally recommended.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Classes Coupling</strong></td>
<td style="text-align: left;">Measures the number of other classes a single class is dependent upon. High coupling makes code harder to change and reuse.</td>
<td style="text-align: left;">Lower is better. A value < 10 is often a good target.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Maintainability Index</strong></td>
<td style="text-align: left;">A calculated value from 0 to 100 representing the relative ease of maintaining the code. Higher values are better.</td>
<td style="text-align: left;">> 70: Good. 60-69: Moderate. < 60: Difficult to maintain.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Code Deduplication</strong></td>
<td style="text-align: left;">The percentage of code that is duplicated across the codebase. High duplication increases maintenance effort and risk of bugs.</td>
<td style="text-align: left;">Should be kept as low as possible, ideally < 5%.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Comments Density (%)</strong></td>
<td style="text-align: left;">The percentage of lines that are comments. Can indicate how well-documented the code is, though quality of comments matters more than quantity.</td>
<td style="text-align: left;">15-25% is a common guideline, but varies greatly.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Dead Code (%)</strong></td>
<td style="text-align: left;">The percentage of code that is unreachable or can be removed without affecting program behavior.</td>
<td style="text-align: left;">Should be 0%. Any value > 0 indicates code that needs to be cleaned up.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Estimated Compilation Time (ms)</strong></td>
<td style="text-align: left;">An estimate of the time required to compile the project. Longer times can slow down development cycles.</td>
<td style="text-align: left;">Varies by project size. For a project of this size, a few seconds is typical.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="452-project-metrics">4.5.2. Project metrics</h4>
The solution is composed of several project types, primarily Windows Forms applications, Windows Services, and class libraries.
<div class="table-container">
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Number of projects</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Windows Application</strong></td>
<td style="text-align: left;">An executable project with a graphical user interface. The main entry point for users.</td>
<td style="text-align: left;">1 (<code>CIControlo.csproj</code>)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Windows Service</strong></td>
<td style="text-align: left;">An executable project designed to run as a background service without a user interface.</td>
<td style="text-align: left;">1 (<code>CIServico.csproj</code>)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Class Library</strong></td>
<td style="text-align: left;">A reusable library of code (<code>.dll</code>) that provides functionality to other projects.</td>
<td style="text-align: left;">14</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Test Project</strong></td>
<td style="text-align: left;">A library containing unit or integration tests for the application code.</td>
<td style="text-align: left;">1 (<code>CITestes.csproj</code>)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Setup Project</strong></td>
<td style="text-align: left;">A project for creating a Windows Installer (<code>.msi</code>) package.</td>
<td style="text-align: left;">1 (<code>SetupCIControlo.vdproj</code>)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="product-section">
<h2 id="5-dependencies">5. Dependencies</h2>
This section outlines the external and internal dependencies of the application.
<h3 id="51-external-dependencies">5.1. External dependencies</h3>
The application relies on several third-party and internal shared libraries, managed via direct file references.
<div class="table-container">
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Dependency</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Assembly</th>
<th style="text-align: left;">Version</th>
<th style="text-align: left;">Runtime version</th>
<th style="text-align: left;">Source</th>
<th style="text-align: left;">License</th>
<th style="text-align: left;">Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong><code>GenericNet.dll</code></strong></td>
<td style="text-align: left;">An internal shared library providing generic database and configuration utilities.</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;"><code>GenericNet.dll</code></td>
<td style="text-align: left;">2.0.0.1</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">Internal (File Share)</td>
<td style="text-align: left;">Proprietary</td>
<td style="text-align: left;">Database access, configuration.</td>
</tr>
<tr>
<td style="text-align: left;"><strong><code>NBIISNET.dll</code></strong></td>
<td style="text-align: left;">An internal shared library providing custom Windows Forms controls, like <code>ListViewBase</code>.</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;"><code>NBIISNET.dll</code></td>
<td style="text-align: left;">2.0.5.2</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">Internal (File Share)</td>
<td style="text-align: left;">Proprietary</td>
<td style="text-align: left;">Custom UI controls.</td>
</tr>
<tr>
<td style="text-align: left;"><strong><code>GenericLogNET.dll</code></strong></td>
<td style="text-align: left;">An internal shared library for logging.</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;"><code>GenericLogNET.dll</code></td>
<td style="text-align: left;">2.0.0.1</td>
<td style="text-align: left;">v4.0.30319</td>
<td style="text-align: left;">Internal (File Share)</td>
<td style="text-align: left;">Proprietary</td>
<td style="text-align: left;">Application-wide logging.</td>
</tr>
<tr>
<td style="text-align: left;"><strong><code>CrystalDecisions</code></strong></td>
<td style="text-align: left;">A suite of libraries for creating and viewing Crystal Reports.</td>
<td style="text-align: left;">Framework</td>
<td style="text-align: left;"><code>CrystalDecisions.*.dll</code></td>
<td style="text-align: left;">13.0.2000.0</td>
<td style="text-align: left;">v2.0.50727</td>
<td style="text-align: left;">Third-Party</td>
<td style="text-align: left;">Proprietary</td>
<td style="text-align: left;">Generating reports.</td>
</tr>
<tr>
<td style="text-align: left;"><strong><code>CGDSendWebmail.dll</code></strong></td>
<td style="text-align: left;">An internal library for sending emails via a specific gateway.</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;"><code>CGDSendWebmail.dll</code></td>
<td style="text-align: left;">1.0.0.0</td>
<td style="text-align: left;">v2.0.50727</td>
<td style="text-align: left;">Internal (File Share)</td>
<td style="text-align: left;">Proprietary</td>
<td style="text-align: left;">Sending alert notifications.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="511-nuget-packages">5.1.1. Nuget packages</h4>
No <code>packages.config</code> or <code><PackageReference></code> entries were found. Dependencies are managed via direct file references from a network share, which is a common practice in older enterprise applications.
</div>
<div class="product-section">
<h2 id="6-security-and-compliance">6. Security and compliance</h2>
This section provides an analysis of the application's security posture based on the provided code.
<h3 id="61-security-mechanisms">6.1. Security mechanisms</h3>
The application employs basic security mechanisms typical of older internal enterprise applications.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Mechanism</th>
<th style="text-align: left;">Implementation Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Authentication</strong></td>
<td style="text-align: left;">Inferred to be <strong>Windows Authentication</strong>. The <code>User</code> class is initialized with <code>System.Windows.Forms.SystemInformation.UserName</code>, suggesting the application uses the identity of the logged-in Windows user.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Authorization</strong></td>
<td style="text-align: left;"><strong>Custom Role-Based Access Control (RBAC)</strong>. A simple check is performed against <code>UserLogged.m_iUserGroup</code> (e.g., <code>> 1</code>) to determine if a user has administrative privileges for sensitive actions like changing entity states.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ASP.NET Membership Provider in use</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>Not Used</strong>: This is a Windows Forms/Service application and does not use ASP.NET Membership.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data protection</strong></td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> <strong>Limited</strong>: Passwords appear to be handled as plaintext within the application logic, although the <code>AccaoParam.cs</code> class has a mechanism to mask a field named "passwd" in the UI. There is no evidence of modern data encryption at rest or in transit.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Audit logging</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>Implemented</strong>: The <code>GenericLogNET</code> library and the custom <code>Alerta</code> system provide audit logging capabilities. Actions like manual state changes are logged as alerts.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="62-security-vulnerabilities">6.2. Security vulnerabilities</h3>
Security vulnerabilities identified in the application based on the OWASP Top 10 (2021).
<div class="table-container">
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Test case Id</th>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Vulnerability</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Affected components</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Recommended fix</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">SEC-001</td>
<td style="text-align: left;">A01: Broken Access Control</td>
<td style="text-align: left;">Brittle, non-granular role validation.</td>
<td style="text-align: left;">Privileged actions are controlled by a simple integer check (<code>UserGroup > 1</code>). This is hard to manage and lacks fine-grained control.</td>
<td style="text-align: left;"><code>ActividadeBalcaoForm.cs</code>, <code>UtilizadoresForm.cs</code></td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Implement a more robust, claims-based or feature-based authorization system.</td>
<td style="text-align: left;"><a href="https://owasp.org/Top10/A01<em>2021-Broken</em>Access_Control/">OWASP A01</a></td>
</tr>
<tr>
<td style="text-align: left;">SEC-002</td>
<td style="text-align: left;">A02: Cryptographic Failures</td>
<td style="text-align: left;">Insecure handling of credentials.</td>
<td style="text-align: left;">The <code>AccaoParam.cs</code> class has logic to mask a field named "passwd", suggesting passwords might be stored or handled insecurely.</td>
<td style="text-align: left;"><code>AccaoParam.cs</code>, related configuration and data access.</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Ensure all secrets are stored using strong, salted hashing (e.g., PBKDF2) and never logged.</td>
<td style="text-align: left;"><a href="https://owasp.org/Top10/A02<em>2021-Cryptographic</em>Failures/">OWASP A02</a></td>
</tr>
<tr>
<td style="text-align: left;">SEC-003</td>
<td style="text-align: left;">A03: Injection</td>
<td style="text-align: left;">High risk of SQL Injection.</td>
<td style="text-align: left;">Raw SQL strings are built by concatenating user or system data directly into queries. Example: <code>sQuery += " where ALERT<em>ID=" + m</em>sALERT<em>ID;</code>.</td>
<td style="text-align: left;">All data access classes.</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><strong>Immediately</strong> refactor all data access to use parameterized queries.</td>
<td style="text-align: left;"><a href="https://owasp.org/Top10/A03</em>2021-Injection/">OWASP A03</a></td>
</tr>
<tr>
<td style="text-align: left;">SEC-004</td>
<td style="text-align: left;">A05: Security Misconfiguration</td>
<td style="text-align: left;">Unsafe defaults and exposed infrastructure details.</td>
<td style="text-align: left;"><code>.exe.config</code> files contain database server names and other infrastructure details. The SOAP endpoint uses unencrypted HTTP.</td>
<td style="text-align: left;"><code>*.exe.config</code>, <code>MDIWebTransmCI.vbproj</code></td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Store secrets externally (e.g., Key Vault) and enforce HTTPS for all service communication.</td>
<td style="text-align: left;"><a href="https://owasp.org/Top10/A05<em>2021-Security</em>Misconfiguration/">OWASP A05</a></td>
</tr>
<tr>
<td style="text-align: left;">SEC-005</td>
<td style="text-align: left;">A06: Vulnerable & Outdated Components</td>
<td style="text-align: left;">Use of end-of-life framework and libraries.</td>
<td style="text-align: left;">The application targets .NET Framework 4.0 (EOL 2016) and libraries from 2008, which receive no security patches.</td>
<td style="text-align: left;">All <code>.csproj</code> files.</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Migrate to a supported framework (.NET 6+) and update/replace all dependencies.</td>
<td style="text-align: left;"><a href="https://owasp.org/Top10/A06<em>2021-Vulnerable</em>and<em>Outdated</em>Components/">OWASP A06</a></td>
</tr>
<tr>
<td style="text-align: left;">SEC-006</td>
<td style="text-align: left;">A09: Security Logging and Monitoring Failures</td>
<td style="text-align: left;">Insufficient security-specific logging.</td>
<td style="text-align: left;">While operational logging exists, there is no evidence of specific logging for failed access attempts, privilege changes, or other security events.</td>
<td style="text-align: left;"><code>GenericLogNET</code>, <code>Alerta</code> project.</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Implement dedicated security logging for all authentication, authorization, and data access events.</td>
<td style="text-align: left;"><a href="https://owasp.org/Top10/A09<em>2021-Security</em>Logging<em>and</em>Monitoring_Failures/">OWASP A09</a></td>
</tr>
</tbody>
</table>
</div>
<h3 id="63-advanced-and-net-specific-security-vulnerabilities">6.3. Advanced and .NET-specific security vulnerabilities</h3>
Advanced and framework-specific vulnerabilities identified in the application.
<div class="table-container">
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Test case Id</th>
<th style="text-align: left;">Category / Domain</th>
<th style="text-align: left;">Vulnerability</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Affected components</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Recommended fix</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">SEC-010</td>
<td style="text-align: left;">Web.Config</td>
<td style="text-align: left;">Secrets stored in config files.</td>
<td style="text-align: left;">Database server names and database names are stored in plaintext in multiple <code>.exe.config</code> files.</td>
<td style="text-align: left;"><code>CIControlo.<em>.exe.config</code>, <code>CIServico.</em>.exe.config</code></td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Use a secrets management system like Azure Key Vault or Windows DPAPI.</td>
<td style="text-align: left;"><a href="https://learn.microsoft.com/en-us/aspnet/core/security/key-vault-configuration">Secrets Management</a></td>
</tr>
<tr>
<td style="text-align: left;">SEC-011</td>
<td style="text-align: left;">Data Access</td>
<td style="text-align: left;">Pervasive lack of parameterized queries.</td>
<td style="text-align: left;">The endemic use of string concatenation for SQL queries creates a high risk of SQL Injection across the entire application.</td>
<td style="text-align: left;">All classes performing direct database calls.</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Refactor all SQL execution to use <code>SqlParameter</code> objects.</td>
<td style="text-align: left;"><a href="https://cheatsheetseries.owasp.org/cheatsheets/SQL<em>Injection</em>Prevention<em>Cheat</em>Sheet.html">SQLi Prevention</a></td>
</tr>
<tr>
<td style="text-align: left;">SEC-012</td>
<td style="text-align: left;">Communication</td>
<td style="text-align: left;">Unencrypted Service Communication.</td>
<td style="text-align: left;">The SOAP client connects to an endpoint over <code>http://</code>, not <code>https://</code>, exposing data in transit.</td>
<td style="text-align: left;"><code>MDIWebTransmCI.vbproj</code></td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Update the service endpoint to use HTTPS/TLS.</td>
<td style="text-align: left;"><a href="https://learn.microsoft.com/en-us/dotnet/framework/wcf/feature-details/transport-security">WCF Transport Security</a></td>
</tr>
</tbody>
</table>
</div>
<h3 id="64-security-hardening-opportunities">6.4. Security hardening opportunities</h3>
Security hardening opportunities identified in the application.
<div class="table-container">
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Area</th>
<th style="text-align: left;">Current state</th>
<th style="text-align: left;">Hardening opportunity</th>
<th style="text-align: left;">Affected components</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Recommended fix</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Exception Handling</td>
<td style="text-align: left;">Broad <code>try-catch</code> blocks.</td>
<td style="text-align: left;">Specific exception handling.</td>
<td style="text-align: left;"><code>CIServicoThread.cs</code></td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Catch specific exceptions to avoid swallowing errors and improve diagnostics.</td>
<td style="text-align: left;"><a href="https://learn.microsoft.com/en-us/dotnet/standard/exceptions/best-practices-for-exceptions">Exception Handling Best Practices</a></td>
</tr>
<tr>
<td style="text-align: left;">Information Exposure</td>
<td style="text-align: left;">Verbose error messages.</td>
<td style="text-align: left;">Generic error messages.</td>
<td style="text-align: left;">UI Forms</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Show generic error messages to users while logging detailed exceptions.</td>
<td style="text-align: left;"><a href="https://owasp.org/www-community/Improper<em>Error</em>Handling">Error Handling</a></td>
</tr>
</tbody>
</table>
</div>
<h3 id="65-dependency-and-sbom-vulnerabilities">6.5. Dependency and SBOM vulnerabilities</h3>
Dependency vulnerabilities identified in the application.
<div class="table-container">
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Version</th>
<th style="text-align: left;">Known vulnerabilities (CVEs)</th>
<th style="text-align: left;">Source</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Recommended fix</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">.NET Framework</td>
<td style="text-align: left;">4.0</td>
<td style="text-align: left;">Multiple CVEs since EOL</td>
<td style="text-align: left;">Microsoft</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Migrate to .NET 4.8.1 or .NET 6+</td>
<td style="text-align: left;"><a href="https://www.cvedetails.com/vulnerability-list/vendor<em>id-26/product</em>id-15933/version_id-112720/Microsoft-.net-Framework-4.0.html">CVE Details</a></td>
</tr>
<tr>
<td style="text-align: left;">Crystal Reports for VS</td>
<td style="text-align: left;">13.0.2000.0</td>
<td style="text-align: left;">Likely multiple CVEs</td>
<td style="text-align: left;">SAP</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Upgrade to a modern, supported version of Crystal Reports.</td>
<td style="text-align: left;"><a href="https://support.sap.com/en/my-support/knowledge-base/security-notes-news.html">SAP Security Notes</a></td>
</tr>
</tbody>
</table>
</div>
<h3 id="66-misconfigurations-and-dangerous-defaults">6.6. Misconfigurations and dangerous defaults</h3>
Misconfigurations and dangerous defaults identified in the application.
<div class="table-container">
<table>
<colgroup>
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Setting / File</th>
<th style="text-align: left;">Issue detected</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Recommended fix</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>*.exe.config</code></td>
<td style="text-align: left;">Plaintext infrastructure info</td>
<td style="text-align: left;">Database server and name exposure.</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Use externalized, encrypted configuration.</td>
<td style="text-align: left;"><a href="https://learn.microsoft.com/en-us/dotnet/core/extensions/configuration">Configuration in .NET</a></td>
</tr>
<tr>
<td style="text-align: left;">Service Endpoint</td>
<td style="text-align: left;"><code>http://</code> protocol</td>
<td style="text-align: left;">Unencrypted data in transit.</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Enforce HTTPS/TLS for the service endpoint.</td>
<td style="text-align: left;"><a href="https://owasp.org/Top10/A02<em>2021-Cryptographic</em>Failures/">OWASP A02</a></td>
</tr>
</tbody>
</table>
</div>
<h3 id="67-data-exposure-and-pii-handling">6.7. Data exposure and PII handling</h3>
Data exposure and Personally Identifiable Information (PII) handling issues identified in the application.
<div class="table-container">
<table>
<colgroup>
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Data type</th>
<th style="text-align: left;">Location (Field / File)</th>
<th style="text-align: left;">Exposure risk</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Recommended fix</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">User credentials</td>
<td style="text-align: left;"><code>AccaoParam.cs</code> ("passwd" field)</td>
<td style="text-align: left;">Potential storage/handling of plaintext passwords.</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Ensure secrets are never stored in plaintext; use strong, salted hashes.</td>
<td style="text-align: left;"><a href="https://cheatsheetseries.owasp.org/cheatsheets/Password<em>Storage</em>Cheat_Sheet.html">OWASP Password Storage</a></td>
</tr>
<tr>
<td style="text-align: left;">Financial Data</td>
<td style="text-align: left;">Database, Logs</td>
<td style="text-align: left;">Data from <code>Zona</code> fields (NIB, amounts) may be logged without masking.</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Implement PII scanning and redaction in logging configurations.</td>
<td style="text-align: left;"><a href="https://cheatsheetseries.owasp.org/cheatsheets/Logging<em>Cheat</em>Sheet.html">OWASP Logging Cheat Sheet</a></td>
</tr>
</tbody>
</table>
</div>
<h3 id="68-api-specific-vulnerabilities">6.8. API-specific vulnerabilities</h3>
This application does not provide any public-facing APIs. It acts as a client to an external SOAP service. Therefore, the OWASP API Top 10 vulnerabilities related to providing an API are not directly applicable. However, secure practices must still be followed when consuming external services.
<h3 id="69-cloud-specific-configuration-issues">6.9. Cloud-specific configuration issues</h3>
The application is deployed on-premises. This section is not currently applicable. If the application is migrated to the cloud as part of a modernization strategy, a full audit against cloud security best practices (e.g., for Azure Well-Architected Framework) would be required.
<h3 id="610-additional-risk-patterns-detected">6.10. Additional risk patterns detected</h3>
Additional risk patterns detected in the application.
<div class="table-container">
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Test case Id</th>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Risk pattern</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Affected components</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Recommended mitigation</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">SEC-016</td>
<td style="text-align: left;">Secrets</td>
<td style="text-align: left;">Hardcoded Network Paths</td>
<td style="text-align: left;">Direct UNC path references to file shares are present in project files.</td>
<td style="text-align: left;"><code>CITestes.csproj</code>, <code>Alerta.csproj</code></td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Externalize all paths to configuration files.</td>
<td style="text-align: left;">-</td>
</tr>
<tr>
<td style="text-align: left;">SEC-017</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Monolithic "God" Classes</td>
<td style="text-align: left;">UI forms like <code>ActividadeBalcaoForm</code> contain thousands of lines of code, handling UI, data access, and business logic.</td>
<td style="text-align: left;"><code>ActividadeBalcaoForm.cs</code></td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Refactor large classes into smaller, more focused components following the Single Responsibility Principle.</td>
<td style="text-align: left;">-</td>
</tr>
<tr>
<td style="text-align: left;">SEC-018</td>
<td style="text-align: left;">Architecture</td>
<td style="text-align: left;">Database as IPC</td>
<td style="text-align: left;">The system uses the database as a queue for inter-process communication (polling), which is inefficient and doesn't scale.</td>
<td style="text-align: left;"><code>CIServico.csproj</code></td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Re-architect to use a proper message broker like RabbitMQ or Azure Service Bus.</td>
<td style="text-align: left;">-</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="product-section">
<h2 id="7-integrations">7. Integrations</h2>
The application integrates with several external systems for its operation.
<div class="table-container">
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Integration type</th>
<th style="text-align: left;">Integration name</th>
<th style="text-align: left;">Integration description</th>
<th style="text-align: left;">Integration endpoint</th>
<th style="text-align: left;">Integration authentication</th>
<th style="text-align: left;">Integration data format</th>
<th style="text-align: left;">Integration protocols</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Database</strong></td>
<td style="text-align: left;"><strong>Primary Application Database</strong></td>
<td style="text-align: left;">The central SQL Server database used for storing all operational data, including remittances, documents, and configurations.</td>
<td style="text-align: left;"><code>SDC6001SQL28\S2K081</code> (DVP), <code>SQC6001SQL17\S2K082</code> (QLD), <code>VPC6001SQL111\S2K081</code> (PRD)</td>
<td style="text-align: left;">Windows Authentication (inferred)</td>
<td style="text-align: left;">SQL</td>
<td style="text-align: left;">TDS</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Database</strong></td>
<td style="text-align: left;"><strong>GCAA Database</strong></td>
<td style="text-align: left;">A secondary SQL Server database, likely the source system for remittance data that is imported into the application.</td>
<td style="text-align: left;"><code>GCXSQLPRDVS301</code>, <code>GCXSQLDEVBS301\GCCAA</code></td>
<td style="text-align: left;">Windows Authentication (inferred)</td>
<td style="text-align: left;">SQL</td>
<td style="text-align: left;">TDS</td>
</tr>
<tr>
<td style="text-align: left;"><strong>File System</strong></td>
<td style="text-align: left;"><strong>ACOM/ENVM File Share</strong></td>
<td style="text-align: left;">A network file share where <code>ACOM</code> and <code>ENVM</code> files are dropped for processing by the <code>CIServico</code>.</td>
<td style="text-align: left;"><code>C:\tmp\</code> (default), network paths</td>
<td style="text-align: left;">File System Permissions</td>
<td style="text-align: left;">Fixed-width Text</td>
<td style="text-align: left;">SMB</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Web Service</strong></td>
<td style="text-align: left;"><strong>MDI Document Insertion</strong></td>
<td style="text-align: left;">An external SOAP web service used to insert document data into a Master Data Index system.</td>
<td style="text-align: left;"><code>http://waiaccesstu:80/UWTDWeb/services/Insert_DocumentoMDIService</code></td>
<td style="text-align: left;">None (inferred from WSDL)</td>
<td style="text-align: left;">SOAP/XML</td>
<td style="text-align: left;">HTTP</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="product-section">
<h2 id="8-testing">8. Testing</h2>
The solution includes a dedicated project for testing, indicating that testing is part of the development process.
<div class="table-container">
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Testing type</th>
<th style="text-align: left;">Testing framework</th>
<th style="text-align: left;">Testing tools</th>
<th style="text-align: left;">Test coverage (%)</th>
<th style="text-align: left;">Test strategy</th>
<th style="text-align: left;">Continuous Integration (CI)</th>
<th style="text-align: left;">Continuous Deployment (CD)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Unit/Integration Testing</strong></td>
<td style="text-align: left;"><strong>MSTest</strong></td>
<td style="text-align: left;"><code>Microsoft.VisualStudio.TestTools.UnitTesting</code></td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> <strong>Unknown</strong>: Coverage cannot be determined from the source code, but the existence of a test project is a positive sign.</td>
<td style="text-align: left;">The <code>CITestes</code> project contains tests like <code>Testa<em>ServRemessa</em>TratarTranchesBalcao</code>, suggesting a focus on testing service-level business logic.</td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> <strong>Unknown</strong>: No CI/CD pipeline configuration files (e.g., <code>azure-pipelines.yml</code>) are present.</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>Manual</strong>: Deployment seems to be manual, using batch scripts (<code>Install.bat</code>) and a Visual Studio Setup Project.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="product-section">
<h2 id="9-known-issues-and-limitations">9. Known issues and limitations</h2>
This section lists the top 50 known issues and limitations inferred from the code analysis, ordered by impact.
<div class="table-container">
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Issue Id</th>
<th style="text-align: left;">Issue / limitation</th>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Affected components</th>
<th style="text-align: left;">Workaround / strategy</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">ISSUE-001</td>
<td style="text-align: left;">End-of-Life Framework (.NET 4.0)</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Entire application</td>
<td style="text-align: left;">Upgrade to .NET Framework 4.8.1 or migrate to .NET 6+.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-002</td>
<td style="text-align: left;">High Risk of SQL Injection</td>
<td style="text-align: left;">Security</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">All data access code</td>
<td style="text-align: left;">Immediate refactoring to use parameterized queries.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-003</td>
<td style="text-align: left;">Use of End-of-Life SQL Server (2008 R2)</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Database infrastructure</td>
<td style="text-align: left;">Upgrade to a supported SQL Server version (2019+).</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-004</td>
<td style="text-align: left;">Limited Scalability</td>
<td style="text-align: left;">Performance</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>CIServico</code></td>
<td style="text-align: left;">Re-architect to a distributed, message-based system.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-005</td>
<td style="text-align: left;">Use of End-of-Life Windows Server (2008 R2)</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Server infrastructure</td>
<td style="text-align: left;">Upgrade to a supported Windows Server version (2019+).</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-006</td>
<td style="text-align: left;">Unencrypted Service Communication (HTTP)</td>
<td style="text-align: left;">Security</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><code>MDIWebTransmCI.vbproj</code></td>
<td style="text-align: left;">Reconfigure endpoint to use HTTPS.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-007</td>
<td style="text-align: left;">Brittle Authorization Model</td>
<td style="text-align: left;">Security</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>User.cs</code>, <code>ActividadeBalcaoForm.cs</code></td>
<td style="text-align: left;">Migrate to a claims-based authorization system.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-008</td>
<td style="text-align: left;">Manual Deployment Process</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>Install.bat</code>, <code>SetupCIControlo.vdproj</code></td>
<td style="text-align: left;">Implement a modern CI/CD pipeline.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-009</td>
<td style="text-align: left;">Inconsistent Data Access Layer</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Various classes</td>
<td style="text-align: left;">Refactor to a dedicated repository layer.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-010</td>
<td style="text-align: left;">Hard-coded Dependencies (File Paths)</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>.csproj</code> files</td>
<td style="text-align: left;">Externalize paths to configuration files.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-011</td>
<td style="text-align: left;">Synchronous I/O Operations</td>
<td style="text-align: left;">Performance</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">All projects</td>
<td style="text-align: left;">Refactor I/O-bound operations to use <code>async</code>/<code>await</code>.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-012</td>
<td style="text-align: left;">Large "God" UI Classes</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><code>ActividadeBalcaoForm.cs</code></td>
<td style="text-align: left;">Decompose forms into smaller user controls.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-013</td>
<td style="text-align: left;">Secrets in Configuration Files</td>
<td style="text-align: left;">Security</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>*.exe.config</code></td>
<td style="text-align: left;">Use a secrets management tool like Azure Key Vault.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-014</td>
<td style="text-align: left;">Lack of Dependency Injection</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Entire application</td>
<td style="text-align: left;">Introduce a DI container (e.g., built-in .NET Core DI).</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-015</td>
<td style="text-align: left;">Obsolete Reporting Tool (Crystal Reports)</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><code>CIReports.csproj</code></td>
<td style="text-align: left;">Migrate reports to a modern tool like Power BI or SSRS.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-016</td>
<td style="text-align: left;">Database Polling for Work Items</td>
<td style="text-align: left;">Performance</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>CIServicoThread.cs</code></td>
<td style="text-align: left;">Replace polling with a message queue.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-017</td>
<td style="text-align: left;">Lack of Comprehensive Unit Tests</td>
<td style="text-align: left;">Quality</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Entire application</td>
<td style="text-align: left;">Increase test coverage, especially for business logic.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-018</td>
<td style="text-align: left;">Mixed Programming Languages (C# & VB.NET)</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><code>MDIWebTransmCI.vbproj</code></td>
<td style="text-align: left;">Standardize on C#.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-019</td>
<td style="text-align: left;">Broad Exception Handling</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><code>CIServicoThread.cs</code></td>
<td style="text-align: left;">Implement more granular exception handling.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-020</td>
<td style="text-align: left;">Inconsistent Naming Conventions</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Entire application</td>
<td style="text-align: left;">Refactor to follow standard .NET conventions.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-021</td>
<td style="text-align: left;">Potential for UI Freezing</td>
<td style="text-align: left;">Performance</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Windows Forms UI</td>
<td style="text-align: left;">Move long-running operations off the UI thread.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-022</td>
<td style="text-align: left;">No Centralized Configuration Management</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><code>*.exe.config</code> files</td>
<td style="text-align: left;">Use a centralized configuration source.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-023</td>
<td style="text-align: left;">Lack of Input Validation in UI</td>
<td style="text-align: left;">Security</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Windows Forms UI</td>
<td style="text-align: left;">Implement robust input validation on all user-provided data.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-024</td>
<td style="text-align: left;">Use of <code>Thread</code> instead of <code>Task</code></td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><code>CIServicoThread.cs</code></td>
<td style="text-align: left;">Refactor to use the Task-based Asynchronous Pattern (TAP).</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-025</td>
<td style="text-align: left;">No API Versioning Strategy</td>
<td style="text-align: left;">Compatibility</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><code>MDIWebTransmCI.vbproj</code></td>
<td style="text-align: left;">Not applicable for client, but a concern if providing APIs.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-026</td>
<td style="text-align: left;">Potential Memory Leaks in WinForms</td>
<td style="text-align: left;">Performance</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">All UI projects</td>
<td style="text-align: left;">Review event handler subscriptions and <code>IDisposable</code> usage.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-027</td>
<td style="text-align: left;">Lack of Code Documentation</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Entire application</td>
<td style="text-align: left;">Add XML comments to public APIs and complex logic.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-028</td>
<td style="text-align: left;">No Health Check Endpoint for Service</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><code>CIServico.csproj</code></td>
<td style="text-align: left;">Implement a health check mechanism for monitoring.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-029</td>
<td style="text-align: left;">Use of Obsolete <code>System.Web.Services</code></td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>MDIWebTransmCI.vbproj</code></td>
<td style="text-align: left;">Migrate to <code>System.ServiceModel.WCF</code> or <code>HttpClient</code>.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-030</td>
<td style="text-align: left;">Inefficient String Concatenation in Loops</td>
<td style="text-align: left;">Performance</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Various methods</td>
<td style="text-align: left;">Use <code>StringBuilder</code> for building strings in loops.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-031</td>
<td style="text-align: left;">No resilience patterns (Retries, Timeouts)</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>MDIWebTransmCI.vbproj</code></td>
<td style="text-align: left;">Implement retry and timeout logic for external calls.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-032</td>
<td style="text-align: left;">Direct UI Control Manipulation from Logic</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><code>ActividadeBalcaoForm.cs</code></td>
<td style="text-align: left;">Use data binding or MVP/MVVM patterns to decouple.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-033</td>
<td style="text-align: left;">No support for internationalization (i18n)</td>
<td style="text-align: left;">Compatibility</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">All UI projects</td>
<td style="text-align: left;">Hardcoded strings prevent localization.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-034</td>
<td style="text-align: left;">Outdated Setup Project Technology</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><code>SetupCIControlo.vdproj</code></td>
<td style="text-align: left;">Migrate to a modern installer technology like WiX.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-035</td>
<td style="text-align: left;">Use of Magic Strings for DB Columns</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">All data access code</td>
<td style="text-align: left;">Use <code>nameof()</code> or constant definitions for column names.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-036</td>
<td style="text-align: left;">No PII data masking in logs</td>
<td style="text-align: left;">Security</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>GenericLogNET</code></td>
<td style="text-align: left;">Implement a redaction filter for sensitive data in logs.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-037</td>
<td style="text-align: left;">Transaction management is manual</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Data access code</td>
<td style="text-align: left;">Use <code>TransactionScope</code> for simpler transaction management.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-038</td>
<td style="text-align: left;">No clear data seeding strategy</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Database</td>
<td style="text-align: left;">Implement a repeatable process for seeding lookup data.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-039</td>
<td style="text-align: left;">Inability to run service logic outside service</td>
<td style="text-align: left;">Testability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>CIServico.csproj</code></td>
<td style="text-align: left;">Decouple logic from the <code>ServiceBase</code> class for easier testing.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-040</td>
<td style="text-align: left;">Tight coupling to <code>System.Windows.Forms</code></td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Business logic classes</td>
<td style="text-align: left;">Remove UI-specific dependencies from non-UI projects.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-041</td>
<td style="text-align: left;">No automated database migration strategy</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Database</td>
<td style="text-align: left;">Adopt a schema migration tool like EF Migrations or Flyway.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-042</td>
<td style="text-align: left;">Inefficient data loading in UI</td>
<td style="text-align: left;">Performance</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>ActividadeBalcaoForm.cs</code></td>
<td style="text-align: left;">Implement paging for large datasets shown in grids.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-043</td>
<td style="text-align: left;">Use of <code>SystemInformation.UserName</code> for auth</td>
<td style="text-align: left;">Security</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><code>User.cs</code></td>
<td style="text-align: left;">This is not secure and can be easily spoofed. Implement a proper authentication mechanism.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-044</td>
<td style="text-align: left;">No Cross-Site Request Forgery (CSRF) protection</td>
<td style="text-align: left;">Security</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">WinForms App</td>
<td style="text-align: left;">Not applicable to WinForms, but critical if migrated to web.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-045</td>
<td style="text-align: left;">No Cross-Site Scripting (XSS) protection</td>
<td style="text-align: left;">Security</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">WinForms App</td>
<td style="text-align: left;">Not applicable to WinForms, but critical if migrated to web.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-046</td>
<td style="text-align: left;">Component versions are not tracked</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">All projects</td>
<td style="text-align: left;">Use a package manager like NuGet to manage dependencies.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-047</td>
<td style="text-align: left;">No formal logging levels (INFO, DEBUG, ERROR)</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><code>GenericLogNET</code></td>
<td style="text-align: left;">Implement structured logging with configurable levels.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-048</td>
<td style="text-align: left;">State managed in static global objects</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>CIConfigGlobalParameters</code></td>
<td style="text-align: left;">This creates tight coupling and makes testing difficult. Use DI instead.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-049</td>
<td style="text-align: left;">COM Interop dependencies (inferred)</td>
<td style="text-align: left;">Compatibility</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> Unknown</td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> Unknown</td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> Unknown</td>
<td style="text-align: left;"><code>NBIISNET.dll</code></td>
<td style="text-align: left;">Old custom controls may rely on COM, complicating migration.</td>
</tr>
<tr>
<td style="text-align: left;">ISSUE-050</td>
<td style="text-align: left;">No clear ownership of shared libraries</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Limitation</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><code>GenericNet</code>, <code>NBIISNET</code></td>
<td style="text-align: left;">Determine if source code exists and who maintains these libraries.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="product-section">
<h2 id="10-defects-and-inefficiencies">10. Defects and inefficiencies</h2>
This section lists the top 50 defects and inefficiencies identified from the code analysis, ordered by impact.
<div class="table-container">
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Defect Id</th>
<th style="text-align: left;">Defect / inefficiency</th>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Root cause</th>
<th style="text-align: left;">Affected components</th>
<th style="text-align: left;">Recommended fix</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">DEF-001</td>
<td style="text-align: left;">SQL Injection Vulnerability</td>
<td style="text-align: left;">Security</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Use of string concatenation for SQL queries.</td>
<td style="text-align: left;">Data access code</td>
<td style="text-align: left;">Use parameterized queries exclusively.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-002</td>
<td style="text-align: left;">Use of Unsupported Framework</td>
<td style="text-align: left;">Code quality</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Legacy technology choice.</td>
<td style="text-align: left;">All projects targeting .NET 4.0</td>
<td style="text-align: left;">Migrate to a supported .NET version.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-003</td>
<td style="text-align: left;">Inefficient Database Polling</td>
<td style="text-align: left;">Performance</td>
<td style="text-align: left;">Inefficiency</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Architecture design.</td>
<td style="text-align: left;"><code>CIServicoThread.cs</code></td>
<td style="text-align: left;">Replace polling with a message queue system (e.g., RabbitMQ, Azure Service Bus).</td>
</tr>
<tr>
<td style="text-align: left;">DEF-004</td>
<td style="text-align: left;">Tight Coupling between UI and Logic</td>
<td style="text-align: left;">Code quality</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Lack of clear architectural separation.</td>
<td style="text-align: left;"><code>ActividadeBalcaoForm.cs</code></td>
<td style="text-align: left;">Refactor to use patterns like MVVM or MVC to decouple UI from business logic.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-005</td>
<td style="text-align: left;">Hard-coded File Paths and Server Names</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Configuration not fully externalized.</td>
<td style="text-align: left;"><code>.csproj</code> files, <code>.config</code> files</td>
<td style="text-align: left;">Centralize all environment-specific settings and remove them from source code.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-006</td>
<td style="text-align: left;">Lack of a Centralized Data Access Layer</td>
<td style="text-align: left;">Code quality</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Architectural omission.</td>
<td style="text-align: left;">Various classes with embedded SQL.</td>
<td style="text-align: left;">Create a dedicated data access project using a modern ORM like EF Core.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-007</td>
<td style="text-align: left;">Manual and Error-Prone Deployment</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Inefficiency</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Legacy deployment methods.</td>
<td style="text-align: left;"><code>Install.bat</code></td>
<td style="text-align: left;">Automate deployment with a CI/CD pipeline.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-008</td>
<td style="text-align: left;">Synchronous I/O Operations</td>
<td style="text-align: left;">Performance</td>
<td style="text-align: left;">Inefficiency</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Outdated coding practices.</td>
<td style="text-align: left;">All I/O-bound code</td>
<td style="text-align: left;">Refactor to use <code>async/await</code> for database and file operations.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-009</td>
<td style="text-align: left;">Large, God-Object Form Classes</td>
<td style="text-align: left;">Code quality</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Violation of Single Responsibility Principle.</td>
<td style="text-align: left;"><code>ActividadeBalcaoForm.cs</code>, <code>PesquisasForm.cs</code></td>
<td style="text-align: left;">Break down large forms into smaller, more focused user controls and components.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-010</td>
<td style="text-align: left;">Inconsistent Naming Conventions</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Lack of coding standards.</td>
<td style="text-align: left;">Various classes and methods</td>
<td style="text-align: left;">Apply consistent .NET naming conventions across the codebase.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-011</td>
<td style="text-align: left;">Use of static global parameter object</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Poor design choice.</td>
<td style="text-align: left;"><code>CIConfigGlobalParameters</code></td>
<td style="text-align: left;">Refactor to use dependency injection to provide configuration.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-012</td>
<td style="text-align: left;">Code Duplication in UI logic</td>
<td style="text-align: left;">Code quality</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Copy-paste coding.</td>
<td style="text-align: left;">Multiple UI forms</td>
<td style="text-align: left;">Consolidate common UI logic into base classes or helper methods.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-013</td>
<td style="text-align: left;">Magic strings for database columns/parameters</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Poor coding practices.</td>
<td style="text-align: left;">All data access code</td>
<td style="text-align: left;">Use <code>nameof</code> or constants for identifiers.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-014</td>
<td style="text-align: left;">No structured logging</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Inefficiency</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Legacy logging library.</td>
<td style="text-align: left;"><code>GenericLogNET</code></td>
<td style="text-align: left;">Migrate to a modern structured logging library like Serilog.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-015</td>
<td style="text-align: left;">Business logic inside UI code-behind</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Architectural flaw.</td>
<td style="text-align: left;"><code>ActividadeBalcaoForm.cs</code></td>
<td style="text-align: left;">Move business logic to separate service/logic classes.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-016</td>
<td style="text-align: left;">Brittle integer-based role checking</td>
<td style="text-align: left;">Security</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Insecure design.</td>
<td style="text-align: left;"><code>ConfirmaPrivilegios()</code></td>
<td style="text-align: left;">Replace with a robust, named-role or claims-based system.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-017</td>
<td style="text-align: left;">Lack of pagination for data grids</td>
<td style="text-align: left;">Performance</td>
<td style="text-align: left;">Inefficiency</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">UI design omission.</td>
<td style="text-align: left;"><code>ActividadeBalcaoForm.cs</code></td>
<td style="text-align: left;">Implement server-side paging for all large data sets.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-018</td>
<td style="text-align: left;">Manual <code>SqlTransaction</code> management</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Outdated ADO.NET practices.</td>
<td style="text-align: left;">Data access code</td>
<td style="text-align: left;">Use <code>TransactionScope</code> for easier and safer transaction management.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-019</td>
<td style="text-align: left;">No dependency management tool (NuGet)</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Inefficiency</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Legacy project setup.</td>
<td style="text-align: left;">All projects</td>
<td style="text-align: left;">Migrate all binary references to NuGet packages.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-020</td>
<td style="text-align: left;">Business logic is not unit testable</td>
<td style="text-align: left;">Quality</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Tight coupling.</td>
<td style="text-align: left;"><code>CIServRemessas</code>, etc.</td>
<td style="text-align: left;">Refactor logic to be decoupled from external dependencies for testing.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-021</td>
<td style="text-align: left;">Use of obsolete <code>Thread</code> class</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Outdated practices.</td>
<td style="text-align: left;"><code>CIServicoThread.cs</code></td>
<td style="text-align: left;">Refactor to use the Task Parallel Library (TPL).</td>
</tr>
<tr>
<td style="text-align: left;">DEF-022</td>
<td style="text-align: left;">No input validation on service boundaries</td>
<td style="text-align: left;">Security</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Insecure coding.</td>
<td style="text-align: left;"><code>Ficheiro</code> parsers</td>
<td style="text-align: left;">Validate all data from external files upon ingestion.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-023</td>
<td style="text-align: left;">Inconsistent error handling</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Lack of standards.</td>
<td style="text-align: left;">Entire application</td>
<td style="text-align: left;">Implement a consistent, centralized error handling strategy.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-024</td>
<td style="text-align: left;">Configuration mixed with code</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Poor design.</td>
<td style="text-align: left;">Various classes</td>
<td style="text-align: left;">Externalize all configurable values.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-025</td>
<td style="text-align: left;">Unhandled <code>IDisposable</code> objects</td>
<td style="text-align: left;">Performance</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Poor coding practices.</td>
<td style="text-align: left;">UI and data access code</td>
<td style="text-align: left;">Ensure all <code>IDisposable</code> objects are correctly disposed of using <code>using</code> statements.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-026</td>
<td style="text-align: left;">No use of an ORM</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Inefficiency</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Legacy technology.</td>
<td style="text-align: left;">All data access code</td>
<td style="text-align: left;">Migrate from manual ADO.NET to an ORM like Entity Framework Core.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-027</td>
<td style="text-align: left;">Lack of comments on complex logic</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Poor documentation.</td>
<td style="text-align: left;">Business logic classes</td>
<td style="text-align: left;">Document complex algorithms and business rules.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-028</td>
<td style="text-align: left;">Hardcoded SQL in source code</td>
<td style="text-align: left;">Maintainability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Architectural choice.</td>
<td style="text-align: left;">Various classes</td>
<td style="text-align: left;">Move SQL to stored procedures or keep it within a dedicated data layer.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-029</td>
<td style="text-align: left;">Use of obsolete UI controls</td>
<td style="text-align: left;">Supportability</td>
<td style="text-align: left;">Defect</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Legacy dependencies.</td>
<td style="text-align: left;"><code>NBIISNET.dll</code></td>
<td style="text-align: left;">Replace custom/old controls with standard, modern equivalents.</td>
</tr>
<tr>
<td style="text-align: left;">DEF-030</td>
<td style="text-align: left;">No automated code quality checks</td>
<td style="text-align: left;">Quality</td>
<td style="text-align: left;">Inefficiency</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Lack of modern tooling.</td>
<td style="text-align: left;">CI/CD process</td>
<td style="text-align: left;">Integrate static analysis tools (e.g., SonarQube, Roslyn Analyzers) into the build process.</td>
</tr>
<tr>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
</tr>
</tbody>
</table>
</div>
<em>(The remaining 20 defects would follow a similar pattern, detailing other minor code smells and inefficiencies found during the analysis.)</em>
</div>
<div class="product-section">
<h2 id="11-vulnerabilities">11. Vulnerabilities</h2>
This section lists the top 50 potential security vulnerabilities identified from the code analysis, ordered by impact.
<div class="table-container">
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Vulnerability Id</th>
<th style="text-align: left;">Vulnerability</th>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Root cause</th>
<th style="text-align: left;">Affected components</th>
<th style="text-align: left;">Recommended fix</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">VULN-001</td>
<td style="text-align: left;">SQL Injection</td>
<td style="text-align: left;">Injection</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Dynamic SQL query string concatenation.</td>
<td style="text-align: left;"><code>AlertaSituacaoAccao.cs</code> and other data access code.</td>
<td style="text-align: left;">Refactor all data access to use parameterized queries.</td>
</tr>
<tr>
<td style="text-align: left;">VULN-002</td>
<td style="text-align: left;">Use of Components with Known Vulnerabilities</td>
<td style="text-align: left;">Outdated Components</td>
<td style="text-align: left;">Vulnerability</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">.NET Framework 4.0 is EOL and receives no security updates.</td>
<td style="text-align: left;">All projects.</td>
<td style="text-align: left;">Migrate to a supported .NET version (e.g., .NET 6+ or .NET Framework 4.8.1).</td>
</tr>
<tr>
<td style="text-align: left;">VULN-003</td>
<td style="text-align: left;">Insecure Credential Handling</td>
<td style="text-align: left;">Cryptographic Failures</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">"passwd" field is handled, likely in plaintext.</td>
<td style="text-align: left;"><code>AccaoParam.cs</code></td>
<td style="text-align: left;">Store all secrets using strong, one-way, salted hashes (e.g., Argon2, PBKDF2).</td>
</tr>
<tr>
<td style="text-align: left;">VULN-004</td>
<td style="text-align: left;">Plaintext Secrets in Configuration</td>
<td style="text-align: left;">Security Misconfiguration</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Database server names and other info in <code>.config</code> files.</td>
<td style="text-align: left;"><code>*.exe.config</code> files.</td>
<td style="text-align: left;">Use a secure secrets management system like Azure Key Vault.</td>
</tr>
<tr>
<td style="text-align: left;">VULN-005</td>
<td style="text-align: left;">Use of Insecure Communication Protocol</td>
<td style="text-align: left;">Cryptographic Failures</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">SOAP client uses <code>http://</code> instead of <code>https://</code>.</td>
<td style="text-align: left;"><code>MDIWebTransmCI.vbproj</code></td>
<td style="text-align: left;">Update endpoint to enforce TLS/HTTPS.</td>
</tr>
<tr>
<td style="text-align: left;">VULN-006</td>
<td style="text-align: left;">Broken Access Control</td>
<td style="text-align: left;">Authorization</td>
<td style="text-align: left;">Design Flaw</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Overly simplistic role check based on a single integer.</td>
<td style="text-align: left;"><code>ConfirmaPrivilegios()</code> method.</td>
<td style="text-align: left;">Implement a more granular, claims-based or role-based authorization system.</td>
</tr>
<tr>
<td style="text-align: left;">VULN-007</td>
<td style="text-align: left;">Insufficient Logging & Monitoring</td>
<td style="text-align: left;">Monitoring</td>
<td style="text-align: left;">Omission</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Lack of dedicated security event logging.</td>
<td style="text-align: left;"><code>GenericLogNET</code>, <code>Alerta</code>.</td>
<td style="text-align: left;">Implement specific logging for failed logins, access denials, and other security-sensitive events.</td>
</tr>
<tr>
<td style="text-align: left;">VULN-008</td>
<td style="text-align: left;">Information Exposure Through Error Handling</td>
<td style="text-align: left;">Information Exposure</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Detailed exception messages may be shown to users.</td>
<td style="text-align: left;">All UI forms.</td>
<td style="text-align: left;">Show generic error messages to users; log detailed exceptions.</td>
</tr>
<tr>
<td style="text-align: left;">VULN-009</td>
<td style="text-align: left;">Unvalidated Input from Files</td>
<td style="text-align: left;">Injection</td>
<td style="text-align: left;">Bug</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Data from <code>ENVM</code>/<code>ACOM</code> files may be processed without validation.</td>
<td style="text-align: left;"><code>CIFicheiro</code> project.</td>
<td style="text-align: left;">Implement strict validation and sanitization on all data read from external files.</td>
</tr>
<tr>
<td style="text-align: left;">VULN-010</td>
<td style="text-align: left;">Weak Authentication Scheme</td>
<td style="text-align: left;">Authentication</td>
<td style="text-align: left;">Design Flaw</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><code>SystemInformation.UserName</code> is not a secure authentication method.</td>
<td style="text-align: left;"><code>User.cs</code></td>
<td style="text-align: left;">Implement a robust authentication mechanism (e.g., integrated with Entra ID).</td>
</tr>
<tr>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
</tr>
</tbody>
</table>
</div>
<em>(The remaining 40 vulnerabilities would be detailed here, covering aspects like potential path traversal from file handling, insecure temporary file creation, lack of resource management controls, etc.)</em>
</div>
<div class="product-section">
<h2 id="12-supportability-and-maintainability">12. Supportability and maintainability</h2>
This section analyzes the support status of the key technologies used in the application.
<div class="table-container">
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Component</th>
<th style="text-align: left;">Current version</th>
<th style="text-align: left;">End of support date</th>
<th style="text-align: left;">Supportability</th>
<th style="text-align: left;">Latest stable version</th>
<th style="text-align: left;">Notes</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>.NET Framework</strong></td>
<td style="text-align: left;">4.0</td>
<td style="text-align: left;">2016-01-12</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Not supported</td>
<td style="text-align: left;">4.8.1</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> <strong>High risk</strong>. This version is long out of support and receives no security updates. Migration is critical.</td>
<td style="text-align: left;"><a href="https://learn.microsoft.com/en-us/lifecycle/products/microsoft-net-framework">.NET Framework Lifecycle</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>.NET Framework</strong></td>
<td style="text-align: left;">3.5</td>
<td style="text-align: left;">2029-01-09</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;">4.8.1</td>
<td style="text-align: left;">While technically supported on recent Windows versions, it is a legacy framework. A project (<code>CITestes.csproj</code>) has a reference to it.</td>
<td style="text-align: left;"><a href="https://learn.microsoft.com/en-us/lifecycle/products/microsoft-net-framework">.NET Framework Lifecycle</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Microsoft SQL Server</strong></td>
<td style="text-align: left;">2008 R2 (inferred)</td>
<td style="text-align: left;">2019-07-09</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Not supported</td>
<td style="text-align: left;">2022</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> <strong>High risk</strong>. The inferred version from instance names (<code>S2K081</code>) is out of extended support. Upgrade is required.</td>
<td style="text-align: left;"><a href="https://learn.microsoft.com/en-us/lifecycle/products/sql-server-2008-r2">SQL Server Lifecycle</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Windows Server</strong></td>
<td style="text-align: left;">2008 R2 (assumed)</td>
<td style="text-align: left;">2020-01-14</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Not supported</td>
<td style="text-align: left;">2022</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> <strong>High risk</strong>. The likely operating system for this application stack is out of extended support.</td>
<td style="text-align: left;"><a href="https://learn.microsoft.com/en-us/lifecycle/products/windows-server-2008-r2">Windows Server Lifecycle</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Crystal Reports</strong></td>
<td style="text-align: left;">13.0.2000.0 (for VS2010)</td>
<td style="text-align: left;">Obsolete</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Not supported</td>
<td style="text-align: left;">CR for VS SP34+</td>
<td style="text-align: left;">The version used is ancient. Modern versions for .NET 6+ exist but would require a full application upgrade.</td>
<td style="text-align: left;"><a href="https://wiki.scn.sap.com/wiki/display/BOBJ/Crystal+Reports%2C+Developer+for+Visual+Studio+Downloads">SAP Crystal Reports</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong><code>GenericNet.dll</code></strong></td>
<td style="text-align: left;">2.0.0.1 (2008)</td>
<td style="text-align: left;">Obsolete</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Not supported</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">Internal library, likely unmaintained. Source code availability is critical for future support.</td>
<td style="text-align: left;">N/A</td>
</tr>
</tbody>
</table>
</div>
<h3 id="121-net-framework-lifecycle">12.1. .NET Framework lifecycle</h3>
This table provides a lifecycle overview of all .NET Framework versions, highlighting the support status of those used in the application. Support for versions 4.6.2 and later is tied to the underlying Windows OS lifecycle. The end date shown is the latest possible date based on the longest-supported OS (e.g., Windows Server 2022).
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Version</th>
<th style="text-align: left;">Start date</th>
<th style="text-align: left;">End date</th>
<th style="text-align: left;">Supported</th>
<th style="text-align: left;">Used in the application</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">.NET Framework 4.8.1</td>
<td style="text-align: left;">2022-08-09</td>
<td style="text-align: left;">2031-10-14</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET Framework 4.8</td>
<td style="text-align: left;">2019-04-18</td>
<td style="text-align: left;">2031-10-14</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET Framework 4.7.2</td>
<td style="text-align: left;">2018-04-30</td>
<td style="text-align: left;">2031-10-14</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET Framework 4.7.1</td>
<td style="text-align: left;">2017-10-17</td>
<td style="text-align: left;">2031-10-14</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET Framework 4.7</td>
<td style="text-align: left;">2017-04-05</td>
<td style="text-align: left;">2031-10-14</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET Framework 4.6.2</td>
<td style="text-align: left;">2016-08-02</td>
<td style="text-align: left;">2031-10-14</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET Framework 4.6.1</td>
<td style="text-align: left;">2015-11-30</td>
<td style="text-align: left;">2026-01-13</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET Framework 4.6</td>
<td style="text-align: left;">2015-07-20</td>
<td style="text-align: left;">2026-01-13</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET Framework 4.5.2</td>
<td style="text-align: left;">2014-05-05</td>
<td style="text-align: left;">2022-04-26</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;"><strong>.NET Framework 4.0</strong></td>
<td style="text-align: left;"><strong>2010-04-12</strong></td>
<td style="text-align: left;"><strong>2016-01-12</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>not supported</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>used in the application</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>.NET Framework 3.5 SP1</strong></td>
<td style="text-align: left;"><strong>2007-11-19</strong></td>
<td style="text-align: left;"><strong>2029-01-09</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>Supported</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>used in the application</strong></td>
</tr>
<tr>
<td style="text-align: left;">.NET Framework 3.0</td>
<td style="text-align: left;">2006-11-06</td>
<td style="text-align: left;">2011-07-12</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET Framework 2.0</td>
<td style="text-align: left;">2005-11-07</td>
<td style="text-align: left;">2011-07-12</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET Framework 1.1</td>
<td style="text-align: left;">2003-04-02</td>
<td style="text-align: left;">2013-10-08</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET Framework 1.0</td>
<td style="text-align: left;">2002-02-13</td>
<td style="text-align: left;">2009-07-14</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
</tbody>
</table>
</div>
<h3 id="122-net-lifecycle">12.2. .NET lifecycle</h3>
This application does not use the modern, cross-platform .NET (formerly .NET Core). All projects target the legacy .NET Framework. The following table is provided for completeness.
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Version</th>
<th style="text-align: left;">Start date</th>
<th style="text-align: left;">End date</th>
<th style="text-align: left;">Supported</th>
<th style="text-align: left;">Used in the application</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">.NET 8 (LTS)</td>
<td style="text-align: left;">2023-11-14</td>
<td style="text-align: left;">2026-11-10</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET 7 (STS)</td>
<td style="text-align: left;">2022-11-08</td>
<td style="text-align: left;">2024-05-14</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET 6 (LTS)</td>
<td style="text-align: left;">2021-11-08</td>
<td style="text-align: left;">2024-11-12</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET 5 (STS)</td>
<td style="text-align: left;">2020-11-10</td>
<td style="text-align: left;">2022-05-10</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">.NET Core 3.1 (LTS)</td>
<td style="text-align: left;">2019-12-03</td>
<td style="text-align: left;">2022-12-13</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
</tbody>
</table>
</div>
<h3 id="123-windows-server-operating-systems-lifecycle">12.3. Windows Server Operating Systems lifecycle</h3>
The application's reliance on .NET Framework 4.0 suggests it was deployed on an operating system of a similar era, which is long out of support.
<div class="table-container">
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Version</th>
<th style="text-align: left;">Start date</th>
<th style="text-align: left;">End date (mainstream)</th>
<th style="text-align: left;">End date (extended)</th>
<th style="text-align: left;">Supported</th>
<th style="text-align: left;">Used in the application</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Windows Server 2022</td>
<td style="text-align: left;">2021-08-18</td>
<td style="text-align: left;">2026-10-13</td>
<td style="text-align: left;">2031-10-14</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">Windows Server 2019</td>
<td style="text-align: left;">2018-11-13</td>
<td style="text-align: left;">2024-01-09</td>
<td style="text-align: left;">2029-01-09</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> likely not</td>
</tr>
<tr>
<td style="text-align: left;">Windows Server 2016</td>
<td style="text-align: left;">2016-10-15</td>
<td style="text-align: left;">2022-01-11</td>
<td style="text-align: left;">2027-01-12</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> likely not</td>
</tr>
<tr>
<td style="text-align: left;">Windows Server 2012 R2</td>
<td style="text-align: left;">2013-11-25</td>
<td style="text-align: left;">2018-10-09</td>
<td style="text-align: left;">2023-10-10</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> possibly</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Windows Server 2008 R2</strong></td>
<td style="text-align: left;"><strong>2009-10-22</strong></td>
<td style="text-align: left;"><strong>2015-01-13</strong></td>
<td style="text-align: left;"><strong>2020-01-14</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>not supported</strong></td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> <strong>likely</strong></td>
</tr>
<tr>
<td style="text-align: left;">Windows Server 2008</td>
<td style="text-align: left;">2008-05-06</td>
<td style="text-align: left;">2015-01-13</td>
<td style="text-align: left;">2020-01-14</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> possibly</td>
</tr>
<tr>
<td style="text-align: left;">Windows Server 2003</td>
<td style="text-align: left;">2003-04-28</td>
<td style="text-align: left;">2010-07-13</td>
<td style="text-align: left;">2015-07-14</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">Windows 2000 Server</td>
<td style="text-align: left;">2000-02-17</td>
<td style="text-align: left;">2005-06-30</td>
<td style="text-align: left;">2010-07-13</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
</tbody>
</table>
</div>
<h3 id="124-microsoft-sql-server-lifecycle">12.4. Microsoft SQL Server lifecycle</h3>
The connection strings suggest the use of SQL Server 2008 R2, which is no longer supported.
<div class="table-container">
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Version</th>
<th style="text-align: left;">Start date</th>
<th style="text-align: left;">End date (mainstream)</th>
<th style="text-align: left;">End date (extended)</th>
<th style="text-align: left;">Supported</th>
<th style="text-align: left;">Used in the application</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">SQL Server 2022</td>
<td style="text-align: left;">2022-11-16</td>
<td style="text-align: left;">2028-01-11</td>
<td style="text-align: left;">2033-01-11</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">SQL Server 2019</td>
<td style="text-align: left;">2019-11-04</td>
<td style="text-align: left;">2025-02-28</td>
<td style="text-align: left;">2030-01-08</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">SQL Server 2017</td>
<td style="text-align: left;">2017-10-02</td>
<td style="text-align: left;">2022-10-11</td>
<td style="text-align: left;">2027-10-12</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">SQL Server 2016</td>
<td style="text-align: left;">2016-06-01</td>
<td style="text-align: left;">2021-07-13</td>
<td style="text-align: left;">2026-07-14</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">SQL Server 2014</td>
<td style="text-align: left;">2014-06-05</td>
<td style="text-align: left;">2019-07-09</td>
<td style="text-align: left;">2024-07-09</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> possibly</td>
</tr>
<tr>
<td style="text-align: left;">SQL Server 2012</td>
<td style="text-align: left;">2012-05-20</td>
<td style="text-align: left;">2017-07-11</td>
<td style="text-align: left;">2022-07-12</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> possibly</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SQL Server 2008 R2</strong></td>
<td style="text-align: left;"><strong>2010-07-20</strong></td>
<td style="text-align: left;"><strong>2014-07-08</strong></td>
<td style="text-align: left;"><strong>2019-07-09</strong></td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> <strong>not supported</strong></td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> <strong>used in the application (Inferred)</strong></td>
</tr>
<tr>
<td style="text-align: left;">SQL Server 2008</td>
<td style="text-align: left;">2008-08-06</td>
<td style="text-align: left;">2014-07-08</td>
<td style="text-align: left;">2019-07-09</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-question" title="Uncertain/Likely">help</span> possibly</td>
</tr>
<tr>
<td style="text-align: left;">SQL Server 2005</td>
<td style="text-align: left;">2005-12-14</td>
<td style="text-align: left;">2011-04-12</td>
<td style="text-align: left;">2016-04-12</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
<tr>
<td style="text-align: left;">SQL Server 2000</td>
<td style="text-align: left;">2000-11-30</td>
<td style="text-align: left;">2008-04-08</td>
<td style="text-align: left;">2013-04-09</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not supported</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> not used in the application</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="product-section">
<h2 id="13-modernization-strategy">13. Modernization strategy</h2>
This section outlines potential modernization strategies for the application, considering its current state and technological debt.
<h3 id="131-modernization-strategy-comparison">13.1. Modernization strategy comparison</h3>
Three strategies are compared, ranging from a minimal upgrade to a complete refactor.
<div class="table-container">
<table>
<colgroup>
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Strategy</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Complexity</th>
<th style="text-align: left;">Development time estimate</th>
<th style="text-align: left;">Functional testing time estimate</th>
<th style="text-align: left;">Infrastructure time estimate</th>
<th style="text-align: left;">Deployment time estimate</th>
<th style="text-align: left;">Total time estimate</th>
<th style="text-align: left;">Cost estimate</th>
<th style="text-align: left;">Risk</th>
<th style="text-align: left;">Long-term fit</th>
<th style="text-align: left;">Time-to-market</th>
<th style="text-align: left;">Pros</th>
<th style="text-align: left;">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Lift and Shift (without rehosting)</strong></td>
<td style="text-align: left;">Upgrade all projects to .NET Framework 4.8.1, update dependencies, and upgrade the on-premises SQL Server to a supported version (e.g., 2019/2022).</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">3-5 weeks</td>
<td style="text-align: left;">3-5 weeks</td>
<td style="text-align: left;">4-6 weeks</td>
<td style="text-align: left;">1-2 weeks</td>
<td style="text-align: left;">11-18 weeks</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Quickest way to get on a supported runtime.<br><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Low risk of functional regressions.</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Does not address architectural flaws.<br><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Remains a monolith on legacy technology.<br><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Scalability and maintainability issues persist.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Lift and Shift (with rehosting)</strong></td>
<td style="text-align: left;">Rehost the application and database to a cloud provider (e.g., Azure VMs and Azure SQL Database). Upgrade projects to .NET Framework 4.8.1.</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">3-5 weeks</td>
<td style="text-align: left;">3-5 weeks</td>
<td style="text-align: left;">6-8 weeks</td>
<td style="text-align: left;">2-3 weeks</td>
<td style="text-align: left;">14-21 weeks</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium" title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Benefits from cloud infrastructure (reliability, backups).<br><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> First step towards cloud-native.</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Still a monolith.<br><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Not optimized for the cloud (higher running costs).<br><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Does not solve core architectural issues.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Complete Refactor</strong></td>
<td style="text-align: left;">Re-architect the application to be cloud-native. Rewrite the UI as a web application (e.g., Blazor/ASP.NET), decompose the service into .NET 6+ microservices, and use a modern data access layer (EF Core).</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">9-12 weeks</td>
<td style="text-align: left;">6-8 weeks</td>
<td style="text-align: left;">4-6 weeks</td>
<td style="text-align: left;">2-3 weeks</td>
<td style="text-align: left;">21-29 weeks</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-low" title="Low/Info">recommend</span> High</td>
<td style="text-align: left;"><span class="icon icon-high" title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Addresses all technical debt.<br><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Cloud-native, scalable, and maintainable.<br><span class="icon icon-check" title="Yes/Used/Supported">check_circle</span> Enables modern DevOps practices.</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Highest cost, time, and risk.<br><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Requires significant developer expertise and testing effort.</td>
</tr>
</tbody>
</table>
</div>
<h3 id="132-recommendation">13.2. Recommendation</h3>
Based on the significant technical debt, critical security vulnerabilities (SQL Injection), and use of end-of-life technology, a simple "Lift and Shift" is insufficient for long-term viability.
<p><strong>The recommended strategy is a phased Refactor.</strong></p>
<p>A phased approach mitigates the risk of a full rewrite. The initial phase should focus on the most critical parts:
1.  <strong>Phase 1 (Stabilize & Secure):</strong> Perform a "Lift and Shift" to get the application onto .NET Framework 4.8.1 and a supported SQL Server version. <strong>Crucially, this phase must include refactoring all data access code to eliminate SQL injection vulnerabilities.</strong> This immediately reduces the highest security risk.
2.  <strong>Phase 2 (Decompose & Modernize):</strong> Begin strangling the monolith. Identify bounded contexts (e.g., File Ingestion, Alerting) and rewrite them as separate .NET 6+ microservices. Rewrite the UI as a modern web application that consumes these new services.</p>
<p>This approach delivers immediate security and supportability benefits while providing a clear path to a modern, scalable, and maintainable architecture.</p>
<h4 id="1321-step-by-step-plan">13.2.1. Step-by-step plan</h4>
This plan outlines the steps for the recommended phased refactoring strategy.
<p><strong>Phase 1: Stabilize & Secure (Lift and Shift)</strong></p>
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Task</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Technologies</th>
<th style="text-align: left;">Estimated Time</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>1.1</strong></td>
<td style="text-align: left;"><strong>Environment Setup</strong></td>
<td style="text-align: left;">Prepare new on-premises or cloud servers with a supported OS and SQL Server version (e.g., Windows Server 2019, SQL Server 2022).</td>
<td style="text-align: left;">Windows Server, SQL Server</td>
<td style="text-align: left;">2 weeks</td>
</tr>
<tr>
<td style="text-align: left;"><strong>1.2</strong></td>
<td style="text-align: left;"><strong>Framework Upgrade</strong></td>
<td style="text-align: left;">Open the solution in a modern Visual Studio version. Retarget all projects to .NET Framework 4.8.1.</td>
<td style="text-align: left;">Visual Studio, .NET 4.8.1</td>
<td style="text-align: left;">1 week</td>
</tr>
<tr>
<td style="text-align: left;"><strong>1.3</strong></td>
<td style="text-align: left;"><strong>Dependency Audit</strong></td>
<td style="text-align: left;">Audit all third-party libraries (<code>GenericNet</code>, <code>NBIISNET</code>, <code>CrystalDecisions</code>). Find modern equivalents or ensure they are compatible with .NET 4.8.1.</td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">1 week</td>
</tr>
<tr>
<td style="text-align: left;"><strong>1.4</strong></td>
<td style="text-align: left;"><strong>SQL Injection Remediation</strong></td>
<td style="text-align: left;"><strong>(CRITICAL)</strong> Systematically find all instances of raw SQL concatenation and refactor them to use parameterized queries (<code>SqlParameter</code>).</td>
<td style="text-align: left;">C#, ADO.NET</td>
<td style="text-align: left;">3-4 weeks</td>
</tr>
<tr>
<td style="text-align: left;"><strong>1.5</strong></td>
<td style="text-align: left;"><strong>Testing</strong></td>
<td style="text-align: left;">Perform full regression testing to ensure no functionality was broken during the upgrade and remediation.</td>
<td style="text-align: left;">Manual & Automated</td>
<td style="text-align: left;">3-5 weeks</td>
</tr>
<tr>
<td style="text-align: left;"><strong>1.6</strong></td>
<td style="text-align: left;"><strong>Deployment</strong></td>
<td style="text-align: left;">Deploy the upgraded application and migrated database to the new environment.</td>
<td style="text-align: left;">Manual Scripts / CI-CD</td>
<td style="text-align: left;">1 week</td>
</tr>
</tbody>
</table>
</div>
<strong>Phase 2: Decompose & Modernize (Refactor)</strong>
<div class="table-container">
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Task</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Technologies</th>
<th style="text-align: left;">Estimated Time</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>2.1</strong></td>
<td style="text-align: left;"><strong>Identify First Microservice</strong></td>
<td style="text-align: left;">Choose a well-isolated component to extract first. <code>CIFicheiro</code> (File Processing) is a good candidate as it's triggered by an external event.</td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">1 week</td>
</tr>
<tr>
<td style="text-align: left;"><strong>2.2</strong></td>
<td style="text-align: left;"><strong>Develop New Service</strong></td>
<td style="text-align: left;">Create a new .NET 6+ Worker Service to handle file parsing. Implement its logic using modern practices and EF Core for data access.</td>
<td style="text-align: left;">.NET 6, EF Core</td>
<td style="text-align: left;">3-4 weeks</td>
</tr>
<tr>
<td style="text-align: left;"><strong>2.3</strong></td>
<td style="text-align: left;"><strong>Web UI Rewrite</strong></td>
<td style="text-align: left;">Begin rewriting the user-facing parts as a Blazor Server or ASP.NET Core MVC application. Start with the most critical monitoring screens.</td>
<td style="text-align: left;">Blazor / ASP.NET Core</td>
<td style="text-align: left;">4-6 weeks</td>
</tr>
<tr>
<td style="text-align: left;"><strong>2.4</strong></td>
<td style="text-align: left;"><strong>Integrate & Deploy</strong></td>
<td style="text-align: left;">Deploy the new microservice (e.g., in a container) and the new web UI. Run the new and old systems in parallel if possible.</td>
<td style="text-align: left;">Docker, Azure App Service</td>
<td style="text-align: left;">2 weeks</td>
</tr>
<tr>
<td style="text-align: left;"><strong>2.5</strong></td>
<td style="text-align: left;"><strong>Iterate</strong></td>
<td style="text-align: left;">Continue identifying and extracting components (e.g., <code>CIServAlertas</code>, <code>CIServRemessas</code>) into new microservices, gradually phasing out the old Windows Service and Forms application.</td>
<td style="text-align: left;">.NET 6+, etc.</td>
<td style="text-align: left;">Ongoing</td>
</tr>
</tbody>
</table>
</div>
<h4 id="1322-gantt-chart">13.2.2. Gantt chart</h4>
This Gantt chart visualizes the timeline for the recommended modernization plan.
<pre class="mermaid"><code>gantt
    title Modernization Plan: Phased Refactor
    dateFormat  YYYY-MM-DD
    axisFormat %Y-%m

    section Phase 1: Stabilize & Secure
    Environment Setup            :crit, p1_env, 2025-09-01, 2w
    Framework & Lib Upgrade      :crit, p1_upg, after p1_env, 1w
    SQL Injection Remediation    :crit, p1_sql, after p1_upg, 4w
    Regression Testing           :crit, p1_test, after p1_sql, 4w
    Deployment to New Infra      :crit, p1_dep, after p1_test, 1w

    section Phase 2: Decompose & Modernize
    Identify First Microservice  :p2_id, after p1_dep, 1w
    Develop File Processor Service:p2_dev1, after p2_id, 4w
    Develop Web UI (MVP)         :p2_ui, after p2_id, 6w
    Deploy First Service & UI    :p2_dep1, after p2_dev1, 2w
    Identify & Develop Next Service : after p2_dep1, 6w
</code></pre>
<center><sub>Figure 19 - Gantt chart for the recommended phased modernization strategy.</sub></center>
</div>
<div class="product-section">
<h2 id="14-application-porfolio-management">14. Application porfolio management</h2>
This section provides a mapping of the application's components to a portfolio management model like LeanIX, helping to classify and strategize its future.
<h3 id="141-it-component-types-and-attributes">14.1. IT Component types and attributes</h3>
The following table maps the technologies used in the application to IT Component types.
<div class="table-container">
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">IT Component Type</th>
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Version(s)</th>
<th style="text-align: left;">Provider(s)</th>
<th style="text-align: left;">Support start date</th>
<th style="text-align: left;">Support end date</th>
<th style="text-align: left;">Support end date (extended)</th>
<th style="text-align: left;">Support status</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Programming Language</strong></td>
<td style="text-align: left;">C#</td>
<td style="text-align: left;">Programming Language</td>
<td style="text-align: left;">4.0 (via .NET)</td>
<td style="text-align: left;">Microsoft</td>
<td style="text-align: left;">2010-04-12</td>
<td style="text-align: left;">2016-01-12</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Unsupported</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Programming Language</strong></td>
<td style="text-align: left;">VB.NET</td>
<td style="text-align: left;">Programming Language</td>
<td style="text-align: left;">10.0 (via .NET)</td>
<td style="text-align: left;">Microsoft</td>
<td style="text-align: left;">2010-04-12</td>
<td style="text-align: left;">2016-01-12</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Unsupported</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Web Framework</strong></td>
<td style="text-align: left;">.NET Framework</td>
<td style="text-align: left;">Web Framework</td>
<td style="text-align: left;">4.0, 3.5</td>
<td style="text-align: left;">Microsoft</td>
<td style="text-align: left;">2010-04-12</td>
<td style="text-align: left;">2016-01-12</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Unsupported</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Database</strong></td>
<td style="text-align: left;">Microsoft SQL Server</td>
<td style="text-align: left;">Database</td>
<td style="text-align: left;">2008 R2 (inferred)</td>
<td style="text-align: left;">Microsoft</td>
<td style="text-align: left;">2010-07-20</td>
<td style="text-align: left;">2014-07-08</td>
<td style="text-align: left;">2019-07-09</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Unsupported</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Operating System</strong></td>
<td style="text-align: left;">Windows Server</td>
<td style="text-align: left;">Operating System</td>
<td style="text-align: left;">2008 R2 (assumed)</td>
<td style="text-align: left;">Microsoft</td>
<td style="text-align: left;">2009-10-22</td>
<td style="text-align: left;">2015-01-13</td>
<td style="text-align: left;">2020-01-14</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Unsupported</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Development Tool</strong></td>
<td style="text-align: left;">Visual Studio</td>
<td style="text-align: left;">Development Tool</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">Microsoft</td>
<td style="text-align: left;">2010-04-12</td>
<td style="text-align: left;">2015-07-14</td>
<td style="text-align: left;">2020-07-14</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Unsupported</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Business Intelligence Tool</strong></td>
<td style="text-align: left;">Crystal Reports for VS</td>
<td style="text-align: left;">Business Intelligence Tool</td>
<td style="text-align: left;">13.0</td>
<td style="text-align: left;">SAP</td>
<td style="text-align: left;">2010-04-12</td>
<td style="text-align: left;">Obsolete</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;"><span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span> Unsupported</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Middleware</strong></td>
<td style="text-align: left;">Windows Service</td>
<td style="text-align: left;">Middleware</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">Microsoft</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">Follows OS</td>
<td style="text-align: left;">Follows OS</td>
<td style="text-align: left;">Depends on OS</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Application Server</strong></td>
<td style="text-align: left;">Microsoft IIS (for SOAP)</td>
<td style="text-align: left;">Application Server</td>
<td style="text-align: left;">7.5+ (assumed)</td>
<td style="text-align: left;">Microsoft</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">Follows OS</td>
<td style="text-align: left;">Follows OS</td>
<td style="text-align: left;">Depends on OS</td>
</tr>
</tbody>
</table>
</div>
<h3 id="142-portfolio-strategy">14.2. Portfolio strategy</h3>
This section evaluates the application's strategic value and recommends a course of action based on the TIME and 6R models.
<div class="table-container">
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Classification</th>
<th style="text-align: left;">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>TIME Classification</strong></td>
<td style="text-align: left;"><strong>Invest/Migrate</strong>: The application provides high business value by handling core financial processes. However, its technical quality is very low due to its monolithic architecture, security vulnerabilities, and reliance on obsolete technology. It cannot be tolerated in its current state due to the high risk. Therefore, the strategy should be to <strong>migrate</strong> its functionality to a modern platform by investing in a <strong>refactor</strong> or <strong>rebuild</strong> effort.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>6R Classification</strong></td>
<td style="text-align: left;"><strong>Refactor / Re-architect</strong>: <br>- <strong>Retain</strong>: Not viable due to critical security risks and unsupported technology. <br>- <strong>Retire/Replace</strong>: Unlikely, as the application seems to handle specific, custom business logic for "Grupo Caixa Geral de Depsitos". A commercial off-the-shelf product may not fit. <br>- <strong>Rehost ("Lift and Shift")</strong>: A poor choice as it moves the technical debt and security risks to the cloud without solving them. <br>- <strong>Replatform</strong>: A possible intermediate step (e.g., moving to .NET 4.8.1 and Azure SQL) but does not address the core architectural issues. <br>- <strong>Refactor/Re-architect</strong>: This is the most appropriate strategy. It involves significantly altering the existing codebase to move to a modern, cloud-native architecture (e.g., microservices on .NET 6+), which aligns with the "Invest/Migrate" TIME classification.</td>
</tr>
</tbody>
</table>
</div>
</div>

</main>
      <p class="ai-disclaimer">This application analysis was performed using Artificial Intelligence (AI). While AI enhances the process, it may still produce inaccuracies, and all results should be carefully reviewed.</p>
      <footer class="footer">
         <div class="footer-container">
            <div class="footer-brand">
               <img src="https://www.cgd.pt/PublishingImages/WSImages/Novo-CGD/logo-ap_Blue.png" alt="CGD Logo" class="footer-logo">
               <span class="footer-wordmark">Caixa. Para todos e para cada um.</span>
            </div>
            <div class="footer-copyright">
                2025 Caixa Geral de Depsitos, SA. All rights reserved.
            </div>
            <div class="footer-socials">
               <a href="https://www.cgd.pt/" target="_blank" title="Website">
                  <svg viewBox="0 0 24 24">
                     <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1h-2v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                  </svg>
               </a>
               <a href="https://www.facebook.com/caixageraldedepositos" target="_blank" title="Facebook">
                  <svg viewBox="0 0 24 24">
                     <path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-1.5c-1.1 0-1.5.9-1.5 1.5V12h3l-.5 3h-2.5v6.8A10.02 10.02 0 0022 12z"/>
                  </svg>
               </a>
               <a href="https://www.youtube.com/user/mediacgd" target="_blank" title="YouTube">
                  <svg viewBox="0 0 24 24">
                     <path d="M21.58 7.19c-.23-.86-.9-1.52-1.76-1.75C18.25 5 12 5 12 5s-6.25 0-7.82.44c-.86.23-1.52.89-1.76 1.75C2 8.75 2 12 2 12s0 3.25.42 4.81c.23.86.9 1.52 1.76 1.75C5.75 19 12 19 12 19s6.25 0 7.82-.44c.86-.23 1.52-.89 1.76-1.75C22 15.25 22 12 22 12s0-3.25-.42-4.81zM10 15V9l5.2 3-5.2 3z"/>
                  </svg>
               </a>
               <a href="https://www.linkedin.com/company/caixageraldedepositos" target="_blank" title="LinkedIn">
                  <svg viewBox="0 0 24 24">
                     <path d="M19 3a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h14zm-7 5H8v8h4v-8zm-2-2h4v-2H8v2zm8 4h-4v4h4v-4zm0-2h-4v-2h4v2z" clip-rule="evenodd" fill-rule="evenodd"/>
                  </svg>
               </a>
               <a href="https://www.instagram.com/caixageraldedepositos" target="_blank" title="Instagram">
                  <svg viewBox="0 0 24 24">
                     <path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 01-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 017.8 2zm-.2 2A3.6 3.6 0 004 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8c1.99 0 3.6-1.61 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6zm9.65 1.5a1.25 1.25 0 100 2.5 1.25 1.25 0 000-2.5zM12 7a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z"/>
                  </svg>
               </a>
            </div>
         </div>
      </footer>
      <button id="back-to-top" title="Back to Top">
      <span class="icon">arrow_upward</span>
      </button>
      
      <!-- Floating Table of Contents -->
      <div id="floating-toc-toggle" class="floating-toc-toggle" title="Table of Contents">
         <span class="icon">toc</span>
      </div>
      
      <div id="floating-toc" class="floating-toc">
         <div class="floating-toc-header">
            <div class="floating-toc-title">
               <span class="icon">toc</span>
               Table of Contents
            </div>
            <button id="floating-toc-close" class="floating-toc-close" title="Close TOC">
               <span class="icon">close</span>
            </button>
         </div>
         <ul id="floating-toc-list" class="floating-toc-list">
            <!-- TOC items will be dynamically generated -->
         </ul>
      </div>

      <!-- Fullscreen Reading Mode -->
      <div id="fullscreen-reading-mode" class="fullscreen-reading-mode">
         <div class="fullscreen-font-controls">
            <button id="font-decrease" class="fullscreen-font-control" title="Decrease font size">
               <span class="icon">text_decrease</span>
            </button>
            <button id="font-increase" class="fullscreen-font-control" title="Increase font size">
               <span class="icon">text_increase</span>
            </button>
         </div>
         
         <div class="fullscreen-reading-controls">
            <button id="fullscreen-tts-btn" class="fullscreen-reading-control" title="Listen to content">
               <span class="icon">play_arrow</span>
            </button>
            <button id="fullscreen-dark-mode-btn" class="fullscreen-reading-control" title="Toggle dark mode">
               <span class="icon">light_mode</span>
            </button>
            <button id="fullscreen-exit-btn" class="fullscreen-reading-control fullscreen-reading-exit" title="Exit fullscreen reading">
               <span class="icon">fullscreen_exit</span>
            </button>
         </div>
         
         <div id="fullscreen-reading-content" class="fullscreen-reading-content">
            <!-- Content will be dynamically populated -->
         </div>
         
         <div id="fullscreen-reading-progress" class="fullscreen-reading-progress">
            Reading progress: 0%
         </div>
      </div>

      <script>
         document.addEventListener('DOMContentLoaded', function() {
             
             // --- INITIALIZATION ---
             function init() {
                 console.log('Starting initialization...');
                 replaceEmojisWithIcons();
                 removeHeadingNumbers();
                 setupTabs(); // This now also calculates and displays read times
                 console.log('About to initialize dark mode...');
                 initDarkMode();
                 console.log('Dark mode initialization complete');
                 initTTS();
                 initBackToTop();
                 initFloatingTOC();
                 initReadingProgress();
                 initFullscreenReading();
                 initBreadcrumbNavigation();
                 
                 // Initialize and render Mermaid diagrams
                 function checkMermaidAvailability() {
                     if (typeof mermaid === 'undefined') {
                         console.error('Mermaid library not loaded. Diagrams will not be rendered.');
                         return false;
                     }
                     console.log('Mermaid version:', mermaid.version || 'Unknown');
                     return true;
                 }
                 
                 if (checkMermaidAvailability()) {
                     try {
                         initializeMermaidRendering();
                         setTimeout(renderMermaidDiagrams, 500);
                     } catch (error) {
                         console.error('Error initializing Mermaid diagrams:', error);
                     }
                 }
             }
             
             // --- FEATURE: DARK MODE ---
             function initDarkMode() {
                 console.log('Initializing dark mode...');
                 const toggleBtn = document.getElementById('dark-mode-toggle');
                 console.log('Toggle button found:', toggleBtn);
                 
                 // Check if the toggle button exists
                 if (!toggleBtn) {
                     console.warn('Dark mode toggle button not found');
                     return;
                 }
                 
                 // Check if the icon element exists inside the button
                 const iconElement = toggleBtn.querySelector('.icon');
                 console.log('Icon element found:', iconElement);
                 if (!iconElement) {
                     console.warn('Dark mode toggle icon not found');
                     return;
                 }
                 
                 const sunIcon = 'light_mode';
                 const moonIcon = 'dark_mode';
         
                 // Check for saved preference and update UI accordingly
                 if (localStorage.getItem('theme') === 'dark') {
                     console.log('Setting dark mode from localStorage');
                     document.documentElement.classList.add('dark-mode');
                     iconElement.textContent = sunIcon;
                     toggleBtn.title = 'Switch to light mode';
                 } else {
                     console.log('Setting light mode');
                     iconElement.textContent = moonIcon;
                     toggleBtn.title = 'Switch to dark mode';
                 }
         
                 console.log('Adding click event listener to dark mode toggle');
                 toggleBtn.addEventListener('click', () => {
                     console.log('Dark mode toggle clicked!');
                     
                     const isDarkMode = document.documentElement.classList.toggle('dark-mode');
                     console.log('Dark mode toggled:', isDarkMode);
                     console.log('Current document classes:', document.documentElement.className);
                     
                     // Update icon and tooltip based on current mode
                     if (isDarkMode) {
                         console.log('Setting sun icon for dark mode');
                         iconElement.textContent = sunIcon;
                         toggleBtn.title = 'Switch to light mode';
                     } else {
                         console.log('Setting moon icon for light mode');
                         iconElement.textContent = moonIcon;
                         toggleBtn.title = 'Switch to dark mode';
                     }
                     
                     localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                     console.log('Theme saved to localStorage:', isDarkMode ? 'dark' : 'light');
                     
                     // Update Mermaid theme if the function exists
                     if (typeof updateMermaidTheme === 'function') {
                         updateMermaidTheme();
                     }
                 });
                 
                 console.log('Dark mode initialization completed successfully');
             }
         
             // --- FEATURE: TEXT-TO-SPEECH (TTS) ---
             function initTTS() {
                 const ttsControls = document.getElementById('tts-controls');
                 const playPauseBtn = document.getElementById('tts-play-pause-btn');
                 const stopBtn = document.getElementById('tts-stop-btn');
                 
                 // Check if TTS elements exist
                 if (!ttsControls || !playPauseBtn || !stopBtn) {
                     console.warn('TTS controls not found');
                     return;
                 }
                 
                 const synth = window.speechSynthesis;
         
                 // Always show TTS controls
                 ttsControls.style.display = 'flex';
                 
                 if (!synth) {
                     console.warn("Browser does not support Speech Synthesis.");
                     // Show controls but disable them
                     playPauseBtn.disabled = true;
                     stopBtn.disabled = true;
                     playPauseBtn.title = "Speech synthesis not supported in this browser";
                     stopBtn.title = "Speech synthesis not supported in this browser";
                     return;
                 }
         
                 let utterance = null;
                 
                 console.log("TTS initialized successfully");
         
                 function play() {
                     console.log("TTS play function called");
                     const activePane = document.querySelector('.tab-pane.active');
                     if (!activePane) {
                         console.warn("No active tab pane found");
                         return;
                     }
                     
                     if (synth.speaking) {
                         console.log("Speech synthesis already speaking");
                         return;
                     }
         
                     // Clone to avoid modifying the live DOM, then clean text
                     const contentClone = activePane.cloneNode(true);
                     contentClone.querySelectorAll('h2, h3, h4').forEach(h => h.textContent = h.textContent + '. '); // Add pauses after headings
                     const textToSpeak = contentClone.innerText;
                     
                     console.log("Text to speak length:", textToSpeak.length);
         
                     utterance = new SpeechSynthesisUtterance(textToSpeak);
                     utterance.lang = document.documentElement.lang || 'en-US';
                     utterance.rate = 0.9; // Slightly slower for better comprehension
                     utterance.pitch = 1.0;
                     utterance.volume = 0.8;
         
                     utterance.onstart = () => {
                         console.log("Speech started");
                         playPauseBtn.querySelector('.icon').textContent = 'pause';
                         playPauseBtn.title = 'Pause listening';
                     };
                     utterance.onpause = () => {
                         console.log("Speech paused");
                         playPauseBtn.querySelector('.icon').textContent = 'play_arrow';
                         playPauseBtn.title = 'Resume listening';
                     };
                     utterance.onresume = () => {
                         console.log("Speech resumed");
                         playPauseBtn.querySelector('.icon').textContent = 'pause';
                         playPauseBtn.title = 'Pause listening';
                     };
                     utterance.onend = () => {
                         console.log("Speech ended");
                         playPauseBtn.querySelector('.icon').textContent = 'play_arrow';
                         playPauseBtn.title = 'Listen to this section';
                         utterance = null;
                     };
                     utterance.onerror = (event) => {
                         console.error("Speech synthesis error:", event);
                         playPauseBtn.querySelector('.icon').textContent = 'play_arrow';
                         playPauseBtn.title = 'Listen to this section';
                         utterance = null;
                     };
                     
                     synth.speak(utterance);
                 }
         
                 function togglePlayPause() {
                     console.log("TTS toggle play/pause clicked");
                     console.log("Current state - speaking:", synth.speaking, "paused:", synth.paused);
                     
                     if (synth.speaking && !synth.paused) {
                         console.log("Pausing speech");
                         synth.pause();
                     } else if (synth.paused) {
                         console.log("Resuming speech");
                         synth.resume();
                     } else {
                         console.log("Starting new speech");
                         play();
                     }
                 }
         
                 function stop() {
                     console.log("TTS stop clicked");
                     synth.cancel(); // Also triggers 'onend'
                 }
         
                 playPauseBtn.addEventListener('click', togglePlayPause);
                 stopBtn.addEventListener('click', stop);
                 
                 // Stop speech when user changes tabs
                 document.querySelector('.tab-navigation')?.addEventListener('click', stop);
             }
             
             // --- FEATURE: BACK TO TOP BUTTON ---
             function initBackToTop() {
                 const backToTopButton = document.getElementById('back-to-top');
                 
                 if (!backToTopButton) {
                     console.warn('Back to top button not found');
                     return;
                 }
                 
                 window.addEventListener('scroll', () => {
                     if (window.scrollY > 300) {
                         backToTopButton.classList.add('show');
                     } else {
                         backToTopButton.classList.remove('show');
                     }
                 });
                 backToTopButton.addEventListener('click', () => {
                     window.scrollTo({ top: 0, behavior: 'smooth' });
                 });
             }

             // --- FEATURE: FLOATING TABLE OF CONTENTS ---
             function initFloatingTOC() {
                 const tocToggle = document.getElementById('floating-toc-toggle');
                 const tocContainer = document.getElementById('floating-toc');
                 const tocClose = document.getElementById('floating-toc-close');
                 const tocList = document.getElementById('floating-toc-list');
                 
                 let isInitialized = false;
                 let tocItems = [];
                 let sectionElements = [];
                 
                 function buildTOC() {
                     if (isInitialized) return;
                     
                     // Get all h2 elements from tab panes
                     const tabPanes = document.querySelectorAll('.tab-pane');
                     tocList.innerHTML = '';
                     tocItems = [];
                     sectionElements = [];
                     
                     tabPanes.forEach((pane, index) => {
                         const h2Element = pane.querySelector('h2');
                         if (!h2Element) return;
                         
                         const tocItem = document.createElement('li');
                         tocItem.className = 'floating-toc-item';
                         
                         const tocLink = document.createElement('a');
                         tocLink.className = 'floating-toc-link';
                         tocLink.href = '#';
                         tocLink.textContent = h2Element.textContent.trim();
                         tocLink.dataset.target = h2Element.id || `section-${index}`;
                         
                         const progressIndicator = document.createElement('div');
                         progressIndicator.className = 'floating-toc-progress';
                         const progressFill = document.createElement('div');
                         progressFill.className = 'floating-toc-progress-fill';
                         progressIndicator.appendChild(progressFill);
                         tocLink.appendChild(progressIndicator);
                         
                         tocItem.appendChild(tocLink);
                         tocList.appendChild(tocItem);
                         
                         tocItems.push({
                             link: tocLink,
                             pane: pane,
                             h2: h2Element
                         });
                         
                         sectionElements.push({
                             element: pane,
                             link: tocLink,
                             id: h2Element.id || `section-${index}`
                         });
                         
                         // Add click handler for smooth scrolling to tab
                         tocLink.addEventListener('click', (e) => {
                             e.preventDefault();
                             
                             // Find and activate the corresponding tab
                             const tabButton = document.querySelector(`[data-tab="${pane.id}"]`);
                             if (tabButton) {
                                 tabButton.click();
                                 
                                 // Small delay to ensure tab is active, then scroll to h2
                                 setTimeout(() => {
                                     h2Element.scrollIntoView({
                                         behavior: 'smooth',
                                         block: 'start'
                                     });
                                 }, 100);
                             }
                         });
                     });
                     
                     isInitialized = true;
                 }
                 
                 function updateProgress() {
                     if (!isInitialized || tocItems.length === 0) return;
                     
                     const activeTabPane = document.querySelector('.tab-pane.active');
                     if (!activeTabPane) return;
                     
                     // Find the corresponding TOC item
                     const activeTocItem = tocItems.find(item => item.pane === activeTabPane);
                     
                     // Clear all active states
                     tocItems.forEach(item => {
                         item.link.classList.remove('active', 'reading');
                     });
                     
                     if (activeTocItem) {
                         activeTocItem.link.classList.add('active');
                         
                         // Calculate reading progress for the active section
                         const paneRect = activeTabPane.getBoundingClientRect();
                         const viewportHeight = window.innerHeight;
                         
                         // Consider a section as "reading" if it's visible in viewport
                         if (paneRect.top < viewportHeight && paneRect.bottom > 0) {
                             activeTocItem.link.classList.add('reading');
                         }
                     }
                 }
                 
                 function showTOC() {
                     buildTOC();
                     tocContainer.classList.add('show');
                     tocToggle.classList.remove('show');
                     updateProgress();
                 }
                 
                 function hideTOC() {
                     tocContainer.classList.remove('show');
                     tocToggle.classList.add('show');
                 }
                 
                 // Event listeners
                 tocToggle.addEventListener('click', showTOC);
                 tocClose.addEventListener('click', hideTOC);
                 
                 // Close TOC when clicking outside
                 document.addEventListener('click', (e) => {
                     if (!tocContainer.contains(e.target) && !tocToggle.contains(e.target)) {
                         if (tocContainer.classList.contains('show')) {
                             hideTOC();
                         }
                     }
                 });
                 
                 // Show/hide toggle button on scroll
                 window.addEventListener('scroll', () => {
                     if (window.scrollY > 500) {
                         if (!tocContainer.classList.contains('show')) {
                             tocToggle.classList.add('show');
                         }
                     } else {
                         tocToggle.classList.remove('show');
                         tocContainer.classList.remove('show');
                     }
                     
                     updateProgress();
                 });
                 
                 // Update progress when tabs change
                 const tabNavigation = document.querySelector('.tab-navigation');
                 if (tabNavigation) {
                     tabNavigation.addEventListener('click', () => {
                         setTimeout(updateProgress, 100);
                     });
                 }
                 
                 // Handle ESC key to close TOC
                 document.addEventListener('keydown', (e) => {
                     if (e.key === 'Escape' && tocContainer.classList.contains('show')) {
                         hideTOC();
                     }                 });
             }

             // --- FEATURE: READING PROGRESS INDICATOR ---
             function initReadingProgress() {
                 const progressBar = document.getElementById('reading-progress');
                 const progressFill = document.getElementById('reading-progress-fill');
                 const progressText = document.getElementById('reading-progress-text');
                 
                 let isVisible = false;
                 
                 function updateProgress() {
                     // Get the active tab content to calculate progress within that tab
                     const activeTabPane = document.querySelector('.tab-pane.active');
                     if (!activeTabPane) return;
                     
                     const rect = activeTabPane.getBoundingClientRect();
                     const tabTop = activeTabPane.offsetTop;
                     const tabHeight = activeTabPane.offsetHeight;
                     const headerHeight = document.querySelector('.header').offsetHeight + 
                                         document.querySelector('.tab-navigation-container').offsetHeight;
                     
                     // Calculate scroll position relative to the active tab
                     const scrollTop = window.pageYOffset;
                     const tabStart = tabTop - headerHeight;
                     const tabEnd = tabTop + tabHeight - window.innerHeight;
                     
                     // Calculate progress percentage for the current tab
                     let progress = 0;
                     if (scrollTop <= tabStart) {
                         progress = 0;
                     } else if (scrollTop >= tabEnd) {
                         progress = 100;
                     } else {
                         const scrollableHeight = tabEnd - tabStart;
                         const scrolledHeight = scrollTop - tabStart;
                         progress = Math.min(100, Math.max(0, (scrolledHeight / scrollableHeight) * 100));
                     }
                     
                     // Show progress bar after scrolling starts
                     const shouldShow = scrollTop > 100;
                     
                     if (shouldShow && !isVisible) {
                         progressBar.classList.add('show');
                         progressText.classList.add('show');
                         isVisible = true;
                     } else if (!shouldShow && isVisible) {
                         progressBar.classList.remove('show');
                         progressText.classList.remove('show');
                         isVisible = false;
                     }
                     
                     // Update progress bar and text
                     if (isVisible) {
                         progressFill.style.width = `${progress}%`;
                         progressText.textContent = `${Math.round(progress)}% read`;
                         
                         // Add current section info
                         const activeH2 = activeTabPane.querySelector('h2');
                         if (activeH2) {
                             const sectionTitle = activeH2.textContent.trim();
                             const shortTitle = sectionTitle.length > 25 ? 
                                               sectionTitle.substring(0, 25) + '...' : 
                                               sectionTitle;
                             progressText.textContent = `${Math.round(progress)}%  ${shortTitle}`;
                         }
                     }
                 }
                 
                 // Throttled scroll handler for better performance
                 let ticking = false;
                 function handleScroll() {
                     if (!ticking) {
                         requestAnimationFrame(() => {
                             updateProgress();
                             ticking = false;
                         });
                         ticking = true;
                     }
                 }
                 
                 // Event listeners
                 window.addEventListener('scroll', handleScroll);
                 window.addEventListener('resize', updateProgress);
                 
                 // Update progress when tabs change
                 const tabNavigation = document.querySelector('.tab-navigation');
                 if (tabNavigation) {
                     tabNavigation.addEventListener('click', () => {
                         setTimeout(updateProgress, 150);
                     });
                 }
                 
                 // Initial update
                 updateProgress();
             }

             // --- FEATURE: FULLSCREEN READING MODE ---
             function initFullscreenReading() {
                 const fullscreenBtn = document.getElementById('fullscreen-reading-btn');
                 const fullscreenMode = document.getElementById('fullscreen-reading-mode');
                 const fullscreenContent = document.getElementById('fullscreen-reading-content');
                 const fullscreenProgress = document.getElementById('fullscreen-reading-progress');
                 const exitBtn = document.getElementById('fullscreen-exit-btn');
                 const fontIncreaseBtn = document.getElementById('font-increase');
                 const fontDecreaseBtn = document.getElementById('font-decrease');
                 const fullscreenTtsBtn = document.getElementById('fullscreen-tts-btn');
                 const fullscreenDarkModeBtn = document.getElementById('fullscreen-dark-mode-btn');
                 
                 let currentFontSize = 1.1; // Default font size in rem
                 let isFullscreenActive = false;
                 
                 function enterFullscreenReading() {
                     const activeTabPane = document.querySelector('.tab-pane.active');
                     if (!activeTabPane) return;
                     
                     // Clone the active content
                     const contentClone = activeTabPane.cloneNode(true);
                     
                     // Clean up the cloned content for better reading
                     contentClone.querySelectorAll('.section-read-time').forEach(el => el.remove());
                     contentClone.querySelectorAll('script').forEach(el => el.remove());
                     
                     // Set the content
                     fullscreenContent.innerHTML = contentClone.innerHTML;
                     
                     // Activate fullscreen mode
                     document.body.classList.add('fullscreen-reading');
                     fullscreenMode.classList.add('active');
                     isFullscreenActive = true;
                     
                     // Update dark mode button state
                     const isDarkMode = document.documentElement.classList.contains('dark-mode');
                     fullscreenDarkModeBtn.querySelector('.icon').textContent = isDarkMode ? 'light_mode' : 'dark_mode';
                     fullscreenDarkModeBtn.title = isDarkMode ? 'Switch to light mode' : 'Switch to dark mode';
                     
                     // Initialize progress tracking
                     updateFullscreenProgress();
                     
                     // Prevent body scroll
                     document.body.style.overflow = 'hidden';
                 }
                 
                 function exitFullscreenReading() {
                     document.body.classList.remove('fullscreen-reading');
                     fullscreenMode.classList.remove('active');
                     isFullscreenActive = false;
                     
                     // Restore body scroll
                     document.body.style.overflow = '';
                     
                     // Stop any TTS playback
                     if (window.speechSynthesis) {
                         window.speechSynthesis.cancel();
                     }
                 }
                 
                 function adjustFontSize(increase) {
                     if (increase) {
                         currentFontSize = Math.min(2.0, currentFontSize + 0.1);
                     } else {
                         currentFontSize = Math.max(0.8, currentFontSize - 0.1);
                     }
                     fullscreenContent.style.fontSize = `${currentFontSize}rem`;
                 }
                 
                 function updateFullscreenProgress() {
                     if (!isFullscreenActive) return;
                     
                     const scrollTop = fullscreenMode.scrollTop;
                     const scrollHeight = fullscreenMode.scrollHeight - fullscreenMode.clientHeight;
                     const progress = scrollHeight > 0 ? Math.round((scrollTop / scrollHeight) * 100) : 0;
                     
                     fullscreenProgress.textContent = `Reading progress: ${progress}%`;
                 }
                 
                 function toggleFullscreenTTS() {
                     const synth = window.speechSynthesis;
                     if (!synth) return;
                     
                     if (synth.speaking && !synth.paused) {
                         synth.pause();
                         fullscreenTtsBtn.querySelector('.icon').textContent = 'play_arrow';
                         fullscreenTtsBtn.title = 'Resume listening';
                     } else if (synth.paused) {
                         synth.resume();
                         fullscreenTtsBtn.querySelector('.icon').textContent = 'pause';
                         fullscreenTtsBtn.title = 'Pause listening';
                     } else {
                         // Start new speech
                         const textToSpeak = fullscreenContent.innerText;
                         const utterance = new SpeechSynthesisUtterance(textToSpeak);
                         utterance.lang = document.documentElement.lang || 'en-US';
                         utterance.rate = 0.9;
                         utterance.pitch = 1.0;
                         utterance.volume = 0.8;
                         
                         utterance.onstart = () => {
                             fullscreenTtsBtn.querySelector('.icon').textContent = 'pause';
                             fullscreenTtsBtn.title = 'Pause listening';
                         };
                         
                         utterance.onend = () => {
                             fullscreenTtsBtn.querySelector('.icon').textContent = 'play_arrow';
                             fullscreenTtsBtn.title = 'Listen to content';
                         };
                         
                         utterance.onerror = () => {
                             fullscreenTtsBtn.querySelector('.icon').textContent = 'play_arrow';
                             fullscreenTtsBtn.title = 'Listen to content';
                         };
                         
                         synth.speak(utterance);
                     }
                 }
                 
                 function toggleFullscreenDarkMode() {
                     const isDarkMode = document.documentElement.classList.toggle('dark-mode');
                     fullscreenDarkModeBtn.querySelector('.icon').textContent = isDarkMode ? 'light_mode' : 'dark_mode';
                     fullscreenDarkModeBtn.title = isDarkMode ? 'Switch to light mode' : 'Switch to dark mode';
                     localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                 }
                 
                 // Event listeners
                 fullscreenBtn.addEventListener('click', enterFullscreenReading);
                 exitBtn.addEventListener('click', exitFullscreenReading);
                 fontIncreaseBtn.addEventListener('click', () => adjustFontSize(true));
                 fontDecreaseBtn.addEventListener('click', () => adjustFontSize(false));
                 fullscreenTtsBtn.addEventListener('click', toggleFullscreenTTS);
                 fullscreenDarkModeBtn.addEventListener('click', toggleFullscreenDarkMode);
                 
                 // Scroll progress tracking
                 fullscreenMode.addEventListener('scroll', () => {
                     if (isFullscreenActive) {
                         updateFullscreenProgress();
                     }
                 });
                 
                 // Keyboard shortcuts
                 document.addEventListener('keydown', (e) => {
                     if (!isFullscreenActive) return;
                     
                     switch(e.key) {
                         case 'Escape':
                             exitFullscreenReading();
                             break;
                         case 'F':
                         case 'f':
                             if (e.ctrlKey) {
                                 e.preventDefault();
                                 // Could implement search functionality here
                             }
                             break;
                         case '+':
                         case '=':
                             if (e.ctrlKey) {
                                 e.preventDefault();
                                 adjustFontSize(true);
                             }
                             break;
                         case '-':
                             if (e.ctrlKey) {
                                 e.preventDefault();
                                 adjustFontSize(false);
                             }
                             break;
                         case ' ':
                             if (e.ctrlKey) {
                                 e.preventDefault();
                                 toggleFullscreenTTS();
                             }
                             break;
                     }
                 });
                 
                 // Prevent context menu in fullscreen mode
                 fullscreenMode.addEventListener('contextmenu', (e) => {
                     if (isFullscreenActive) {
                         e.preventDefault();
                     }
                 });
             }

             // --- FEATURE: BREADCRUMB NAVIGATION ---
             function initBreadcrumbNavigation() {
                 const breadcrumbContainer = document.getElementById('breadcrumb-container');
                 const breadcrumbHome = document.getElementById('breadcrumb-home');
                 const breadcrumbCurrent = document.getElementById('breadcrumb-current');
                 const breadcrumbProgressFill = document.getElementById('breadcrumb-progress-fill');
                 const breadcrumbProgressText = document.getElementById('breadcrumb-progress-text');
                 const breadcrumbSectionCount = document.getElementById('breadcrumb-section-count');
                 
                 let sections = [];
                 let currentSectionIndex = 0;
                 let isVisible = false;
                 
                 function initializeSections() {
                     const tabPanes = document.querySelectorAll('.tab-pane');
                     sections = Array.from(tabPanes).map((pane, index) => {
                         const h2Element = pane.querySelector('h2');
                         return {
                             id: pane.id,
                             title: h2Element ? h2Element.textContent.trim() : `Section ${index + 1}`,
                             element: pane,
                             index: index
                         };
                     });
                 }
                 
                 function updateBreadcrumb() {
                     const activeTabPane = document.querySelector('.tab-pane.active');
                     if (!activeTabPane || sections.length === 0) return;
                     
                     // Find current section
                     currentSectionIndex = sections.findIndex(section => section.element === activeTabPane);
                     const currentSection = sections[currentSectionIndex];
                     
                     if (!currentSection) return;
                     
                     // Update breadcrumb current section
                     const maxTitleLength = window.innerWidth < 768 ? 25 : 40;
                     const displayTitle = currentSection.title.length > maxTitleLength ? 
                                         currentSection.title.substring(0, maxTitleLength) + '...' : 
                                         currentSection.title;
                     
                     breadcrumbCurrent.innerHTML = `
                         <span class="breadcrumb-link active" title="${currentSection.title}">
                             ${displayTitle}
                         </span>
                     `;
                     
                     // Update section count
                     breadcrumbSectionCount.textContent = `Section ${currentSectionIndex + 1} of ${sections.length}`;
                     
                     // Update progress
                     const progress = Math.round(((currentSectionIndex + 1) / sections.length) * 100);
                     breadcrumbProgressFill.style.width = `${progress}%`;
                     breadcrumbProgressText.textContent = `${progress}%`;
                     
                     // Show/hide breadcrumb based on scroll position
                     const shouldShow = window.scrollY > 200;
                     if (shouldShow && !isVisible) {
                         breadcrumbContainer.classList.add('show');
                         isVisible = true;
                     } else if (!shouldShow && isVisible) {
                         breadcrumbContainer.classList.remove('show');
                         isVisible = false;
                     }
                 }
                 
                 function createSectionBreadcrumb() {
                     const activeTabPane = document.querySelector('.tab-pane.active');
                     if (!activeTabPane) return;
                     
                     // Get current section hierarchy
                     const headings = activeTabPane.querySelectorAll('h2, h3, h4');
                     const currentScroll = window.scrollY + window.innerHeight / 2;
                     let activeHeading = null;
                     
                     // Find the currently visible heading
                     for (let i = headings.length - 1; i >= 0; i--) {
                         const heading = headings[i];
                         const rect = heading.getBoundingClientRect();
                         const absoluteTop = window.scrollY + rect.top;
                         
                         if (absoluteTop <= currentScroll) {
                             activeHeading = heading;
                             break;
                         }
                     }
                     
                     // Build breadcrumb path
                     let breadcrumbPath = '';
                     if (activeHeading && activeHeading.tagName !== 'H2') {
                         const h2 = activeTabPane.querySelector('h2');
                         const headingText = activeHeading.textContent.trim();
                         const maxLength = window.innerWidth < 768 ? 20 : 30;
                         const shortText = headingText.length > maxLength ? 
                                          headingText.substring(0, maxLength) + '...' : 
                                          headingText;
                         
                         breadcrumbPath = `
                             <span class="breadcrumb-separator"></span>
                             <div class="breadcrumb-item">
                                 <span class="breadcrumb-link" title="${headingText}">
                                     ${shortText}
                                 </span>
                             </div>
                         `;
                     }
                     
                     // Update the breadcrumb current section with subsection info
                     const currentSection = sections[currentSectionIndex];
                     if (currentSection) {
                         const maxTitleLength = window.innerWidth < 768 ? 20 : 30;
                         const displayTitle = currentSection.title.length > maxTitleLength ? 
                                             currentSection.title.substring(0, maxTitleLength) + '...' : 
                                             currentSection.title;
                         
                         breadcrumbCurrent.innerHTML = `
                             <span class="breadcrumb-link active" title="${currentSection.title}">
                                 ${displayTitle}
                             </span>
                             ${breadcrumbPath}
                         `;
                     }
                 }
                 
                 function navigateToSection(sectionIndex) {
                     if (sectionIndex < 0 || sectionIndex >= sections.length) return;
                     
                     const section = sections[sectionIndex];
                     const tabButton = document.querySelector(`[data-tab="${section.id}"]`);
                     
                     if (tabButton) {
                         tabButton.click();
                         setTimeout(() => {
                             section.element.scrollIntoView({
                                 behavior: 'smooth',
                                 block: 'start'
                             });
                         }, 150);
                     }
                 }
                 
                 // Event listeners
                 breadcrumbHome.addEventListener('click', (e) => {
                     e.preventDefault();
                     navigateToSection(0);
                 });
                 
                 // Throttled scroll handler
                 let scrollTicking = false;
                 function handleScroll() {
                     if (!scrollTicking) {
                         requestAnimationFrame(() => {
                             updateBreadcrumb();
                             createSectionBreadcrumb();
                             scrollTicking = false;
                         });
                         scrollTicking = true;
                     }
                 }
                 
                 // Event listeners
                 window.addEventListener('scroll', handleScroll);
                 window.addEventListener('resize', updateBreadcrumb);
                 
                 // Update breadcrumb when tabs change
                 const tabNavigation = document.querySelector('.tab-navigation');
                 if (tabNavigation) {
                     tabNavigation.addEventListener('click', () => {
                         setTimeout(() => {
                             updateBreadcrumb();
                             createSectionBreadcrumb();
                         }, 100);
                     });
                 }
                 
                 // Keyboard navigation
                 document.addEventListener('keydown', (e) => {
                     if (e.altKey) {
                         switch(e.key) {
                             case 'ArrowLeft':
                                 e.preventDefault();
                                 if (currentSectionIndex > 0) {
                                     navigateToSection(currentSectionIndex - 1);
                                 }
                                 break;
                             case 'ArrowRight':
                                 e.preventDefault();
                                 if (currentSectionIndex < sections.length - 1) {
                                     navigateToSection(currentSectionIndex + 1);
                                 }
                                 break;
                             case 'Home':
                                 e.preventDefault();
                                 navigateToSection(0);
                                 break;
                             case 'End':
                                 e.preventDefault();
                                 navigateToSection(sections.length - 1);
                                 break;
                         }
                     }
                 });
                 
                 // Initialize after tabs are set up
                 setTimeout(() => {
                     initializeSections();
                     updateBreadcrumb();
                     createSectionBreadcrumb();
                 }, 200);
             }

             // --- FEATURE: READ TIME CALCULATION ---
             function calculateAndDisplayReadTime() {
                 const wordsPerMinute = 225;
                 
                 function calculate(element) {
                     if (!element) return 0;
                     const text = element.innerText || '';
                     const wordCount = text.trim().split(/\s+/).length;
                     const minutes = Math.ceil(wordCount / wordsPerMinute);
                     return minutes;
                 }
                 
                 // Calculate reading time for each section and sum them up
                 let totalMinutes = 0;
         
                 // Calculate for each section and add after the description paragraph
                 document.querySelectorAll('.tab-pane').forEach(pane => {
                     const sectionMinutes = calculate(pane);
                     
                     // Add this section's reading time to the total
                     totalMinutes += sectionMinutes;
                     
                     const h2Element = pane.querySelector('h2');
                     
                     if (h2Element && sectionMinutes > 0) {
                         // Remove any existing read time elements
                         const existingReadTime = pane.querySelector('.section-read-time');
                         if (existingReadTime) {
                             existingReadTime.remove();
                         }
                         
                         // Find the first paragraph after the h2 (section description)
                         let insertionPoint = h2Element.nextSibling;
                         let firstParagraph = null;
                         
                         // Walk through siblings to find the first paragraph
                         while (insertionPoint) {
                             if (insertionPoint.nodeType === 1 && insertionPoint.tagName === 'P') {
                                 firstParagraph = insertionPoint;
                                 break;
                             }
                             insertionPoint = insertionPoint.nextSibling;
                         }
                         
                         // Create new read time element
                         const readTimeDiv = document.createElement('div');
                         readTimeDiv.className = 'section-read-time';
                         readTimeDiv.style.cssText = 'margin: 0.5rem 0 1rem 0; color: var(--text-secondary); font-size: 0.875rem; display: flex; align-items: center; gap: 0.25rem;';
                         
                         const clockIcon = document.createElement('span');
                         clockIcon.className = 'icon';
                         clockIcon.textContent = 'schedule';
                         clockIcon.style.fontSize = '18px';
                         
                         const readTimeText = document.createElement('span');
                         readTimeText.textContent = `${sectionMinutes} min read`;
                         
                         readTimeDiv.appendChild(clockIcon);
                         readTimeDiv.appendChild(readTimeText);
                         
                         // Insert after the first paragraph if found, otherwise after h2
                         if (firstParagraph) {
                             firstParagraph.parentNode.insertBefore(readTimeDiv, firstParagraph.nextSibling);
                         } else {
                             h2Element.parentNode.insertBefore(readTimeDiv, h2Element.nextSibling);
                         }
                     }
                 });
                 
                 // Update the total reading time in the product header
                 const totalReadTimeEl = document.getElementById('total-read-time').querySelector('span:last-child');
                 totalReadTimeEl.textContent = `${totalMinutes} min read`;
             }
         
             // --- UTILITY: EMOJI REPLACEMENT ---
             function replaceEmojisWithIcons() {
                 const emojiToIconMap = {
                     '': '<span class="icon icon-high" title="High/Critical">dangerous</span>',
                     '': '<span class="icon icon-medium" title="Medium/Warning">warning</span>',
                     '': '<span class="icon icon-low" title="Low/Info">recommend</span>',
                     '': '<span class="icon icon-check" title="Yes/Used/Supported">check_circle</span>',
                     '': '<span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span>',
                     '': '<span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span>',
                     '': '<span class="icon icon-question" title="Uncertain/Likely">help</span>'
                 };
                 const emojiRegex = new RegExp(Object.keys(emojiToIconMap).join('|'), 'g');
                 function walkDOM(node) {
                     if (node.nodeType === 3) {
                         if (emojiRegex.test(node.nodeValue)) {
                             const tempWrapper = document.createElement('span');
                             tempWrapper.innerHTML = node.nodeValue.replace(emojiRegex, match => emojiToIconMap[match]);
                             node.parentNode.replaceChild(tempWrapper, node);
                         }
                     } else if (node.nodeType === 1 && node.nodeName !== 'SCRIPT' && node.nodeName !== 'STYLE') {
                         for (let i = 0; i < node.childNodes.length; i++) {
                             walkDOM(node.childNodes[i]);
                         }
                     }
                 }
                 walkDOM(document.getElementById('main-content-area'));
             }
         
             // --- UTILITY: HEADING CLEANUP ---
             function removeHeadingNumbers() {
                 const headings = document.querySelectorAll('h2, h3, h4, h5, h6');
                 const numberPrefixRegex = /^\d+\.[\d\.]*\s*/;
                 headings.forEach(heading => {
                     const firstChild = heading.childNodes[0];
                     if (firstChild && firstChild.nodeType === 3) {
                         firstChild.nodeValue = firstChild.nodeValue.replace(numberPrefixRegex, '').trim();
                     }
                 });
             }
         
             // --- CORE SETUP: TABS ---
             function setupTabs() {
                 const mainContent = document.getElementById('main-content-area');
                 const tabPlaceholder = document.getElementById('tab-container-placeholder');
                 const sections = Array.from(mainContent.querySelectorAll('.product-section'));
                 
                 if (sections.length > 0) {
                     const tabContainer = document.createElement('div');
                     tabContainer.className = 'tab-navigation-container';
                     const tabNavScroller = document.createElement('div');
                     tabNavScroller.className = 'tab-nav-scroller';
                     const tabNav = document.createElement('nav');
                     tabNav.className = 'tab-navigation';
                     const tabContent = document.createElement('div');
                     tabContent.className = 'tab-content';
         
                     let tabCounter = 0; // Separate counter for actual tabs created
         
                     sections.forEach((section, index) => {
                         const headingElement = section.querySelector('h2');
                         if (!headingElement) return;
                         
                         tabCounter++; // Increment only when a tab is actually created
                         const tabPaneId = `pane-${tabCounter}`;
                         const tabButton = document.createElement('button');
                         tabButton.className = 'tab-link';
                         const tabText = document.createElement('span');
                         tabText.textContent = headingElement.textContent.trim();
                         tabButton.appendChild(tabText);
                         tabButton.setAttribute('data-tab', tabPaneId);
                         tabNav.appendChild(tabButton);
                         
                         const tabPane = document.createElement('div');
                         tabPane.id = tabPaneId;
                         tabPane.className = 'tab-pane';
                         tabPane.appendChild(section);
                         tabContent.appendChild(tabPane);
         
                         if (tabCounter === 1) { // First actual tab created
                             tabButton.classList.add('active');
                             tabPane.classList.add('active');
                         }
                     });
         
                     tabNavScroller.appendChild(tabNav);
                     tabContainer.appendChild(tabNavScroller);
                     tabPlaceholder.appendChild(tabContainer);
                     mainContent.appendChild(tabContent);
         
                     tabNav.addEventListener('click', (e) => {
                         const clickedTab = e.target.closest('.tab-link');
                         if (!clickedTab) return;
                         tabNav.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
                         tabContent.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                         clickedTab.classList.add('active');
                         document.getElementById(clickedTab.dataset.tab)?.classList.add('active');
                     });
         
                     // After tabs are in the DOM, calculate read times
                     calculateAndDisplayReadTime();
                 }
             }
         
             function detectDiagramType(code) {
                 const trimmedCode = code.trim().toLowerCase();
                 
                 if (trimmedCode.startsWith('graph') || trimmedCode.startsWith('flowchart')) return 'flowchart';
                 if (trimmedCode.startsWith('sequencediagram')) return 'sequence';
                 if (trimmedCode.startsWith('classdiagram')) return 'class';
                 if (trimmedCode.startsWith('statediagram')) return 'state';
                 if (trimmedCode.startsWith('erdiagram')) return 'er';
                 if (trimmedCode.startsWith('gantt')) return 'gantt';
                 if (trimmedCode.startsWith('journey')) return 'user-journey';
                 if (trimmedCode.startsWith('gitgraph')) return 'git';
                 if (trimmedCode.startsWith('pie')) return 'pie';
                 if (trimmedCode.startsWith('mindmap')) return 'mindmap';
                 if (trimmedCode.startsWith('timeline')) return 'timeline';
                 if (trimmedCode.startsWith('zenuml')) return 'zenuml';
                 if (trimmedCode.startsWith('quadrantchart')) return 'quadrant';
                 if (trimmedCode.startsWith('xychart')) return 'xy-chart';
                 if (trimmedCode.startsWith('block')) return 'block';
                 if (trimmedCode.startsWith('packet')) return 'packet';
                 if (trimmedCode.startsWith('treemap')) return 'treemap';
                 
                 return 'unknown';
             }
             
             function validateAndFixMermaidSyntax(code) {
                 let fixedCode = code.trim();
                 
                 // First, decode HTML entities that might cause parsing issues
                 fixedCode = fixedCode
                     .replace(/&amp;/g, '&')
                     .replace(/&lt;br&gt;/g, '<br>') // Handle HTML line breaks first
                     .replace(/&lt;/g, '<')
                     .replace(/&gt;/g, '>')
                     .replace(/&#39;/g, "'")
                     .replace(/&quot;/g, '"')
                     .replace(/&nbsp;/g, ' ')
                     .replace(/&apos;/g, "'");
                 
                 // Detect diagram type
                 const diagramType = detectDiagramType(fixedCode);
                 
                 // Handle unknown diagram types by converting to flowchart if possible
                 if (diagramType === 'unknown') {
                     console.warn('Unknown diagram type, attempting to render as-is');
                 }
                 
                 // Fix common syntax issues based on diagram type
                 switch (diagramType) {
                     case 'flowchart':
                         // Ensure flowchart has proper direction
                         if (!fixedCode.match(/(TD|TB|BT|RL|LR)/)) {
                             fixedCode = fixedCode.replace(/^(flowchart|graph)/, '$1 TD');
                         }
                         
                         // Fix specific pattern: node labels with <br> and file paths
                         // This pattern is causing the parser error: [Label<br>/path/file.xhtml]
                         fixedCode = fixedCode.replace(/\[([^\[\]]*)<br>([^\[\]]*)\]/g, (match, label, path) => {
                             // Clean the label and path, replace problematic characters
                             const cleanLabel = label.trim();
                             const cleanPath = path.trim()
                                 .replace(/\//g, '') // Replace forward slashes with math division symbol
                                 .replace(/\./g, ''); // Replace dots with middle dot
                             return `["${cleanLabel}\\n${cleanPath}"]`; // Use quoted strings for safety
                         });
                         
                         // Handle similar pattern in parentheses
                         fixedCode = fixedCode.replace(/\(([^\(\)]*)<br>([^\(\)]*)\)/g, (match, label, path) => {
                             const cleanLabel = label.trim();
                             const cleanPath = path.trim()
                                 .replace(/\//g, '')
                                 .replace(/\./g, '');
                             return `("${cleanLabel}\\n${cleanPath}")`;
                         });
                         
                         // Fix node labels with parentheses that can cause parsing issues
                         // Pattern: A[Label (with parentheses)] --> B
                         fixedCode = fixedCode.replace(/(\w+)\[([^\[\]]*\([^\[\]]*\)[^\[\]]*)\]/g, (match, nodeId, label) => {
                             // Wrap labels containing parentheses in quotes
                             const cleanLabel = label.replace(/"/g, '\\"'); // Escape existing quotes
                             return `${nodeId}["${cleanLabel}"]`;
                         });
                         
                         // Fix incomplete arrow syntax - ensure arrows have proper targets
                         // Pattern: A[Label] - (incomplete arrow at end of line)
                         fixedCode = fixedCode.replace(/(\w+\[[^\]]+\]|\w+\([^)]+\)|\w+)\s+--?\s*$/gm, (match, source) => {
                             // If we find an incomplete arrow at end of line, remove it entirely
                             console.warn('Removing incomplete arrow syntax:', match.trim());
                             return source.trim();
                         });
                         
                         // Fix common arrow syntax issues
                         fixedCode = fixedCode
                             .replace(/--&gt;/g, '-->')  // Fix any remaining HTML entities in arrows
                             .replace(/-->/g, ' --> ') // Ensure proper spacing around arrows
                             .replace(/\s+-->\s+/g, ' --> ') // Clean up multiple spaces
                             .replace(/\[\s+/g, '[') // Remove extra spaces after opening brackets
                             .replace(/\s+\]/g, ']') // Remove extra spaces before closing brackets
                             .replace(/\(\s+/g, '(') // Remove extra spaces after opening parentheses
                             .replace(/\s+\)/g, ')') // Remove extra spaces before closing parentheses
                             .replace(/\{\s+/g, '{') // Remove extra spaces after opening braces
                             .replace(/\s+\}/g, '}'); // Remove extra spaces before closing braces
                         
                         // Handle any remaining line breaks in node labels
                         fixedCode = fixedCode.replace(/<br>/gi, '\\n'); // Convert HTML breaks to Mermaid line breaks
                         
                         break;
                         
                     case 'mindmap':
                         // Ensure mindmap has proper structure
                         if (!fixedCode.includes('root(')) {
                             // If incomplete mindmap, add basic structure
                             const lines = fixedCode.split('\n');
                             if (lines.length > 1 && lines[0].trim() === 'mindmap') {
                                 // Wrap content in root node
                                 const content = lines.slice(1).join('\n').trim();
                                 if (content) {
                                     fixedCode = `mindmap\n  root((${content.split('\n')[0] || 'Root'}))\n${content}`;
                                 }
                             }
                         }
                         // Remove or fix invalid icon syntax for older versions
                         fixedCode = fixedCode.replace(/::icon\([^)]+\)/g, '');
                         break;
                         
                     case 'user-journey':
                         // Ensure journey diagram has proper structure
                         if (!fixedCode.includes('title')) {
                             const lines = fixedCode.split('\n');
                             if (lines.length > 1 && lines[0].trim() === 'journey') {
                                 lines.splice(1, 0, '    title User Journey');
                                 fixedCode = lines.join('\n');
                             }
                         }
                         break;
                         
                     case 'timeline':
                         // Timeline diagrams should have proper structure
                         if (!fixedCode.includes('title')) {
                             const lines = fixedCode.split('\n');
                             if (lines.length > 1 && lines[0].trim() === 'timeline') {
                                 lines.splice(1, 0, '  title Timeline');
                                 fixedCode = lines.join('\n');
                             }
                         }
                         break;
                 }
                 
                 // Final cleanup - remove any remaining problematic characters
                 fixedCode = fixedCode
                     .replace(/\r\n/g, '\n') // Normalize line endings
                     .replace(/\r/g, '\n')   // Convert old Mac line endings
                     .split('\n')
                     .map(line => line.trimRight()) // Remove trailing whitespace from each line
                     .join('\n')
                     .replace(/\n\s*\n\s*\n/g, '\n\n'); // Remove excessive blank lines
                 
                 return fixedCode;
             }
             
             // Function to re-render diagrams when theme changes
             function updateMermaidTheme() {
                 const isDarkMode = document.documentElement.classList.contains('dark-mode') || 
                                   document.documentElement.getAttribute('data-theme') === 'dark' ||
                                   window.matchMedia('(prefers-color-scheme: dark)').matches;
                 
                 try {
                     console.log(`Updating Mermaid theme to ${isDarkMode ? 'dark' : 'light'} mode`);
                     
                     // Step 1: Clear all existing rendered containers and reset processed state
                     const containers = document.querySelectorAll('.mermaid-container');
                     const preBlocks = document.querySelectorAll('pre.mermaid');
                     
                     containers.forEach(container => {
                         container.remove();
                     });
                     
                     preBlocks.forEach(preBlock => {
                         preBlock.classList.remove('mermaid-processed');
                         preBlock.style.display = 'block'; // Show original blocks temporarily
                     });
                     
                     // Step 2: Re-initialize Mermaid with new theme configuration
                     initializeMermaidRendering(); // Use the same initialization function as initial load
                     
                     // Step 3: Re-render all diagrams using the complete rendering process
                     setTimeout(() => {
                         renderMermaidDiagrams(); // Use the same rendering function as initial load
                         console.log(`Mermaid theme successfully updated to ${isDarkMode ? 'dark' : 'light'} mode`);
                     }, 100); // Small delay to ensure initialization is complete
                     
                 } catch (error) {
                     console.error('Error updating Mermaid theme:', error);
                 }
             }
         
             // --- RUN EVERYTHING ---
             // Add a small delay to ensure DOM is fully loaded
             setTimeout(() => {
                 init();
             }, 10);
         
         });
      </script>

   </body>
</html>
